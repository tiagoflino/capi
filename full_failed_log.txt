test	Check formatting	ï»¿2026-02-11T05:41:34.0678510Z ##[group]Run cargo fmt -- --check
test	Check formatting	2026-02-11T05:41:34.0678823Z [36;1mcargo fmt -- --check[0m
test	Check formatting	2026-02-11T05:41:34.0720724Z shell: /usr/bin/bash -e {0}
test	Check formatting	2026-02-11T05:41:34.0720960Z env:
test	Check formatting	2026-02-11T05:41:34.0721126Z   CARGO_TERM_COLOR: always
test	Check formatting	2026-02-11T05:41:34.0721352Z   CARGO_HOME: /home/runner/.cargo
test	Check formatting	2026-02-11T05:41:34.0721582Z   CARGO_INCREMENTAL: 0
test	Check formatting	2026-02-11T05:41:34.0721784Z   CACHE_ON_FAILURE: false
test	Check formatting	2026-02-11T05:41:34.0721974Z ##[endgroup]
test	Check formatting	2026-02-11T05:41:36.1360714Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:1:
test	Check formatting	2026-02-11T05:41:36.1369105Z -use clap::{Parser, Subcommand};
test	Check formatting	2026-02-11T05:41:36.1369621Z  use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.1370662Z +use clap::{Parser, Subcommand};
test	Check formatting	2026-02-11T05:41:36.1371490Z +use dialoguer::{theme::ColorfulTheme, Confirm, Select};
test	Check formatting	2026-02-11T05:41:36.1372098Z  use std::sync::Arc;
test	Check formatting	2026-02-11T05:41:36.1373210Z -use dialoguer::{Select, Confirm, theme::ColorfulTheme};
test	Check formatting	2026-02-11T05:41:36.1373838Z  
test	Check formatting	2026-02-11T05:41:36.1374668Z  #[derive(Parser)]
test	Check formatting	2026-02-11T05:41:36.1375412Z  #[command(name = "capi")]
test	Check formatting	2026-02-11T05:41:36.1376334Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:128:
test	Check formatting	2026-02-11T05:41:36.1376932Z                  } else {
test	Check formatting	2026-02-11T05:41:36.1377928Z                      let resources = capi_core::detect_system_resources().ok();
test	Check formatting	2026-02-11T05:41:36.1378630Z                      let devices = capi_core::detect_devices()?;
test	Check formatting	2026-02-11T05:41:36.1379518Z -                    let selected_device = capi_core::select_best_device(&devices, &config.device_preference);
test	Check formatting	2026-02-11T05:41:36.1380172Z +                    let selected_device =
test	Check formatting	2026-02-11T05:41:36.1381185Z +                        capi_core::select_best_device(&devices, &config.device_preference);
test	Check formatting	2026-02-11T05:41:36.1381826Z  
test	Check formatting	2026-02-11T05:41:36.1382713Z                      println!("Installed models ({}):\n", models.len());
test	Check formatting	2026-02-11T05:41:36.1383591Z                      for (idx, model) in models.iter().enumerate() {
test	Check formatting	2026-02-11T05:41:36.1384311Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:135:
test	Check formatting	2026-02-11T05:41:36.1385056Z                          let quant = model.quantization.as_deref().unwrap_or("-");
test	Check formatting	2026-02-11T05:41:36.1385655Z  
test	Check formatting	2026-02-11T05:41:36.1386488Z -                        let size_str = model.size_bytes
test	Check formatting	2026-02-11T05:41:36.1387029Z +                        let size_str = model
test	Check formatting	2026-02-11T05:41:36.1387749Z +                            .size_bytes
test	Check formatting	2026-02-11T05:41:36.1388538Z                              .map(|s| {
test	Check formatting	2026-02-11T05:41:36.1389351Z                                  if s > 1_000_000_000 {
test	Check formatting	2026-02-11T05:41:36.1390135Z                                      format!("{:.1}GB", s as f64 / 1_000_000_000.0)
test	Check formatting	2026-02-11T05:41:36.1391244Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:144:
test	Check formatting	2026-02-11T05:41:36.1391855Z                              })
test	Check formatting	2026-02-11T05:41:36.1392753Z                              .unwrap_or_else(|| "-".to_string());
test	Check formatting	2026-02-11T05:41:36.1393643Z  
test	Check formatting	2026-02-11T05:41:36.1394519Z -                        let mem_str = model.estimated_memory_bytes
test	Check formatting	2026-02-11T05:41:36.1395132Z +                        let mem_str = model
test	Check formatting	2026-02-11T05:41:36.1395881Z +                            .estimated_memory_bytes
test	Check formatting	2026-02-11T05:41:36.1396709Z                              .map(|m| format!("{:.1}GB", m as f64 / 1_000_000_000.0))
test	Check formatting	2026-02-11T05:41:36.1397360Z                              .unwrap_or_else(|| "?".to_string());
test	Check formatting	2026-02-11T05:41:36.1397843Z  
test	Check formatting	2026-02-11T05:41:36.1398486Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:151:
test	Check formatting	2026-02-11T05:41:36.1398988Z                          let fit_indicator = if let (Some(est_mem), Some(res), Some(dev)) =
test	Check formatting	2026-02-11T05:41:36.1399452Z -                            (model.estimated_memory_bytes, &resources, &selected_device) {
test	Check formatting	2026-02-11T05:41:36.1399910Z +                            (model.estimated_memory_bytes, &resources, &selected_device)
test	Check formatting	2026-02-11T05:41:36.1400395Z +                        {
test	Check formatting	2026-02-11T05:41:36.1400848Z                              let available = if dev.to_uppercase().contains("GPU") {
test	Check formatting	2026-02-11T05:41:36.1401873Z -                                res.gpu_resources.first().map(|g| g.available_vram_bytes).unwrap_or(0)
test	Check formatting	2026-02-11T05:41:36.1402589Z +                                res.gpu_resources
test	Check formatting	2026-02-11T05:41:36.1403571Z +                                    .first()
test	Check formatting	2026-02-11T05:41:36.1404479Z +                                    .map(|g| g.available_vram_bytes)
test	Check formatting	2026-02-11T05:41:36.1405084Z +                                    .unwrap_or(0)
test	Check formatting	2026-02-11T05:41:36.1405894Z                              } else {
test	Check formatting	2026-02-11T05:41:36.1406735Z                                  res.available_ram_bytes
test	Check formatting	2026-02-11T05:41:36.1407223Z                              };
test	Check formatting	2026-02-11T05:41:36.1407928Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:170:
test	Check formatting	2026-02-11T05:41:36.1408338Z                              " "
test	Check formatting	2026-02-11T05:41:36.1408555Z                          };
test	Check formatting	2026-02-11T05:41:36.1408734Z  
test	Check formatting	2026-02-11T05:41:36.1409098Z -                        let last_used = model.last_used
test	Check formatting	2026-02-11T05:41:36.1409577Z +                        let last_used = model
test	Check formatting	2026-02-11T05:41:36.1410017Z +                            .last_used
test	Check formatting	2026-02-11T05:41:36.1410944Z                              .map(|ts| format_timestamp(ts))
test	Check formatting	2026-02-11T05:41:36.1411637Z                              .unwrap_or_else(|| "never".to_string());
test	Check formatting	2026-02-11T05:41:36.1412204Z  
test	Check formatting	2026-02-11T05:41:36.1413240Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:177:
test	Check formatting	2026-02-11T05:41:36.1414032Z -                        println!("  [{:2}] {:<35} {:>6} {:>6} {:>7} {} {}",
test	Check formatting	2026-02-11T05:41:36.1414461Z +                        println!(
test	Check formatting	2026-02-11T05:41:36.1414716Z +                            "  [{:2}] {:<35} {:>6} {:>6} {:>7} {} {}",
test	Check formatting	2026-02-11T05:41:36.1414987Z                              idx + 1,
test	Check formatting	2026-02-11T05:41:36.1415208Z                              model.name,
test	Check formatting	2026-02-11T05:41:36.1415436Z                              quant,
test	Check formatting	2026-02-11T05:41:36.1415715Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:208:
test	Check formatting	2026-02-11T05:41:36.1416064Z                                  println!("  Context length: {}k", ctx / 1000);
test	Check formatting	2026-02-11T05:41:36.1416356Z                              }
test	Check formatting	2026-02-11T05:41:36.1416539Z  
test	Check formatting	2026-02-11T05:41:36.1416737Z -                            let gguf_files: Vec<_> = data.files.iter()
test	Check formatting	2026-02-11T05:41:36.1417044Z -                                .filter(|f| f.ends_with(".gguf"))
test	Check formatting	2026-02-11T05:41:36.1417316Z -                                .collect();
test	Check formatting	2026-02-11T05:41:36.1417769Z +                            let gguf_files: Vec<_> =
test	Check formatting	2026-02-11T05:41:36.1418359Z +                                data.files.iter().filter(|f| f.ends_with(".gguf")).collect();
test	Check formatting	2026-02-11T05:41:36.1419055Z  
test	Check formatting	2026-02-11T05:41:36.1420037Z                              println!("  GGUF files: {}", gguf_files.len());
test	Check formatting	2026-02-11T05:41:36.1420725Z                              for file in gguf_files.iter().take(5) {
test	Check formatting	2026-02-11T05:41:36.1421416Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:237:
test	Check formatting	2026-02-11T05:41:36.1422087Z                  println!("\nRegistering model...");
test	Check formatting	2026-02-11T05:41:36.1422618Z  
test	Check formatting	2026-02-11T05:41:36.1423806Z                  let model_file = detect_model_format(&model_path)?;
test	Check formatting	2026-02-11T05:41:36.1424785Z -                let display_name = name.unwrap_or_else(|| model.split('/').last().unwrap_or(&model).to_string());
test	Check formatting	2026-02-11T05:41:36.1425487Z +                let display_name =
test	Check formatting	2026-02-11T05:41:36.1426655Z +                    name.unwrap_or_else(|| model.split('/').last().unwrap_or(&model).to_string());
test	Check formatting	2026-02-11T05:41:36.1427314Z  
test	Check formatting	2026-02-11T05:41:36.1428448Z                  let file_size = std::fs::metadata(&model_file).ok().map(|m| m.len() as i64);
test	Check formatting	2026-02-11T05:41:36.1429292Z                  let estimated_memory = file_size.map(|s| (s as f64 * 1.5) as i64);
test	Check formatting	2026-02-11T05:41:36.1430084Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:275:
test	Check formatting	2026-02-11T05:41:36.1430801Z                  let model_path = config.models_dir.join(&model);
test	Check formatting	2026-02-11T05:41:36.1431318Z  
test	Check formatting	2026-02-11T05:41:36.1432253Z                  if !model_path.exists() {
test	Check formatting	2026-02-11T05:41:36.1433570Z -                    return Err(anyhow::anyhow!("Model path not found: {}", model_path.display()));
test	Check formatting	2026-02-11T05:41:36.1434333Z +                    return Err(anyhow::anyhow!(
test	Check formatting	2026-02-11T05:41:36.1435059Z +                        "Model path not found: {}",
test	Check formatting	2026-02-11T05:41:36.1435773Z +                        model_path.display()
test	Check formatting	2026-02-11T05:41:36.1436556Z +                    ));
test	Check formatting	2026-02-11T05:41:36.1437436Z                  }
test	Check formatting	2026-02-11T05:41:36.1438233Z  
test	Check formatting	2026-02-11T05:41:36.1439252Z                  let model_file = detect_model_format(&model_path)?;
test	Check formatting	2026-02-11T05:41:36.1440026Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:334:
test	Check formatting	2026-02-11T05:41:36.1440701Z                              model.downloads.to_string()
test	Check formatting	2026-02-11T05:41:36.1441492Z                          };
test	Check formatting	2026-02-11T05:41:36.1442184Z  
test	Check formatting	2026-02-11T05:41:36.1443594Z -                        println!("  [{:2}] {:<47} â†“{:>6}",
test	Check formatting	2026-02-11T05:41:36.1444163Z -                            idx + 1,
test	Check formatting	2026-02-11T05:41:36.1445222Z -                            model.id,
test	Check formatting	2026-02-11T05:41:36.1446069Z -                            downloads_str
test	Check formatting	2026-02-11T05:41:36.1446885Z -                        );
test	Check formatting	2026-02-11T05:41:36.1447938Z +                        println!("  [{:2}] {:<47} â†“{:>6}", idx + 1, model.id, downloads_str);
test	Check formatting	2026-02-11T05:41:36.1448539Z                      }
test	Check formatting	2026-02-11T05:41:36.1450075Z -                    println!("\nâ†“ = Downloads  |  Use 'capi model info <id>' for size/arch/context");
test	Check formatting	2026-02-11T05:41:36.1450688Z +                    println!(
test	Check formatting	2026-02-11T05:41:36.1452048Z +                        "\nâ†“ = Downloads  |  Use 'capi model info <id>' for size/arch/context"
test	Check formatting	2026-02-11T05:41:36.1452661Z +                    );
test	Check formatting	2026-02-11T05:41:36.1453914Z                      println!("Use 'capi model download <id>' to download & register");
test	Check formatting	2026-02-11T05:41:36.1454566Z                  }
test	Check formatting	2026-02-11T05:41:36.1455444Z              }
test	Check formatting	2026-02-11T05:41:36.1456458Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:347:
test	Check formatting	2026-02-11T05:41:36.1457069Z          },
test	Check formatting	2026-02-11T05:41:36.1457999Z          Commands::Run { model } => {
test	Check formatting	2026-02-11T05:41:36.1458857Z -            use std::io::{self, Write};
test	Check formatting	2026-02-11T05:41:36.1459541Z              use crossterm::{
test	Check formatting	2026-02-11T05:41:36.1460529Z                  event::{self, Event, KeyCode, KeyEventKind},
test	Check formatting	2026-02-11T05:41:36.1461148Z -                terminal::{enable_raw_mode, disable_raw_mode},
test	Check formatting	2026-02-11T05:41:36.1461941Z +                terminal::{disable_raw_mode, enable_raw_mode},
test	Check formatting	2026-02-11T05:41:36.1462626Z              };
test	Check formatting	2026-02-11T05:41:36.1463434Z +            use std::io::{self, Write};
test	Check formatting	2026-02-11T05:41:36.1464180Z  
test	Check formatting	2026-02-11T05:41:36.1465159Z              let config = capi_core::Config::load()?;
test	Check formatting	2026-02-11T05:41:36.1465789Z              let db = Arc::new(capi_core::Database::open(config.database_path())?);
test	Check formatting	2026-02-11T05:41:36.1466684Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:357:
test	Check formatting	2026-02-11T05:41:36.1467171Z              let registry = capi_core::Registry::new(db);
test	Check formatting	2026-02-11T05:41:36.1467425Z  
test	Check formatting	2026-02-11T05:41:36.1467621Z -            let model_record = registry.get_model(&model)?
test	Check formatting	2026-02-11T05:41:36.1467901Z +            let model_record = registry
test	Check formatting	2026-02-11T05:41:36.1468138Z +                .get_model(&model)?
test	Check formatting	2026-02-11T05:41:36.1468354Z                  .or_else(|| {
test	Check formatting	2026-02-11T05:41:36.1468573Z -                    registry.list_models()
test	Check formatting	2026-02-11T05:41:36.1468802Z -                        .ok()
test	Check formatting	2026-02-11T05:41:36.1469197Z -                        .and_then(|models| {
test	Check formatting	2026-02-11T05:41:36.1470265Z -                            models.into_iter()
test	Check formatting	2026-02-11T05:41:36.1470974Z -                                .find(|m| m.name.contains(&model) || m.id.contains(&model))
test	Check formatting	2026-02-11T05:41:36.1471622Z -                        })
test	Check formatting	2026-02-11T05:41:36.1472566Z +                    registry.list_models().ok().and_then(|models| {
test	Check formatting	2026-02-11T05:41:36.1473348Z +                        models
test	Check formatting	2026-02-11T05:41:36.1474071Z +                            .into_iter()
test	Check formatting	2026-02-11T05:41:36.1474997Z +                            .find(|m| m.name.contains(&model) || m.id.contains(&model))
test	Check formatting	2026-02-11T05:41:36.1475637Z +                    })
test	Check formatting	2026-02-11T05:41:36.1476494Z                  })
test	Check formatting	2026-02-11T05:41:36.1477529Z                  .ok_or_else(|| anyhow::anyhow!("Model not found: {}", model))?;
test	Check formatting	2026-02-11T05:41:36.1478169Z  
test	Check formatting	2026-02-11T05:41:36.1479119Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:373:
test	Check formatting	2026-02-11T05:41:36.1479882Z              let model_path = std::path::Path::new(&model_record.path);
test	Check formatting	2026-02-11T05:41:36.1480490Z  
test	Check formatting	2026-02-11T05:41:36.1481346Z              if !model_path.exists() {
test	Check formatting	2026-02-11T05:41:36.1482380Z -                return Err(anyhow::anyhow!("Model file not found at: {}", model_record.path));
test	Check formatting	2026-02-11T05:41:36.1483357Z +                return Err(anyhow::anyhow!(
test	Check formatting	2026-02-11T05:41:36.1484073Z +                    "Model file not found at: {}",
test	Check formatting	2026-02-11T05:41:36.1484535Z +                    model_record.path
test	Check formatting	2026-02-11T05:41:36.1484807Z +                ));
test	Check formatting	2026-02-11T05:41:36.1484982Z              }
test	Check formatting	2026-02-11T05:41:36.1485131Z  
test	Check formatting	2026-02-11T05:41:36.1485331Z              let devices = capi_core::detect_devices()?;
test	Check formatting	2026-02-11T05:41:36.1485675Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:388:
test	Check formatting	2026-02-11T05:41:36.1486121Z              println!("Ready! Type your message (or /exit to quit, ESC to stop generation)\n");
test	Check formatting	2026-02-11T05:41:36.1486491Z  
test	Check formatting	2026-02-11T05:41:36.1486827Z              enable_raw_mode()?;
test	Check formatting	2026-02-11T05:41:36.1487860Z -            use std::sync::{Arc as StdArc, atomic::{AtomicBool, Ordering}};
test	Check formatting	2026-02-11T05:41:36.1488525Z +            use std::sync::{
test	Check formatting	2026-02-11T05:41:36.1489534Z +                atomic::{AtomicBool, Ordering},
test	Check formatting	2026-02-11T05:41:36.1490325Z +                Arc as StdArc,
test	Check formatting	2026-02-11T05:41:36.1491275Z +            };
test	Check formatting	2026-02-11T05:41:36.1492274Z              let should_stop = StdArc::new(AtomicBool::new(false));
test	Check formatting	2026-02-11T05:41:36.1493023Z  
test	Check formatting	2026-02-11T05:41:36.1493828Z              let result = (|| -> Result<()> {
test	Check formatting	2026-02-11T05:41:36.1494680Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:411:
test	Check formatting	2026-02-11T05:41:36.1495345Z                                          print!("\r\n");
test	Check formatting	2026-02-11T05:41:36.1496143Z                                          io::stdout().flush()?;
test	Check formatting	2026-02-11T05:41:36.1496682Z                                          break;
test	Check formatting	2026-02-11T05:41:36.1497346Z -                                    },
test	Check formatting	2026-02-11T05:41:36.1497737Z +                                    }
test	Check formatting	2026-02-11T05:41:36.1498023Z                                      KeyCode::Char(c) => {
test	Check formatting	2026-02-11T05:41:36.1498497Z                                          input_buffer.push(c);
test	Check formatting	2026-02-11T05:41:36.1498785Z                                          print!("{}", c);
test	Check formatting	2026-02-11T05:41:36.1499109Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:418:
test	Check formatting	2026-02-11T05:41:36.1499436Z                                          io::stdout().flush()?;
test	Check formatting	2026-02-11T05:41:36.1499902Z -                                    },
test	Check formatting	2026-02-11T05:41:36.1500273Z +                                    }
test	Check formatting	2026-02-11T05:41:36.1500914Z                                      KeyCode::Backspace if !input_buffer.is_empty() => {
test	Check formatting	2026-02-11T05:41:36.1501632Z                                          input_buffer.pop();
test	Check formatting	2026-02-11T05:41:36.1502298Z                                          print!("\x08 \x08");
test	Check formatting	2026-02-11T05:41:36.1503138Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:423:
test	Check formatting	2026-02-11T05:41:36.1503833Z                                          io::stdout().flush()?;
test	Check formatting	2026-02-11T05:41:36.1504358Z -                                    },
test	Check formatting	2026-02-11T05:41:36.1505120Z +                                    }
test	Check formatting	2026-02-11T05:41:36.1506054Z                                      _ => {}
test	Check formatting	2026-02-11T05:41:36.1506842Z                                  }
test	Check formatting	2026-02-11T05:41:36.1507736Z                              }
test	Check formatting	2026-02-11T05:41:36.1508746Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:430:
test	Check formatting	2026-02-11T05:41:36.1509542Z  
test	Check formatting	2026-02-11T05:41:36.1510523Z                      let input = input_buffer.trim();
test	Check formatting	2026-02-11T05:41:36.1511071Z  
test	Check formatting	2026-02-11T05:41:36.1511985Z -                if input == "/exit" || input == "/quit" {
test	Check formatting	2026-02-11T05:41:36.1512575Z -                    print!("Goodbye!\r\n");
test	Check formatting	2026-02-11T05:41:36.1513607Z -                    io::stdout().flush()?;
test	Check formatting	2026-02-11T05:41:36.1514343Z -                    session.finish_chat()?;
test	Check formatting	2026-02-11T05:41:36.1515057Z -                    break;
test	Check formatting	2026-02-11T05:41:36.1515984Z -                }
test	Check formatting	2026-02-11T05:41:36.1516845Z +                    if input == "/exit" || input == "/quit" {
test	Check formatting	2026-02-11T05:41:36.1517444Z +                        print!("Goodbye!\r\n");
test	Check formatting	2026-02-11T05:41:36.1518233Z +                        io::stdout().flush()?;
test	Check formatting	2026-02-11T05:41:36.1518785Z +                        session.finish_chat()?;
test	Check formatting	2026-02-11T05:41:36.1519605Z +                        break;
test	Check formatting	2026-02-11T05:41:36.1520582Z +                    }
test	Check formatting	2026-02-11T05:41:36.1521428Z  
test	Check formatting	2026-02-11T05:41:36.1522307Z -                if input.is_empty() {
test	Check formatting	2026-02-11T05:41:36.1523273Z -                    continue;
test	Check formatting	2026-02-11T05:41:36.1524157Z -                }
test	Check formatting	2026-02-11T05:41:36.1524946Z +                    if input.is_empty() {
test	Check formatting	2026-02-11T05:41:36.1525699Z +                        continue;
test	Check formatting	2026-02-11T05:41:36.1526641Z +                    }
test	Check formatting	2026-02-11T05:41:36.1527428Z  
test	Check formatting	2026-02-11T05:41:36.1528393Z -                should_stop.store(false, Ordering::Relaxed);
test	Check formatting	2026-02-11T05:41:36.1529086Z -                let stop_clone = StdArc::clone(&should_stop);
test	Check formatting	2026-02-11T05:41:36.1529718Z -                let stop_clone_thread = StdArc::clone(&should_stop);
test	Check formatting	2026-02-11T05:41:36.1530439Z +                    should_stop.store(false, Ordering::Relaxed);
test	Check formatting	2026-02-11T05:41:36.1531054Z +                    let stop_clone = StdArc::clone(&should_stop);
test	Check formatting	2026-02-11T05:41:36.1531743Z +                    let stop_clone_thread = StdArc::clone(&should_stop);
test	Check formatting	2026-02-11T05:41:36.1532349Z  
test	Check formatting	2026-02-11T05:41:36.1533433Z -                // ESC detection thread
test	Check formatting	2026-02-11T05:41:36.1534256Z -                let esc_handle = std::thread::spawn(move || {
test	Check formatting	2026-02-11T05:41:36.1534826Z -                    loop {
test	Check formatting	2026-02-11T05:41:36.1535668Z +                    // ESC detection thread
test	Check formatting	2026-02-11T05:41:36.1536508Z +                    let esc_handle = std::thread::spawn(move || loop {
test	Check formatting	2026-02-11T05:41:36.1537395Z                          if event::poll(std::time::Duration::from_millis(50)).unwrap_or(false) {
test	Check formatting	2026-02-11T05:41:36.1538130Z                              if let Ok(Event::Key(key)) = event::read() {
test	Check formatting	2026-02-11T05:41:36.1539121Z                                  if key.code == KeyCode::Esc && key.kind == KeyEventKind::Press {
test	Check formatting	2026-02-11T05:41:36.1539904Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:462:
test	Check formatting	2026-02-11T05:41:36.1540634Z                          if stop_clone_thread.load(Ordering::Relaxed) {
test	Check formatting	2026-02-11T05:41:36.1541250Z                              break;
test	Check formatting	2026-02-11T05:41:36.1542132Z                          }
test	Check formatting	2026-02-11T05:41:36.1543232Z -                    }
test	Check formatting	2026-02-11T05:41:36.1544039Z -                });
test	Check formatting	2026-02-11T05:41:36.1544846Z +                    });
test	Check formatting	2026-02-11T05:41:36.1545783Z  
test	Check formatting	2026-02-11T05:41:36.1546677Z -                let mut is_first_token = true;
test	Check formatting	2026-02-11T05:41:36.1547497Z +                    let mut is_first_token = true;
test	Check formatting	2026-02-11T05:41:36.1548236Z  
test	Check formatting	2026-02-11T05:41:36.1549337Z -                    let (_output, metrics) = session.generate_stream(input, 4096, move |token| {
test	Check formatting	2026-02-11T05:41:36.1550056Z -                    // Check stop flag first
test	Check formatting	2026-02-11T05:41:36.1550895Z -                    if stop_clone.load(Ordering::Relaxed) {
test	Check formatting	2026-02-11T05:41:36.1551508Z -                        print!("\r\n\r\n[Generation stopped]\r\n");
test	Check formatting	2026-02-11T05:41:36.1552060Z -                        use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.1552953Z -                        std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.1553731Z -                        return false;
test	Check formatting	2026-02-11T05:41:36.1554542Z -                    }
test	Check formatting	2026-02-11T05:41:36.1555315Z +                    let (_output, metrics) =
test	Check formatting	2026-02-11T05:41:36.1556129Z +                        session.generate_stream(input, 4096, move |token| {
test	Check formatting	2026-02-11T05:41:36.1556780Z +                            // Check stop flag first
test	Check formatting	2026-02-11T05:41:36.1557559Z +                            if stop_clone.load(Ordering::Relaxed) {
test	Check formatting	2026-02-11T05:41:36.1558226Z +                                print!("\r\n\r\n[Generation stopped]\r\n");
test	Check formatting	2026-02-11T05:41:36.1558861Z +                                use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.1559392Z +                                std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.1559943Z +                                return false;
test	Check formatting	2026-02-11T05:41:36.1560607Z +                            }
test	Check formatting	2026-02-11T05:41:36.1561444Z  
test	Check formatting	2026-02-11T05:41:36.1562340Z -                    // Trim leading whitespace only on first token
test	Check formatting	2026-02-11T05:41:36.1563151Z -                    let display_token = if is_first_token {
test	Check formatting	2026-02-11T05:41:36.1563728Z -                        is_first_token = false;
test	Check formatting	2026-02-11T05:41:36.1564532Z -                        token.trim_start()
test	Check formatting	2026-02-11T05:41:36.1565337Z -                    } else {
test	Check formatting	2026-02-11T05:41:36.1566161Z -                        token
test	Check formatting	2026-02-11T05:41:36.1566927Z -                    };
test	Check formatting	2026-02-11T05:41:36.1567841Z +                            // Trim leading whitespace only on first token
test	Check formatting	2026-02-11T05:41:36.1568552Z +                            let display_token = if is_first_token {
test	Check formatting	2026-02-11T05:41:36.1569152Z +                                is_first_token = false;
test	Check formatting	2026-02-11T05:41:36.1569978Z +                                token.trim_start()
test	Check formatting	2026-02-11T05:41:36.1570777Z +                            } else {
test	Check formatting	2026-02-11T05:41:36.1571599Z +                                token
test	Check formatting	2026-02-11T05:41:36.1572469Z +                            };
test	Check formatting	2026-02-11T05:41:36.1573602Z  
test	Check formatting	2026-02-11T05:41:36.1574625Z -                    // In raw mode, replace \n with \r\n for proper line breaks
test	Check formatting	2026-02-11T05:41:36.1575428Z -                    let display_token = display_token.replace("\n", "\r\n");
test	Check formatting	2026-02-11T05:41:36.1576222Z +                            // In raw mode, replace \n with \r\n for proper line breaks
test	Check formatting	2026-02-11T05:41:36.1577038Z +                            let display_token = display_token.replace("\n", "\r\n");
test	Check formatting	2026-02-11T05:41:36.1577668Z  
test	Check formatting	2026-02-11T05:41:36.1578602Z -                    print!("{}", display_token);
test	Check formatting	2026-02-11T05:41:36.1579412Z -                    use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.1580271Z -                    std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.1581054Z -                    true
test	Check formatting	2026-02-11T05:41:36.1581883Z -                })?;
test	Check formatting	2026-02-11T05:41:36.1582624Z +                            print!("{}", display_token);
test	Check formatting	2026-02-11T05:41:36.1583427Z +                            use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.1584147Z +                            std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.1584739Z +                            true
test	Check formatting	2026-02-11T05:41:36.1585710Z +                        })?;
test	Check formatting	2026-02-11T05:41:36.1586555Z  
test	Check formatting	2026-02-11T05:41:36.1587534Z -                should_stop.store(true, Ordering::Relaxed);
test	Check formatting	2026-02-11T05:41:36.1588153Z -                esc_handle.join().ok();
test	Check formatting	2026-02-11T05:41:36.1589073Z +                    should_stop.store(true, Ordering::Relaxed);
test	Check formatting	2026-02-11T05:41:36.1589618Z +                    esc_handle.join().ok();
test	Check formatting	2026-02-11T05:41:36.1590305Z  
test	Check formatting	2026-02-11T05:41:36.1591511Z -                print!("\r\n({:.1} tok/s, {} tokens)\r\n\r\n", metrics.tokens_per_second, metrics.num_output_tokens);
test	Check formatting	2026-02-11T05:41:36.1592250Z -                io::stdout().flush()?;
test	Check formatting	2026-02-11T05:41:36.1593257Z +                    print!(
test	Check formatting	2026-02-11T05:41:36.1594188Z +                        "\r\n({:.1} tok/s, {} tokens)\r\n\r\n",
test	Check formatting	2026-02-11T05:41:36.1595132Z +                        metrics.tokens_per_second, metrics.num_output_tokens
test	Check formatting	2026-02-11T05:41:36.1595776Z +                    );
test	Check formatting	2026-02-11T05:41:36.1596529Z +                    io::stdout().flush()?;
test	Check formatting	2026-02-11T05:41:36.1597275Z                  }
test	Check formatting	2026-02-11T05:41:36.1598137Z  
test	Check formatting	2026-02-11T05:41:36.1598965Z                  Ok(())
test	Check formatting	2026-02-11T05:41:36.1599894Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:535:
test	Check formatting	2026-02-11T05:41:36.1601116Z              let db = Arc::new(capi_core::Database::open(config.database_path())?);
test	Check formatting	2026-02-11T05:41:36.1601880Z              let registry = capi_core::Registry::new(db);
test	Check formatting	2026-02-11T05:41:36.1602436Z  
test	Check formatting	2026-02-11T05:41:36.1603354Z -            let model_record = registry.get_model(&model)?
test	Check formatting	2026-02-11T05:41:36.1603988Z +            let model_record = registry
test	Check formatting	2026-02-11T05:41:36.1604846Z +                .get_model(&model)?
test	Check formatting	2026-02-11T05:41:36.1605589Z                  .or_else(|| {
test	Check formatting	2026-02-11T05:41:36.1606430Z -                    registry.list_models()
test	Check formatting	2026-02-11T05:41:36.1607199Z -                        .ok()
test	Check formatting	2026-02-11T05:41:36.1608052Z -                        .and_then(|models| {
test	Check formatting	2026-02-11T05:41:36.1609101Z -                            models.into_iter()
test	Check formatting	2026-02-11T05:41:36.1610020Z -                                .find(|m| m.name.contains(&model) || m.id.contains(&model))
test	Check formatting	2026-02-11T05:41:36.1610762Z -                        })
test	Check formatting	2026-02-11T05:41:36.1611837Z +                    registry.list_models().ok().and_then(|models| {
test	Check formatting	2026-02-11T05:41:36.1612400Z +                        models
test	Check formatting	2026-02-11T05:41:36.1612965Z +                            .into_iter()
test	Check formatting	2026-02-11T05:41:36.1613577Z +                            .find(|m| m.name.contains(&model) || m.id.contains(&model))
test	Check formatting	2026-02-11T05:41:36.1614236Z +                    })
test	Check formatting	2026-02-11T05:41:36.1615056Z                  })
test	Check formatting	2026-02-11T05:41:36.1616033Z                  .ok_or_else(|| anyhow::anyhow!("Model not found: {}", model))?;
test	Check formatting	2026-02-11T05:41:36.1616666Z  
test	Check formatting	2026-02-11T05:41:36.1617668Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:599:
test	Check formatting	2026-02-11T05:41:36.1618322Z                  return Ok(());
test	Check formatting	2026-02-11T05:41:36.1619272Z              }
test	Check formatting	2026-02-11T05:41:36.1620104Z  
test	Check formatting	2026-02-11T05:41:36.1621031Z -            let items: Vec<String> = models.iter()
test	Check formatting	2026-02-11T05:41:36.1621567Z +            let items: Vec<String> = models
test	Check formatting	2026-02-11T05:41:36.1622277Z +                .iter()
test	Check formatting	2026-02-11T05:41:36.1623251Z                  .map(|m| {
test	Check formatting	2026-02-11T05:41:36.1624304Z                      let downloads_str = if m.downloads >= 1_000_000 {
test	Check formatting	2026-02-11T05:41:36.1625039Z                          format!("{:.1}M", m.downloads as f64 / 1_000_000.0)
test	Check formatting	2026-02-11T05:41:36.1625743Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:628:
test	Check formatting	2026-02-11T05:41:36.1626312Z              } else {
test	Check formatting	2026-02-11T05:41:36.1627036Z                  println!("Found {} quantized version(s):\n", quantized.len());
test	Check formatting	2026-02-11T05:41:36.1627662Z  
test	Check formatting	2026-02-11T05:41:36.1628670Z -                let quant_items: Vec<String> = quantized.iter()
test	Check formatting	2026-02-11T05:41:36.1629361Z +                let quant_items: Vec<String> = quantized
test	Check formatting	2026-02-11T05:41:36.1629974Z +                    .iter()
test	Check formatting	2026-02-11T05:41:36.1630830Z                      .map(|m| {
test	Check formatting	2026-02-11T05:41:36.1631811Z                          let downloads_str = if m.downloads >= 1_000_000 {
test	Check formatting	2026-02-11T05:41:36.1632545Z                              format!("{:.1}M", m.downloads as f64 / 1_000_000.0)
test	Check formatting	2026-02-11T05:41:36.1633437Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:670:
test	Check formatting	2026-02-11T05:41:36.1634117Z                  println!("Context: {}k", ctx / 1000);
test	Check formatting	2026-02-11T05:41:36.1634690Z              }
test	Check formatting	2026-02-11T05:41:36.1635536Z  
test	Check formatting	2026-02-11T05:41:36.1636671Z -            let gguf_files: Vec<&capi_core::FileInfo> = model_data.files_with_size.iter()
test	Check formatting	2026-02-11T05:41:36.1637522Z +            let gguf_files: Vec<&capi_core::FileInfo> = model_data
test	Check formatting	2026-02-11T05:41:36.1638178Z +                .files_with_size
test	Check formatting	2026-02-11T05:41:36.1639138Z +                .iter()
test	Check formatting	2026-02-11T05:41:36.1640106Z                  .filter(|f| f.name.ends_with(".gguf"))
test	Check formatting	2026-02-11T05:41:36.1640687Z                  .collect();
test	Check formatting	2026-02-11T05:41:36.1641363Z  
test	Check formatting	2026-02-11T05:41:36.1642392Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:682:
test	Check formatting	2026-02-11T05:41:36.1643201Z  
test	Check formatting	2026-02-11T05:41:36.1644185Z              println!("\nAvailable quantizations:");
test	Check formatting	2026-02-11T05:41:36.1644832Z  
test	Check formatting	2026-02-11T05:41:36.1645819Z -            let quant_items: Vec<String> = gguf_files.iter()
test	Check formatting	2026-02-11T05:41:36.1646407Z +            let quant_items: Vec<String> = gguf_files
test	Check formatting	2026-02-11T05:41:36.1646972Z +                .iter()
test	Check formatting	2026-02-11T05:41:36.1647912Z                  .map(|f| {
test	Check formatting	2026-02-11T05:41:36.1648847Z                      let size_str = if let Some(size) = f.size {
test	Check formatting	2026-02-11T05:41:36.1649411Z                          if size > 1_000_000_000 {
test	Check formatting	2026-02-11T05:41:36.1650256Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:711:
test	Check formatting	2026-02-11T05:41:36.1650864Z  
test	Check formatting	2026-02-11T05:41:36.1651915Z              if !Confirm::with_theme(&ColorfulTheme::default())
test	Check formatting	2026-02-11T05:41:36.1652615Z                  .with_prompt(format!("Download {}?", selected_file))
test	Check formatting	2026-02-11T05:41:36.1653398Z -                .interact()? {
test	Check formatting	2026-02-11T05:41:36.1654235Z +                .interact()?
test	Check formatting	2026-02-11T05:41:36.1655065Z +            {
test	Check formatting	2026-02-11T05:41:36.1655974Z                  println!("Cancelled");
test	Check formatting	2026-02-11T05:41:36.1656752Z                  return Ok(());
test	Check formatting	2026-02-11T05:41:36.1657624Z              }
test	Check formatting	2026-02-11T05:41:36.1658616Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:724:
test	Check formatting	2026-02-11T05:41:36.1659226Z  
test	Check formatting	2026-02-11T05:41:36.1660196Z              println!("\nDownloading {}...", selected_file);
test	Check formatting	2026-02-11T05:41:36.1660708Z  
test	Check formatting	2026-02-11T05:41:36.1661927Z -            let url = format!("https://huggingface.co/{}/resolve/main/{}", model_to_use.id, selected_file);
test	Check formatting	2026-02-11T05:41:36.1662631Z +            let url = format!(
test	Check formatting	2026-02-11T05:41:36.1677307Z +                "https://huggingface.co/{}/resolve/main/{}",
test	Check formatting	2026-02-11T05:41:36.1678208Z +                model_to_use.id, selected_file
test	Check formatting	2026-02-11T05:41:36.1678596Z +            );
test	Check formatting	2026-02-11T05:41:36.1678782Z  
test	Check formatting	2026-02-11T05:41:36.1679148Z -            downloader.download_file_with_progress(&url, &model_path.join(selected_file), |current, total| {
test	Check formatting	2026-02-11T05:41:36.1679615Z -                if total > 0 {
test	Check formatting	2026-02-11T05:41:36.1679908Z -                    let pct = (current as f64 / total as f64 * 100.0) as u32;
test	Check formatting	2026-02-11T05:41:36.1680265Z -                    let mb_current = current as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.1680575Z -                    let mb_total = total as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.1680834Z +            downloader
test	Check formatting	2026-02-11T05:41:36.1681055Z +                .download_file_with_progress(
test	Check formatting	2026-02-11T05:41:36.1681483Z +                    &url,
test	Check formatting	2026-02-11T05:41:36.1681709Z +                    &model_path.join(selected_file),
test	Check formatting	2026-02-11T05:41:36.1681966Z +                    |current, total| {
test	Check formatting	2026-02-11T05:41:36.1682192Z +                        if total > 0 {
test	Check formatting	2026-02-11T05:41:36.1682751Z +                            let pct = (current as f64 / total as f64 * 100.0) as u32;
test	Check formatting	2026-02-11T05:41:36.1683640Z +                            let mb_current = current as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.1684259Z +                            let mb_total = total as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.1684761Z  
test	Check formatting	2026-02-11T05:41:36.1685662Z -                    let bar_width = 40;
test	Check formatting	2026-02-11T05:41:36.1686488Z -                    let filled = (bar_width * pct as usize) / 100;
test	Check formatting	2026-02-11T05:41:36.1687130Z -                    let empty = bar_width - filled;
test	Check formatting	2026-02-11T05:41:36.1687861Z -                    let bar = format!("[{}{}]", "=".repeat(filled), " ".repeat(empty));
test	Check formatting	2026-02-11T05:41:36.1688481Z +                            let bar_width = 40;
test	Check formatting	2026-02-11T05:41:36.1689027Z +                            let filled = (bar_width * pct as usize) / 100;
test	Check formatting	2026-02-11T05:41:36.1689781Z +                            let empty = bar_width - filled;
test	Check formatting	2026-02-11T05:41:36.1690305Z +                            let bar = format!("[{}{}]", "=".repeat(filled), " ".repeat(empty));
test	Check formatting	2026-02-11T05:41:36.1690827Z  
test	Check formatting	2026-02-11T05:41:36.1691076Z -                    print!("\r  {} {:.1}/{:.1} MB ({}%)  ", bar, mb_current, mb_total, pct);
test	Check formatting	2026-02-11T05:41:36.1691636Z -                    use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.1692629Z -                    std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.1693389Z -                }
test	Check formatting	2026-02-11T05:41:36.1694245Z -            }).await?;
test	Check formatting	2026-02-11T05:41:36.1695047Z +                            print!(
test	Check formatting	2026-02-11T05:41:36.1695903Z +                                "\r  {} {:.1}/{:.1} MB ({}%)  ",
test	Check formatting	2026-02-11T05:41:36.1696436Z +                                bar, mb_current, mb_total, pct
test	Check formatting	2026-02-11T05:41:36.1697173Z +                            );
test	Check formatting	2026-02-11T05:41:36.1697585Z +                            use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.1697883Z +                            std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.1698145Z +                        }
test	Check formatting	2026-02-11T05:41:36.1698326Z +                    },
test	Check formatting	2026-02-11T05:41:36.1698500Z +                )
test	Check formatting	2026-02-11T05:41:36.1698668Z +                .await?;
test	Check formatting	2026-02-11T05:41:36.1698852Z  
test	Check formatting	2026-02-11T05:41:36.1699359Z              println!("\nâœ“ Downloaded");
test	Check formatting	2026-02-11T05:41:36.1699852Z  
test	Check formatting	2026-02-11T05:41:36.1700833Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:760:
test	Check formatting	2026-02-11T05:41:36.1701419Z  
test	Check formatting	2026-02-11T05:41:36.1702354Z              let model_record = capi_core::db::ModelRecord {
test	Check formatting	2026-02-11T05:41:36.1703062Z                  id: safe_name.clone(),
test	Check formatting	2026-02-11T05:41:36.1704061Z -                name: model_to_use.id.split('/').last().unwrap_or(&model_to_use.id).to_string(),
test	Check formatting	2026-02-11T05:41:36.1704722Z +                name: model_to_use
test	Check formatting	2026-02-11T05:41:36.1705527Z +                    .id
test	Check formatting	2026-02-11T05:41:36.1706273Z +                    .split('/')
test	Check formatting	2026-02-11T05:41:36.1707148Z +                    .last()
test	Check formatting	2026-02-11T05:41:36.1708002Z +                    .unwrap_or(&model_to_use.id)
test	Check formatting	2026-02-11T05:41:36.1708679Z +                    .to_string(),
test	Check formatting	2026-02-11T05:41:36.1709792Z                  path: model_file.to_string_lossy().to_string(),
test	Check formatting	2026-02-11T05:41:36.1710440Z                  size_bytes: file_size,
test	Check formatting	2026-02-11T05:41:36.1711340Z                  quantization: Some(selected_file.to_string()),
test	Check formatting	2026-02-11T05:41:36.1712119Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:787:
test	Check formatting	2026-02-11T05:41:36.1713094Z                      println!("  Data directory: {}", config.data_dir.display());
test	Check formatting	2026-02-11T05:41:36.1713919Z                      println!("  Device preference: {:?}", config.device_preference);
test	Check formatting	2026-02-11T05:41:36.1714713Z                      println!("  Resource mode: {:?}", config.resource_mode);
test	Check formatting	2026-02-11T05:41:36.1715843Z -                    println!("  Default context length: {}K", config.default_context_length / 1024);
test	Check formatting	2026-02-11T05:41:36.1717690Z +                    println!(
test	Check formatting	2026-02-11T05:41:36.1718731Z +                        "  Default context length: {}K",
test	Check formatting	2026-02-11T05:41:36.1719263Z +                        config.default_context_length / 1024
test	Check formatting	2026-02-11T05:41:36.1719665Z +                    );
test	Check formatting	2026-02-11T05:41:36.1719908Z                      println!("  Auto start: {}", config.auto_start);
test	Check formatting	2026-02-11T05:41:36.1720512Z                      println!("  Keep server running: {}", config.keep_server_running);
test	Check formatting	2026-02-11T05:41:36.1721612Z                  }
test	Check formatting	2026-02-11T05:41:36.1722385Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:798:
test	Check formatting	2026-02-11T05:41:36.1723341Z                          "loose" => capi_core::ResourceMode::Loose,
test	Check formatting	2026-02-11T05:41:36.1723805Z                          _ => {
test	Check formatting	2026-02-11T05:41:36.1724175Z                              return Err(anyhow::anyhow!(
test	Check formatting	2026-02-11T05:41:36.1725037Z -                                "Invalid resource mode: {}. Use 'strict' or 'loose'", mode
test	Check formatting	2026-02-11T05:41:36.1725958Z +                                "Invalid resource mode: {}. Use 'strict' or 'loose'",
test	Check formatting	2026-02-11T05:41:36.1726634Z +                                mode
test	Check formatting	2026-02-11T05:41:36.1727129Z                              ));
test	Check formatting	2026-02-11T05:41:36.1727546Z                          }
test	Check formatting	2026-02-11T05:41:36.1727741Z                      };
test	Check formatting	2026-02-11T05:41:36.1727997Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:818:
test	Check formatting	2026-02-11T05:41:36.1728300Z  
test	Check formatting	2026-02-11T05:41:36.1728468Z              println!("Available devices:");
test	Check formatting	2026-02-11T05:41:36.1728722Z              for device in &devices {
test	Check formatting	2026-02-11T05:41:36.1728974Z -                println!("  {} - {:?} (available: {})",
test	Check formatting	2026-02-11T05:41:36.1729304Z -                    device.name, device.device_type, device.available);
test	Check formatting	2026-02-11T05:41:36.1729608Z +                println!(
test	Check formatting	2026-02-11T05:41:36.1729825Z +                    "  {} - {:?} (available: {})",
test	Check formatting	2026-02-11T05:41:36.1730142Z +                    device.name, device.device_type, device.available
test	Check formatting	2026-02-11T05:41:36.1730420Z +                );
test	Check formatting	2026-02-11T05:41:36.1730579Z              }
test	Check formatting	2026-02-11T05:41:36.1730723Z  
test	Check formatting	2026-02-11T05:41:36.1730913Z              let config = capi_core::Config::load()?;
test	Check formatting	2026-02-11T05:41:36.1731240Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:826:
test	Check formatting	2026-02-11T05:41:36.1731726Z -            if let Some(selected) = capi_core::select_best_device(&devices, &config.device_preference) {
test	Check formatting	2026-02-11T05:41:36.1732240Z -                println!("\nSelected device (based on {:?} preference): {}",
test	Check formatting	2026-02-11T05:41:36.1732607Z -                    config.device_preference, selected);
test	Check formatting	2026-02-11T05:41:36.1733104Z +            if let Some(selected) =
test	Check formatting	2026-02-11T05:41:36.1733443Z +                capi_core::select_best_device(&devices, &config.device_preference)
test	Check formatting	2026-02-11T05:41:36.1733776Z +            {
test	Check formatting	2026-02-11T05:41:36.1733938Z +                println!(
test	Check formatting	2026-02-11T05:41:36.1734195Z +                    "\nSelected device (based on {:?} preference): {}",
test	Check formatting	2026-02-11T05:41:36.1734513Z +                    config.device_preference, selected
test	Check formatting	2026-02-11T05:41:36.1734763Z +                );
test	Check formatting	2026-02-11T05:41:36.1734925Z              }
test	Check formatting	2026-02-11T05:41:36.1735069Z  
test	Check formatting	2026-02-11T05:41:36.1735240Z              println!("\nSystem Resources:");
test	Check formatting	2026-02-11T05:41:36.1735552Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:832:
test	Check formatting	2026-02-11T05:41:36.1735894Z              match capi_core::detect_system_resources() {
test	Check formatting	2026-02-11T05:41:36.1736158Z                  Ok(resources) => {
test	Check formatting	2026-02-11T05:41:36.1736524Z -                    println!("  Total RAM: {:.2} GB", resources.total_ram_bytes as f64 / 1_000_000_000.0);
test	Check formatting	2026-02-11T05:41:36.1737104Z -                    println!("  Available RAM: {:.2} GB", resources.available_ram_bytes as f64 / 1_000_000_000.0);
test	Check formatting	2026-02-11T05:41:36.1737515Z +                    println!(
test	Check formatting	2026-02-11T05:41:36.1737729Z +                        "  Total RAM: {:.2} GB",
test	Check formatting	2026-02-11T05:41:36.1738160Z +                        resources.total_ram_bytes as f64 / 1_000_000_000.0
test	Check formatting	2026-02-11T05:41:36.1738447Z +                    );
test	Check formatting	2026-02-11T05:41:36.1738624Z +                    println!(
test	Check formatting	2026-02-11T05:41:36.1738844Z +                        "  Available RAM: {:.2} GB",
test	Check formatting	2026-02-11T05:41:36.1739150Z +                        resources.available_ram_bytes as f64 / 1_000_000_000.0
test	Check formatting	2026-02-11T05:41:36.1739451Z +                    );
test	Check formatting	2026-02-11T05:41:36.1739614Z  
test	Check formatting	2026-02-11T05:41:36.1739803Z                      if resources.gpu_resources.is_empty() {
test	Check formatting	2026-02-11T05:41:36.1740108Z                          println!("  No GPU resources detected");
test	Check formatting	2026-02-11T05:41:36.1740439Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:840:
test	Check formatting	2026-02-11T05:41:36.1741007Z                          println!("  GPU Resources:");
test	Check formatting	2026-02-11T05:41:36.1741982Z                          for (idx, gpu) in resources.gpu_resources.iter().enumerate() {
test	Check formatting	2026-02-11T05:41:36.1742761Z                              println!("    GPU {}: {}", idx, gpu.name);
test	Check formatting	2026-02-11T05:41:36.1743822Z -                            println!("      Total VRAM: {:.2} GB", gpu.total_vram_bytes as f64 / 1_000_000_000.0);
test	Check formatting	2026-02-11T05:41:36.1744796Z -                            println!("      Available VRAM: {:.2} GB", gpu.available_vram_bytes as f64 / 1_000_000_000.0);
test	Check formatting	2026-02-11T05:41:36.1745721Z +                            println!(
test	Check formatting	2026-02-11T05:41:36.1746688Z +                                "      Total VRAM: {:.2} GB",
test	Check formatting	2026-02-11T05:41:36.1747335Z +                                gpu.total_vram_bytes as f64 / 1_000_000_000.0
test	Check formatting	2026-02-11T05:41:36.1747930Z +                            );
test	Check formatting	2026-02-11T05:41:36.1748749Z +                            println!(
test	Check formatting	2026-02-11T05:41:36.1749596Z +                                "      Available VRAM: {:.2} GB",
test	Check formatting	2026-02-11T05:41:36.1750253Z +                                gpu.available_vram_bytes as f64 / 1_000_000_000.0
test	Check formatting	2026-02-11T05:41:36.1750844Z +                            );
test	Check formatting	2026-02-11T05:41:36.1751750Z                          }
test	Check formatting	2026-02-11T05:41:36.1752572Z                      }
test	Check formatting	2026-02-11T05:41:36.1753673Z                  }
test	Check formatting	2026-02-11T05:41:36.1754620Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:871:
test	Check formatting	2026-02-11T05:41:36.1755242Z      }
test	Check formatting	2026-02-11T05:41:36.1756117Z  }
test	Check formatting	2026-02-11T05:41:36.1756965Z  
test	Check formatting	2026-02-11T05:41:36.1758201Z -fn find_file_with_extension(dir: &std::path::Path, ext: &str) -> Result<Option<std::path::PathBuf>> {
test	Check formatting	2026-02-11T05:41:36.1758926Z +fn find_file_with_extension(
test	Check formatting	2026-02-11T05:41:36.1759884Z +    dir: &std::path::Path,
test	Check formatting	2026-02-11T05:41:36.1760799Z +    ext: &str,
test	Check formatting	2026-02-11T05:41:36.1761661Z +) -> Result<Option<std::path::PathBuf>> {
test	Check formatting	2026-02-11T05:41:36.1762332Z      Ok(std::fs::read_dir(dir)?
test	Check formatting	2026-02-11T05:41:36.1763181Z          .filter_map(|e| e.ok())
test	Check formatting	2026-02-11T05:41:36.1763999Z          .find(|e| e.path().extension().map_or(false, |e| e == ext))
test	Check formatting	2026-02-11T05:41:36.1764768Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:878:
test	Check formatting	2026-02-11T05:41:36.1765416Z          .map(|e| e.path()))
test	Check formatting	2026-02-11T05:41:36.1766323Z  }
test	Check formatting	2026-02-11T05:41:36.1767210Z  
test	Check formatting	2026-02-11T05:41:36.1768058Z -
test	Check formatting	2026-02-11T05:41:36.1768922Z -
test	Check formatting	2026-02-11T05:41:36.1769842Z  fn format_timestamp(ts: i64) -> String {
test	Check formatting	2026-02-11T05:41:36.1770701Z      let now = std::time::SystemTime::now()
test	Check formatting	2026-02-11T05:41:36.1771481Z          .duration_since(std::time::UNIX_EPOCH)
test	Check formatting	2026-02-11T05:41:36.1772381Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:903:
test	Check formatting	2026-02-11T05:41:36.1773171Z  
test	Check formatting	2026-02-11T05:41:36.1774173Z  fn extract_quantization(filename: &str) -> Option<String> {
test	Check formatting	2026-02-11T05:41:36.1774831Z      let patterns = vec![
test	Check formatting	2026-02-11T05:41:36.1775800Z -        "Q2_K", "Q3_K_S", "Q3_K_M", "Q3_K_L",
test	Check formatting	2026-02-11T05:41:36.1776560Z -        "Q4_0", "Q4_1", "Q4_K_S", "Q4_K_M",
test	Check formatting	2026-02-11T05:41:36.1777365Z -        "Q5_0", "Q5_1", "Q5_K_S", "Q5_K_M",
test	Check formatting	2026-02-11T05:41:36.1778151Z -        "Q6_K", "Q8_0",
test	Check formatting	2026-02-11T05:41:36.1779121Z -        "IQ1_S", "IQ1_M", "IQ2_XXS", "IQ2_XS", "IQ2_S", "IQ2_M",
test	Check formatting	2026-02-11T05:41:36.1779986Z -        "IQ3_XXS", "IQ3_XS", "IQ3_S", "IQ3_M",
test	Check formatting	2026-02-11T05:41:36.1780800Z -        "IQ4_XS", "IQ4_NL",
test	Check formatting	2026-02-11T05:41:36.1781769Z -        "F16", "F32",
test	Check formatting	2026-02-11T05:41:36.1783038Z +        "Q2_K", "Q3_K_S", "Q3_K_M", "Q3_K_L", "Q4_0", "Q4_1", "Q4_K_S", "Q4_K_M", "Q5_0", "Q5_1",
test	Check formatting	2026-02-11T05:41:36.1783882Z +        "Q5_K_S", "Q5_K_M", "Q6_K", "Q8_0", "IQ1_S", "IQ1_M", "IQ2_XXS", "IQ2_XS", "IQ2_S",
test	Check formatting	2026-02-11T05:41:36.1784709Z +        "IQ2_M", "IQ3_XXS", "IQ3_XS", "IQ3_S", "IQ3_M", "IQ4_XS", "IQ4_NL", "F16", "F32",
test	Check formatting	2026-02-11T05:41:36.1785354Z      ];
test	Check formatting	2026-02-11T05:41:36.1786237Z  
test	Check formatting	2026-02-11T05:41:36.1787146Z      let upper = filename.to_uppercase();
test	Check formatting	2026-02-11T05:41:36.1788013Z Diff in /home/runner/work/capi/capi/capi-cli/src/main.rs:929:
test	Check formatting	2026-02-11T05:41:36.1788671Z      let mut quants = Vec::new();
test	Check formatting	2026-02-11T05:41:36.1789401Z  
test	Check formatting	2026-02-11T05:41:36.1790304Z      let patterns = vec![
test	Check formatting	2026-02-11T05:41:36.1791209Z -        "Q2_K", "Q3_K_S", "Q3_K_M", "Q3_K_L",
test	Check formatting	2026-02-11T05:41:36.1791958Z -        "Q4_0", "Q4_1", "Q4_K_S", "Q4_K_M",
test	Check formatting	2026-02-11T05:41:36.1792793Z -        "Q5_0", "Q5_1", "Q5_K_S", "Q5_K_M",
test	Check formatting	2026-02-11T05:41:36.1793594Z -        "Q6_K", "Q8_0",
test	Check formatting	2026-02-11T05:41:36.1794440Z -        "IQ1_S", "IQ1_M", "IQ2_XXS", "IQ2_XS", "IQ2_S", "IQ2_M",
test	Check formatting	2026-02-11T05:41:36.1795041Z -        "IQ3_XXS", "IQ3_XS", "IQ3_S", "IQ3_M",
test	Check formatting	2026-02-11T05:41:36.1795790Z -        "IQ4_XS", "IQ4_NL",
test	Check formatting	2026-02-11T05:41:36.1796604Z -        "F16", "F32",
test	Check formatting	2026-02-11T05:41:36.1797680Z +        "Q2_K", "Q3_K_S", "Q3_K_M", "Q3_K_L", "Q4_0", "Q4_1", "Q4_K_S", "Q4_K_M", "Q5_0", "Q5_1",
test	Check formatting	2026-02-11T05:41:36.1798506Z +        "Q5_K_S", "Q5_K_M", "Q6_K", "Q8_0", "IQ1_S", "IQ1_M", "IQ2_XXS", "IQ2_XS", "IQ2_S",
test	Check formatting	2026-02-11T05:41:36.1799325Z +        "IQ2_M", "IQ3_XXS", "IQ3_XS", "IQ3_S", "IQ3_M", "IQ4_XS", "IQ4_NL", "F16", "F32",
test	Check formatting	2026-02-11T05:41:36.1799983Z      ];
test	Check formatting	2026-02-11T05:41:36.1800829Z  
test	Check formatting	2026-02-11T05:41:36.1801649Z      for pattern in &patterns {
test	Check formatting	2026-02-11T05:41:36.1838534Z Diff in /home/runner/work/capi/capi/capi-core/build.rs:10:
test	Check formatting	2026-02-11T05:41:36.1840575Z  
test	Check formatting	2026-02-11T05:41:36.1840931Z      // Link directories
test	Check formatting	2026-02-11T05:41:36.1841358Z      if let Some(root) = &openvino_root {
test	Check formatting	2026-02-11T05:41:36.1841851Z -        println!("cargo:rustc-link-search=native={}/runtime/lib/intel64", root);
test	Check formatting	2026-02-11T05:41:36.1842471Z -        println!("cargo:rustc-link-search=native={}/runtime/3rdparty/tbb/lib", root);
test	Check formatting	2026-02-11T05:41:36.1843149Z +        println!(
test	Check formatting	2026-02-11T05:41:36.1843407Z +            "cargo:rustc-link-search=native={}/runtime/lib/intel64",
test	Check formatting	2026-02-11T05:41:36.1843704Z +            root
test	Check formatting	2026-02-11T05:41:36.1843865Z +        );
test	Check formatting	2026-02-11T05:41:36.1844013Z +        println!(
test	Check formatting	2026-02-11T05:41:36.1844271Z +            "cargo:rustc-link-search=native={}/runtime/3rdparty/tbb/lib",
test	Check formatting	2026-02-11T05:41:36.1844580Z +            root
test	Check formatting	2026-02-11T05:41:36.1844738Z +        );
test	Check formatting	2026-02-11T05:41:36.1844883Z      } else {
test	Check formatting	2026-02-11T05:41:36.1845117Z          println!("cargo:rustc-link-search=native=/usr/lib");
test	Check formatting	2026-02-11T05:41:36.1845406Z      }
test	Check formatting	2026-02-11T05:41:36.1845627Z Diff in /home/runner/work/capi/capi/capi-core/build.rs:24:
test	Check formatting	2026-02-11T05:41:36.1845999Z      let mut build = cxx_build::bridge("src/genai_bridge.rs");
test	Check formatting	2026-02-11T05:41:36.1846305Z      build.file("src/cpp/bridge.cpp");
test	Check formatting	2026-02-11T05:41:36.1846540Z      build.std("c++17");
test	Check formatting	2026-02-11T05:41:36.1846726Z -    
test	Check formatting	2026-02-11T05:41:36.1846874Z +
test	Check formatting	2026-02-11T05:41:36.1847035Z      if let Some(root) = &openvino_root {
test	Check formatting	2026-02-11T05:41:36.1847327Z          build.include(format!("{}/runtime/include", root));
test	Check formatting	2026-02-11T05:41:36.1847591Z      }
test	Check formatting	2026-02-11T05:41:36.1847806Z Diff in /home/runner/work/capi/capi/capi-core/build.rs:31:
test	Check formatting	2026-02-11T05:41:36.1848078Z -    
test	Check formatting	2026-02-11T05:41:36.1848211Z +
test	Check formatting	2026-02-11T05:41:36.1848366Z      build.compile("genai_bridge");
test	Check formatting	2026-02-11T05:41:36.1848574Z  }
test	Check formatting	2026-02-11T05:41:36.1848709Z  
test	Check formatting	2026-02-11T05:41:36.3100093Z Diff in /home/runner/work/capi/capi/capi-core/src/api/chat.rs:1:
test	Check formatting	2026-02-11T05:41:36.3103072Z  use axum::{
test	Check formatting	2026-02-11T05:41:36.3103382Z -    Json,
test	Check formatting	2026-02-11T05:41:36.3103790Z -    response::{IntoResponse, Response, sse::{Event, Sse}},
test	Check formatting	2026-02-11T05:41:36.3104328Z      extract::State,
test	Check formatting	2026-02-11T05:41:36.3104654Z      http::StatusCode,
test	Check formatting	2026-02-11T05:41:36.3104984Z +    response::{
test	Check formatting	2026-02-11T05:41:36.3105268Z +        sse::{Event, Sse},
test	Check formatting	2026-02-11T05:41:36.3105646Z +        IntoResponse, Response,
test	Check formatting	2026-02-11T05:41:36.3105979Z +    },
test	Check formatting	2026-02-11T05:41:36.3106221Z +    Json,
test	Check formatting	2026-02-11T05:41:36.3106467Z  };
test	Check formatting	2026-02-11T05:41:36.3106726Z  use futures::stream::Stream;
test	Check formatting	2026-02-11T05:41:36.3107116Z  use serde::{Deserialize, Serialize};
test	Check formatting	2026-02-11T05:41:36.3107631Z Diff in /home/runner/work/capi/capi/capi-core/src/api/chat.rs:9:
test	Check formatting	2026-02-11T05:41:36.3108189Z +use std::convert::Infallible;
test	Check formatting	2026-02-11T05:41:36.3108541Z  use std::sync::Arc;
test	Check formatting	2026-02-11T05:41:36.3108861Z  use tokio::sync::RwLock;
test	Check formatting	2026-02-11T05:41:36.3109207Z -use std::convert::Infallible;
test	Check formatting	2026-02-11T05:41:36.3109577Z  
test	Check formatting	2026-02-11T05:41:36.3109850Z  use crate::model_manager::Registry;
test	Check formatting	2026-02-11T05:41:36.3110273Z  use crate::InferenceSession;
test	Check formatting	2026-02-11T05:41:36.3110783Z Diff in /home/runner/work/capi/capi/capi-core/src/api/chat.rs:109:
test	Check formatting	2026-02-11T05:41:36.3111340Z      state: AppState,
test	Check formatting	2026-02-11T05:41:36.3111701Z      payload: ChatCompletionRequest,
test	Check formatting	2026-02-11T05:41:36.3112180Z  ) -> anyhow::Result<ChatCompletionResponse> {
test	Check formatting	2026-02-11T05:41:36.3113148Z -    let model_id = payload.model.as_ref()
test	Check formatting	2026-02-11T05:41:36.3113733Z +    let model_id = payload
test	Check formatting	2026-02-11T05:41:36.3114086Z +        .model
test	Check formatting	2026-02-11T05:41:36.3114355Z +        .as_ref()
test	Check formatting	2026-02-11T05:41:36.3114759Z          .ok_or_else(|| anyhow::anyhow!("Model is required"))?;
test	Check formatting	2026-02-11T05:41:36.3115245Z  
test	Check formatting	2026-02-11T05:41:36.3115566Z      let mut cache = state.model_cache.write().await;
test	Check formatting	2026-02-11T05:41:36.3116182Z Diff in /home/runner/work/capi/capi/capi-core/src/api/chat.rs:117:
test	Check formatting	2026-02-11T05:41:36.3116882Z      let session = if let Some(cached_session) = cache.get(model_id) {
test	Check formatting	2026-02-11T05:41:36.3117478Z          Arc::clone(cached_session)
test	Check formatting	2026-02-11T05:41:36.3117921Z      } else {
test	Check formatting	2026-02-11T05:41:36.3118273Z -        let model = state.registry.get_model(model_id)?
test	Check formatting	2026-02-11T05:41:36.3118751Z +        let model = state
test	Check formatting	2026-02-11T05:41:36.3119086Z +            .registry
test	Check formatting	2026-02-11T05:41:36.3119394Z +            .get_model(model_id)?
test	Check formatting	2026-02-11T05:41:36.3119935Z              .ok_or_else(|| anyhow::anyhow!("Model not found: {}", model_id))?;
test	Check formatting	2026-02-11T05:41:36.3120455Z  
test	Check formatting	2026-02-11T05:41:36.3120731Z          let config = crate::Config::load()?;
test	Check formatting	2026-02-11T05:41:36.3121307Z Diff in /home/runner/work/capi/capi/capi-core/src/api/chat.rs:137:
test	Check formatting	2026-02-11T05:41:36.3121838Z  
test	Check formatting	2026-02-11T05:41:36.3122144Z      let mut session_guard = session.write().await;
test	Check formatting	2026-02-11T05:41:36.3122558Z  
test	Check formatting	2026-02-11T05:41:36.3123060Z -    let conversation: String = payload.messages.iter()
test	Check formatting	2026-02-11T05:41:36.3123554Z -        .map(|m| format!("{}: {}",
test	Check formatting	2026-02-11T05:41:36.3124013Z -            if m.role == "user" { "User" } else { "Assistant" },
test	Check formatting	2026-02-11T05:41:36.3124516Z -            m.content
test	Check formatting	2026-02-11T05:41:36.3124806Z -        ))
test	Check formatting	2026-02-11T05:41:36.3125106Z +    let conversation: String = payload
test	Check formatting	2026-02-11T05:41:36.3125479Z +        .messages
test	Check formatting	2026-02-11T05:41:36.3125743Z +        .iter()
test	Check formatting	2026-02-11T05:41:36.3126004Z +        .map(|m| {
test	Check formatting	2026-02-11T05:41:36.3126301Z +            format!(
test	Check formatting	2026-02-11T05:41:36.3126597Z +                "{}: {}",
test	Check formatting	2026-02-11T05:41:36.3126935Z +                if m.role == "user" {
test	Check formatting	2026-02-11T05:41:36.3127305Z +                    "User"
test	Check formatting	2026-02-11T05:41:36.3127611Z +                } else {
test	Check formatting	2026-02-11T05:41:36.3127914Z +                    "Assistant"
test	Check formatting	2026-02-11T05:41:36.3128242Z +                },
test	Check formatting	2026-02-11T05:41:36.3128527Z +                m.content
test	Check formatting	2026-02-11T05:41:36.3128833Z +            )
test	Check formatting	2026-02-11T05:41:36.3129098Z +        })
test	Check formatting	2026-02-11T05:41:36.3129371Z          .collect::<Vec<_>>()
test	Check formatting	2026-02-11T05:41:36.3129721Z          .join("\n");
test	Check formatting	2026-02-11T05:41:36.3130238Z  
test	Check formatting	2026-02-11T05:41:36.3130639Z Diff in /home/runner/work/capi/capi/capi-core/src/api/chat.rs:228:
test	Check formatting	2026-02-11T05:41:36.3131176Z  
test	Check formatting	2026-02-11T05:41:36.3131634Z          // We don't need to hold the lock here, as spawn_blocking will acquire its own.
test	Check formatting	2026-02-11T05:41:36.3132397Z          // Holding it here would cause a deadlock with blocking_write below.
test	Check formatting	2026-02-11T05:41:36.3133222Z -        
test	Check formatting	2026-02-11T05:41:36.3133485Z +
test	Check formatting	2026-02-11T05:41:36.3133832Z          let conversation: String = payload.messages.iter()
test	Check formatting	2026-02-11T05:41:36.3134559Z              .map(|m| format!("{}: {}", if m.role == "user" { "User" } else { "Assistant" }, m.content))
test	Check formatting	2026-02-11T05:41:36.3135194Z              .collect::<Vec<_>>()
test	Check formatting	2026-02-11T05:41:36.3135735Z Diff in /home/runner/work/capi/capi/capi-core/src/api/embeddings.rs:1:
test	Check formatting	2026-02-11T05:41:36.3136341Z -use axum::{Json, response::IntoResponse};
test	Check formatting	2026-02-11T05:41:36.3136799Z +use axum::{response::IntoResponse, Json};
test	Check formatting	2026-02-11T05:41:36.3137237Z  use serde::{Deserialize, Serialize};
test	Check formatting	2026-02-11T05:41:36.3137616Z  
test	Check formatting	2026-02-11T05:41:36.3137866Z  #[derive(Deserialize)]
test	Check formatting	2026-02-11T05:41:36.3138353Z Diff in /home/runner/work/capi/capi/capi-core/src/api/embeddings.rs:30:
test	Check formatting	2026-02-11T05:41:36.3138936Z      pub index: usize,
test	Check formatting	2026-02-11T05:41:36.3139226Z  }
test	Check formatting	2026-02-11T05:41:36.3139469Z  
test	Check formatting	2026-02-11T05:41:36.3139710Z -pub async fn create(
test	Check formatting	2026-02-11T05:41:36.3140339Z -    Json(_payload): Json<EmbeddingRequest>,
test	Check formatting	2026-02-11T05:41:36.3140775Z -) -> impl IntoResponse {
test	Check formatting	2026-02-11T05:41:36.3141349Z +pub async fn create(Json(_payload): Json<EmbeddingRequest>) -> impl IntoResponse {
test	Check formatting	2026-02-11T05:41:36.3142028Z      Json(EmbeddingResponse {
test	Check formatting	2026-02-11T05:41:36.3142399Z          object: "list".to_string(),
test	Check formatting	2026-02-11T05:41:36.3142782Z          data: vec![],
test	Check formatting	2026-02-11T05:41:36.3145014Z Diff in /home/runner/work/capi/capi/capi-core/src/api/mod.rs:2:
test	Check formatting	2026-02-11T05:41:36.3145581Z  mod embeddings;
test	Check formatting	2026-02-11T05:41:36.3145855Z  mod models;
test	Check formatting	2026-02-11T05:41:36.3146109Z  
test	Check formatting	2026-02-11T05:41:36.3146394Z -use axum::{Router, routing::post};
test	Check formatting	2026-02-11T05:41:36.3146809Z +use axum::{routing::post, Router};
test	Check formatting	2026-02-11T05:41:36.3147209Z  pub use chat::AppState;
test	Check formatting	2026-02-11T05:41:36.3147533Z  
test	Check formatting	2026-02-11T05:41:36.3147853Z  pub fn create_router(state: AppState) -> Router {
test	Check formatting	2026-02-11T05:41:36.3148481Z Diff in /home/runner/work/capi/capi/capi-core/src/api/models.rs:1:
test	Check formatting	2026-02-11T05:41:36.3149238Z -use axum::{Json, response::IntoResponse, extract::State, http::StatusCode};
test	Check formatting	2026-02-11T05:41:36.3149822Z -use serde::Serialize;
test	Check formatting	2026-02-11T05:41:36.3150147Z  use crate::api::chat::AppState;
test	Check formatting	2026-02-11T05:41:36.3150697Z +use axum::{extract::State, http::StatusCode, response::IntoResponse, Json};
test	Check formatting	2026-02-11T05:41:36.3151308Z +use serde::Serialize;
test	Check formatting	2026-02-11T05:41:36.3151598Z  
test	Check formatting	2026-02-11T05:41:36.3151850Z  #[derive(Serialize)]
test	Check formatting	2026-02-11T05:41:36.3152166Z  pub struct ModelList {
test	Check formatting	2026-02-11T05:41:36.3152654Z Diff in /home/runner/work/capi/capi/capi-core/src/api/models.rs:19:
test	Check formatting	2026-02-11T05:41:36.3153558Z  pub async fn list(State(state): State<AppState>) -> impl IntoResponse {
test	Check formatting	2026-02-11T05:41:36.3154172Z      match state.registry.list_models() {
test	Check formatting	2026-02-11T05:41:36.3154573Z          Ok(models) => {
test	Check formatting	2026-02-11T05:41:36.3154990Z -            let model_list = models.into_iter().map(|m| Model {
test	Check formatting	2026-02-11T05:41:36.3155478Z -                id: m.id,
test	Check formatting	2026-02-11T05:41:36.3155829Z -                object: "model".to_string(),
test	Check formatting	2026-02-11T05:41:36.3156273Z -                created: m.created_at,
test	Check formatting	2026-02-11T05:41:36.3156687Z -                owned_by: "user".to_string(),
test	Check formatting	2026-02-11T05:41:36.3157100Z -            }).collect();
test	Check formatting	2026-02-11T05:41:36.3157438Z +            let model_list = models
test	Check formatting	2026-02-11T05:41:36.3157821Z +                .into_iter()
test	Check formatting	2026-02-11T05:41:36.3158147Z +                .map(|m| Model {
test	Check formatting	2026-02-11T05:41:36.3158475Z +                    id: m.id,
test	Check formatting	2026-02-11T05:41:36.3158827Z +                    object: "model".to_string(),
test	Check formatting	2026-02-11T05:41:36.3159250Z +                    created: m.created_at,
test	Check formatting	2026-02-11T05:41:36.3159936Z +                    owned_by: "user".to_string(),
test	Check formatting	2026-02-11T05:41:36.3160348Z +                })
test	Check formatting	2026-02-11T05:41:36.3160647Z +                .collect();
test	Check formatting	2026-02-11T05:41:36.3160966Z  
test	Check formatting	2026-02-11T05:41:36.3161234Z              Json(ModelList {
test	Check formatting	2026-02-11T05:41:36.3161599Z                  object: "list".to_string(),
test	Check formatting	2026-02-11T05:41:36.3162127Z Diff in /home/runner/work/capi/capi/capi-core/src/api/models.rs:31:
test	Check formatting	2026-02-11T05:41:36.3162675Z                  data: model_list,
test	Check formatting	2026-02-11T05:41:36.3163205Z -            }).into_response()
test	Check formatting	2026-02-11T05:41:36.3163554Z +            })
test	Check formatting	2026-02-11T05:41:36.3163834Z +            .into_response()
test	Check formatting	2026-02-11T05:41:36.3164169Z          }
test	Check formatting	2026-02-11T05:41:36.3164416Z -        Err(e) => {
test	Check formatting	2026-02-11T05:41:36.3164919Z -            (StatusCode::INTERNAL_SERVER_ERROR, e.to_string()).into_response()
test	Check formatting	2026-02-11T05:41:36.3165495Z -        }
test	Check formatting	2026-02-11T05:41:36.3165976Z +        Err(e) => (StatusCode::INTERNAL_SERVER_ERROR, e.to_string()).into_response(),
test	Check formatting	2026-02-11T05:41:36.3166577Z      }
test	Check formatting	2026-02-11T05:41:36.3166817Z  }
test	Check formatting	2026-02-11T05:41:36.3167042Z  
test	Check formatting	2026-02-11T05:41:36.3167590Z Diff in /home/runner/work/capi/capi/capi-core/src/db/chats.rs:24:
test	Check formatting	2026-02-11T05:41:36.3168144Z      let mut stmt = conn.prepare(
test	Check formatting	2026-02-11T05:41:36.3168597Z          "SELECT id, title, model_id, created_at, updated_at
test	Check formatting	2026-02-11T05:41:36.3169090Z           FROM chat_sessions
test	Check formatting	2026-02-11T05:41:36.3169679Z -         ORDER BY updated_at DESC"
test	Check formatting	2026-02-11T05:41:36.3170091Z +         ORDER BY updated_at DESC",
test	Check formatting	2026-02-11T05:41:36.3170459Z      )?;
test	Check formatting	2026-02-11T05:41:36.3170705Z  
test	Check formatting	2026-02-11T05:41:36.3170998Z -    let sessions = stmt.query_map([], |row| {
test	Check formatting	2026-02-11T05:41:36.3171447Z -        Ok(ChatSession {
test	Check formatting	2026-02-11T05:41:36.3171793Z -            id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3172166Z -            title: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3172544Z -            model_id: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3173136Z -            created_at: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3173522Z -            updated_at: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3173892Z -        })
test	Check formatting	2026-02-11T05:41:36.3174121Z -    })?
test	Check formatting	2026-02-11T05:41:36.3174394Z -    .collect::<Result<Vec<_>, _>>()?;
test	Check formatting	2026-02-11T05:41:36.3174767Z +    let sessions = stmt
test	Check formatting	2026-02-11T05:41:36.3175095Z +        .query_map([], |row| {
test	Check formatting	2026-02-11T05:41:36.3175438Z +            Ok(ChatSession {
test	Check formatting	2026-02-11T05:41:36.3175786Z +                id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3176153Z +                title: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3176541Z +                model_id: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3176944Z +                created_at: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3177322Z +                updated_at: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3177546Z +            })
test	Check formatting	2026-02-11T05:41:36.3177695Z +        })?
test	Check formatting	2026-02-11T05:41:36.3177867Z +        .collect::<Result<Vec<_>, _>>()?;
test	Check formatting	2026-02-11T05:41:36.3178097Z  
test	Check formatting	2026-02-11T05:41:36.3178240Z      Ok(sessions)
test	Check formatting	2026-02-11T05:41:36.3178398Z  }
test	Check formatting	2026-02-11T05:41:36.3178638Z Diff in /home/runner/work/capi/capi/capi-core/src/db/chats.rs:45:
test	Check formatting	2026-02-11T05:41:36.3178966Z      let mut stmt = conn.prepare(
test	Check formatting	2026-02-11T05:41:36.3179236Z          "SELECT id, title, model_id, created_at, updated_at
test	Check formatting	2026-02-11T05:41:36.3179525Z           FROM chat_sessions
test	Check formatting	2026-02-11T05:41:36.3179721Z -         WHERE id = ?"
test	Check formatting	2026-02-11T05:41:36.3179912Z +         WHERE id = ?",
test	Check formatting	2026-02-11T05:41:36.3180089Z      )?;
test	Check formatting	2026-02-11T05:41:36.3180245Z  
test	Check formatting	2026-02-11T05:41:36.3180415Z -    let session = stmt.query_row([id], |row| {
test	Check formatting	2026-02-11T05:41:36.3180672Z -        Ok(ChatSession {
test	Check formatting	2026-02-11T05:41:36.3180865Z -            id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3181069Z -            title: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3181274Z -            model_id: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3181499Z -            created_at: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3181723Z -            updated_at: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3181936Z +    let session = stmt
test	Check formatting	2026-02-11T05:41:36.3182130Z +        .query_row([id], |row| {
test	Check formatting	2026-02-11T05:41:36.3182335Z +            Ok(ChatSession {
test	Check formatting	2026-02-11T05:41:36.3182705Z +                id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3183176Z +                title: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3183410Z +                model_id: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3183645Z +                created_at: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3183887Z +                updated_at: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3184108Z +            })
test	Check formatting	2026-02-11T05:41:36.3184265Z          })
test	Check formatting	2026-02-11T05:41:36.3184420Z -    }).optional()?;
test	Check formatting	2026-02-11T05:41:36.3184596Z +        .optional()?;
test	Check formatting	2026-02-11T05:41:36.3184768Z  
test	Check formatting	2026-02-11T05:41:36.3184901Z      Ok(session)
test	Check formatting	2026-02-11T05:41:36.3185067Z  }
test	Check formatting	2026-02-11T05:41:36.3185301Z Diff in /home/runner/work/capi/capi/capi-core/src/db/chats.rs:102:
test	Check formatting	2026-02-11T05:41:36.3185668Z          "SELECT id, session_id, role, content, created_at
test	Check formatting	2026-02-11T05:41:36.3185938Z           FROM chat_messages
test	Check formatting	2026-02-11T05:41:36.3186144Z           WHERE session_id = ?
test	Check formatting	2026-02-11T05:41:36.3186345Z -         ORDER BY created_at ASC"
test	Check formatting	2026-02-11T05:41:36.3186576Z +         ORDER BY created_at ASC",
test	Check formatting	2026-02-11T05:41:36.3186784Z      )?;
test	Check formatting	2026-02-11T05:41:36.3186924Z  
test	Check formatting	2026-02-11T05:41:36.3187120Z -    let messages = stmt.query_map([session_id], |row| {
test	Check formatting	2026-02-11T05:41:36.3187395Z -        Ok(ChatMessage {
test	Check formatting	2026-02-11T05:41:36.3187591Z -            id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3187797Z -            session_id: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3188179Z -            role: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3188380Z -            content: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3188599Z -            created_at: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3188807Z -        })
test	Check formatting	2026-02-11T05:41:36.3188955Z -    })?
test	Check formatting	2026-02-11T05:41:36.3189120Z -    .collect::<Result<Vec<_>, _>>()?;
test	Check formatting	2026-02-11T05:41:36.3189348Z +    let messages = stmt
test	Check formatting	2026-02-11T05:41:36.3189548Z +        .query_map([session_id], |row| {
test	Check formatting	2026-02-11T05:41:36.3189773Z +            Ok(ChatMessage {
test	Check formatting	2026-02-11T05:41:36.3189992Z +                id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3190199Z +                session_id: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3190431Z +                role: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3190644Z +                content: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3190863Z +                created_at: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3191072Z +            })
test	Check formatting	2026-02-11T05:41:36.3191229Z +        })?
test	Check formatting	2026-02-11T05:41:36.3191394Z +        .collect::<Result<Vec<_>, _>>()?;
test	Check formatting	2026-02-11T05:41:36.3191621Z  
test	Check formatting	2026-02-11T05:41:36.3191761Z      Ok(messages)
test	Check formatting	2026-02-11T05:41:36.3191914Z  }
test	Check formatting	2026-02-11T05:41:36.3192137Z Diff in /home/runner/work/capi/capi/capi-core/src/db/mod.rs:1:
test	Check formatting	2026-02-11T05:41:36.3192435Z -pub mod models;
test	Check formatting	2026-02-11T05:41:36.3192606Z  pub mod chats;
test	Check formatting	2026-02-11T05:41:36.3192763Z +pub mod models;
test	Check formatting	2026-02-11T05:41:36.3193030Z  
test	Check formatting	2026-02-11T05:41:36.3193198Z +pub use chats::{ChatMessage, ChatSession};
test	Check formatting	2026-02-11T05:41:36.3193459Z  pub use models::ModelRecord;
test	Check formatting	2026-02-11T05:41:36.3193684Z -pub use chats::{ChatSession, ChatMessage};
test	Check formatting	2026-02-11T05:41:36.3193918Z  
test	Check formatting	2026-02-11T05:41:36.3194056Z  use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3194248Z  use rusqlite::Connection;
test	Check formatting	2026-02-11T05:41:36.3194518Z Diff in /home/runner/work/capi/capi/capi-core/src/db/mod.rs:60:
test	Check formatting	2026-02-11T05:41:36.3194810Z              .is_ok();
test	Check formatting	2026-02-11T05:41:36.3194977Z  
test	Check formatting	2026-02-11T05:41:36.3195121Z          if !has_estimated_memory {
test	Check formatting	2026-02-11T05:41:36.3195496Z -            conn.execute("ALTER TABLE models ADD COLUMN estimated_memory_bytes INTEGER", [])?;
test	Check formatting	2026-02-11T05:41:36.3195890Z +            conn.execute(
test	Check formatting	2026-02-11T05:41:36.3196170Z +                "ALTER TABLE models ADD COLUMN estimated_memory_bytes INTEGER",
test	Check formatting	2026-02-11T05:41:36.3196489Z +                [],
test	Check formatting	2026-02-11T05:41:36.3196656Z +            )?;
test	Check formatting	2026-02-11T05:41:36.3196947Z              conn.execute("ALTER TABLE models ADD COLUMN context_override INTEGER", [])?;
test	Check formatting	2026-02-11T05:41:36.3197298Z          }
test	Check formatting	2026-02-11T05:41:36.3197445Z  
test	Check formatting	2026-02-11T05:41:36.3197664Z Diff in /home/runner/work/capi/capi/capi-core/src/db/mod.rs:67:
test	Check formatting	2026-02-11T05:41:36.3197991Z -        Ok(Self { conn: Mutex::new(conn) })
test	Check formatting	2026-02-11T05:41:36.3198352Z +        Ok(Self {
test	Check formatting	2026-02-11T05:41:36.3198533Z +            conn: Mutex::new(conn),
test	Check formatting	2026-02-11T05:41:36.3198799Z +        })
test	Check formatting	2026-02-11T05:41:36.3198948Z      }
test	Check formatting	2026-02-11T05:41:36.3199085Z  
test	Check formatting	2026-02-11T05:41:36.3199291Z      pub fn with_connection<F, R>(&self, f: F) -> Result<R>
test	Check formatting	2026-02-11T05:41:36.3199651Z Diff in /home/runner/work/capi/capi/capi-core/src/db/mod.rs:71:
test	Check formatting	2026-02-11T05:41:36.3199941Z      where
test	Check formatting	2026-02-11T05:41:36.3200119Z          F: FnOnce(&Connection) -> Result<R>,
test	Check formatting	2026-02-11T05:41:36.3200343Z      {
test	Check formatting	2026-02-11T05:41:36.3200503Z -        let conn = self.conn.lock()
test	Check formatting	2026-02-11T05:41:36.3200721Z +        let conn = self
test	Check formatting	2026-02-11T05:41:36.3200902Z +            .conn
test	Check formatting	2026-02-11T05:41:36.3201057Z +            .lock()
test	Check formatting	2026-02-11T05:41:36.3201324Z              .map_err(|_| anyhow::anyhow!("Failed to acquire database lock"))?;
test	Check formatting	2026-02-11T05:41:36.3201640Z          f(&conn)
test	Check formatting	2026-02-11T05:41:36.3201792Z      }
test	Check formatting	2026-02-11T05:41:36.3202589Z Diff in /home/runner/work/capi/capi/capi-core/src/db/models.rs:21:
test	Check formatting	2026-02-11T05:41:36.3203904Z          "SELECT id, name, path, size_bytes, quantization, context_length, created_at, last_used,
test	Check formatting	2026-02-11T05:41:36.3204650Z                  estimated_memory_bytes, context_override
test	Check formatting	2026-02-11T05:41:36.3205349Z           FROM models
test	Check formatting	2026-02-11T05:41:36.3206031Z -         ORDER BY last_used DESC, created_at DESC"
test	Check formatting	2026-02-11T05:41:36.3206971Z +         ORDER BY last_used DESC, created_at DESC",
test	Check formatting	2026-02-11T05:41:36.3207820Z      )?;
test	Check formatting	2026-02-11T05:41:36.3208674Z  
test	Check formatting	2026-02-11T05:41:36.3209541Z -    let models = stmt.query_map([], |row| {
test	Check formatting	2026-02-11T05:41:36.3210267Z -        Ok(ModelRecord {
test	Check formatting	2026-02-11T05:41:36.3211776Z -            id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3212592Z -            name: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3213620Z -            path: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3214533Z -            size_bytes: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3215339Z -            quantization: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3216109Z -            context_length: row.get(5)?,
test	Check formatting	2026-02-11T05:41:36.3216806Z -            created_at: row.get(6)?,
test	Check formatting	2026-02-11T05:41:36.3217726Z -            last_used: row.get(7)?,
test	Check formatting	2026-02-11T05:41:36.3218578Z -            estimated_memory_bytes: row.get(8)?,
test	Check formatting	2026-02-11T05:41:36.3219210Z -            context_override: row.get(9)?,
test	Check formatting	2026-02-11T05:41:36.3219960Z -        })
test	Check formatting	2026-02-11T05:41:36.3220795Z -    })?
test	Check formatting	2026-02-11T05:41:36.3221695Z -    .collect::<Result<Vec<_>, _>>()?;
test	Check formatting	2026-02-11T05:41:36.3222420Z +    let models = stmt
test	Check formatting	2026-02-11T05:41:36.3223367Z +        .query_map([], |row| {
test	Check formatting	2026-02-11T05:41:36.3224187Z +            Ok(ModelRecord {
test	Check formatting	2026-02-11T05:41:36.3225080Z +                id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3225986Z +                name: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3226781Z +                path: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3227657Z +                size_bytes: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3228422Z +                quantization: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3229194Z +                context_length: row.get(5)?,
test	Check formatting	2026-02-11T05:41:36.3229974Z +                created_at: row.get(6)?,
test	Check formatting	2026-02-11T05:41:36.3230773Z +                last_used: row.get(7)?,
test	Check formatting	2026-02-11T05:41:36.3231642Z +                estimated_memory_bytes: row.get(8)?,
test	Check formatting	2026-02-11T05:41:36.3232275Z +                context_override: row.get(9)?,
test	Check formatting	2026-02-11T05:41:36.3233049Z +            })
test	Check formatting	2026-02-11T05:41:36.3233812Z +        })?
test	Check formatting	2026-02-11T05:41:36.3234700Z +        .collect::<Result<Vec<_>, _>>()?;
test	Check formatting	2026-02-11T05:41:36.3235463Z  
test	Check formatting	2026-02-11T05:41:36.3236321Z      Ok(models)
test	Check formatting	2026-02-11T05:41:36.3237072Z  }
test	Check formatting	2026-02-11T05:41:36.3238125Z Diff in /home/runner/work/capi/capi/capi-core/src/db/models.rs:48:
test	Check formatting	2026-02-11T05:41:36.3239058Z          "SELECT id, name, path, size_bytes, quantization, context_length, created_at, last_used,
test	Check formatting	2026-02-11T05:41:36.3239804Z                  estimated_memory_bytes, context_override
test	Check formatting	2026-02-11T05:41:36.3240335Z           FROM models
test	Check formatting	2026-02-11T05:41:36.3241281Z -         WHERE id = ?"
test	Check formatting	2026-02-11T05:41:36.3242345Z +         WHERE id = ?",
test	Check formatting	2026-02-11T05:41:36.3243304Z      )?;
test	Check formatting	2026-02-11T05:41:36.3244229Z  
test	Check formatting	2026-02-11T05:41:36.3245034Z -    let model = stmt.query_row([id], |row| {
test	Check formatting	2026-02-11T05:41:36.3246341Z -        Ok(ModelRecord {
test	Check formatting	2026-02-11T05:41:36.3247455Z -            id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3248616Z -            name: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3249854Z -            path: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3251008Z -            size_bytes: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3252336Z -            quantization: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3254220Z -            context_length: row.get(5)?,
test	Check formatting	2026-02-11T05:41:36.3254637Z -            created_at: row.get(6)?,
test	Check formatting	2026-02-11T05:41:36.3255034Z -            last_used: row.get(7)?,
test	Check formatting	2026-02-11T05:41:36.3255471Z -            estimated_memory_bytes: row.get(8)?,
test	Check formatting	2026-02-11T05:41:36.3255982Z -            context_override: row.get(9)?,
test	Check formatting	2026-02-11T05:41:36.3256397Z +    let model = stmt
test	Check formatting	2026-02-11T05:41:36.3256725Z +        .query_row([id], |row| {
test	Check formatting	2026-02-11T05:41:36.3257111Z +            Ok(ModelRecord {
test	Check formatting	2026-02-11T05:41:36.3257467Z +                id: row.get(0)?,
test	Check formatting	2026-02-11T05:41:36.3257838Z +                name: row.get(1)?,
test	Check formatting	2026-02-11T05:41:36.3258213Z +                path: row.get(2)?,
test	Check formatting	2026-02-11T05:41:36.3258605Z +                size_bytes: row.get(3)?,
test	Check formatting	2026-02-11T05:41:36.3259269Z +                quantization: row.get(4)?,
test	Check formatting	2026-02-11T05:41:36.3259709Z +                context_length: row.get(5)?,
test	Check formatting	2026-02-11T05:41:36.3260137Z +                created_at: row.get(6)?,
test	Check formatting	2026-02-11T05:41:36.3260551Z +                last_used: row.get(7)?,
test	Check formatting	2026-02-11T05:41:36.3260993Z +                estimated_memory_bytes: row.get(8)?,
test	Check formatting	2026-02-11T05:41:36.3261454Z +                context_override: row.get(9)?,
test	Check formatting	2026-02-11T05:41:36.3261860Z +            })
test	Check formatting	2026-02-11T05:41:36.3262112Z          })
test	Check formatting	2026-02-11T05:41:36.3262358Z -    }).optional()?;
test	Check formatting	2026-02-11T05:41:36.3262662Z +        .optional()?;
test	Check formatting	2026-02-11T05:41:36.3263138Z  
test	Check formatting	2026-02-11T05:41:36.3263373Z      Ok(model)
test	Check formatting	2026-02-11T05:41:36.3263649Z  }
test	Check formatting	2026-02-11T05:41:36.3264044Z Diff in /home/runner/work/capi/capi/capi-core/src/genai_bridge.rs:75:
test	Check formatting	2026-02-11T05:41:36.3264789Z          fn config_set_top_p(config: Pin<&mut GenerationConfigWrapper>, top_p: f32);
test	Check formatting	2026-02-11T05:41:36.3265639Z          fn config_set_top_k(config: Pin<&mut GenerationConfigWrapper>, top_k: usize);
test	Check formatting	2026-02-11T05:41:36.3266572Z          fn config_set_do_sample(config: Pin<&mut GenerationConfigWrapper>, do_sample: bool);
test	Check formatting	2026-02-11T05:41:36.3267629Z -        fn config_set_stop_strings(config: Pin<&mut GenerationConfigWrapper>, stop_strings: Vec<String>);
test	Check formatting	2026-02-11T05:41:36.3268423Z +        fn config_set_stop_strings(
test	Check formatting	2026-02-11T05:41:36.3268891Z +            config: Pin<&mut GenerationConfigWrapper>,
test	Check formatting	2026-02-11T05:41:36.3269376Z +            stop_strings: Vec<String>,
test	Check formatting	2026-02-11T05:41:36.3269766Z +        );
test	Check formatting	2026-02-11T05:41:36.3270013Z      }
test	Check formatting	2026-02-11T05:41:36.3270266Z  }
test	Check formatting	2026-02-11T05:41:36.3270502Z  
test	Check formatting	2026-02-11T05:41:36.3270951Z Diff in /home/runner/work/capi/capi/capi-core/src/genai_bridge.rs:88:
test	Check formatting	2026-02-11T05:41:36.3271562Z  impl<'a> StreamerCallback<'a> {
test	Check formatting	2026-02-11T05:41:36.3272018Z      pub fn on_token(&mut self, token: &[u8]) -> bool {
test	Check formatting	2026-02-11T05:41:36.3272534Z          self.buffer.extend_from_slice(token);
test	Check formatting	2026-02-11T05:41:36.3273131Z -        
test	Check formatting	2026-02-11T05:41:36.3273402Z +
test	Check formatting	2026-02-11T05:41:36.3273691Z          // Try to decode the buffer as UTF-8
test	Check formatting	2026-02-11T05:41:36.3274205Z          match String::from_utf8(self.buffer.clone()) {
test	Check formatting	2026-02-11T05:41:36.3274667Z              Ok(s) => {
test	Check formatting	2026-02-11T05:41:36.3275162Z Diff in /home/runner/work/capi/capi/capi-core/src/genai_bridge.rs:103:
test	Check formatting	2026-02-11T05:41:36.3275849Z                      let valid_bytes = self.buffer[..valid_up_to].to_vec();
test	Check formatting	2026-02-11T05:41:36.3276507Z                      // SAFETY: valid_up_to is guaranteed to be a valid UTF-8 boundary
test	Check formatting	2026-02-11T05:41:36.3277217Z                      let s = unsafe { String::from_utf8_unchecked(valid_bytes) };
test	Check formatting	2026-02-11T05:41:36.3277960Z -                    
test	Check formatting	2026-02-11T05:41:36.3278245Z +
test	Check formatting	2026-02-11T05:41:36.3278549Z                      // Remove the valid prefix from the buffer
test	Check formatting	2026-02-11T05:41:36.3279054Z                      self.buffer.drain(0..valid_up_to);
test	Check formatting	2026-02-11T05:41:36.3279460Z -                    
test	Check formatting	2026-02-11T05:41:36.3279734Z +
test	Check formatting	2026-02-11T05:41:36.3279854Z                      (self.cb)(&s)
test	Check formatting	2026-02-11T05:41:36.3279967Z                  } else {
test	Check formatting	2026-02-11T05:41:36.3280231Z                      // No valid UTF-8 prefix found yet, keep waiting for more bytes
test	Check formatting	2026-02-11T05:41:36.3280569Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/device_detect.rs:18:
test	Check formatting	2026-02-11T05:41:36.3280672Z  }
test	Check formatting	2026-02-11T05:41:36.3280772Z  
test	Check formatting	2026-02-11T05:41:36.3280974Z  pub fn detect_devices() -> Result<Vec<DeviceInfo>> {
test	Check formatting	2026-02-11T05:41:36.3281104Z -    let mut devices = vec![
test	Check formatting	2026-02-11T05:41:36.3281224Z -        DeviceInfo {
test	Check formatting	2026-02-11T05:41:36.3281353Z -            name: "CPU".to_string(),
test	Check formatting	2026-02-11T05:41:36.3281517Z -            device_type: DeviceType::CPU,
test	Check formatting	2026-02-11T05:41:36.3281646Z -            available: true,
test	Check formatting	2026-02-11T05:41:36.3281747Z -        },
test	Check formatting	2026-02-11T05:41:36.3281847Z -    ];
test	Check formatting	2026-02-11T05:41:36.3281990Z +    let mut devices = vec![DeviceInfo {
test	Check formatting	2026-02-11T05:41:36.3282124Z +        name: "CPU".to_string(),
test	Check formatting	2026-02-11T05:41:36.3282267Z +        device_type: DeviceType::CPU,
test	Check formatting	2026-02-11T05:41:36.3282551Z +        available: true,
test	Check formatting	2026-02-11T05:41:36.3282650Z +    }];
test	Check formatting	2026-02-11T05:41:36.3282751Z  
test	Check formatting	2026-02-11T05:41:36.3283112Z      if std::path::Path::new("/dev/dri").exists() {
test	Check formatting	2026-02-11T05:41:36.3283259Z          devices.push(DeviceInfo {
test	Check formatting	2026-02-11T05:41:36.3283557Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/mod.rs:3:
test	Check formatting	2026-02-11T05:41:36.3283681Z  mod resource_detect;
test	Check formatting	2026-02-11T05:41:36.3283810Z  mod resource_validator;
test	Check formatting	2026-02-11T05:41:36.3283918Z  
test	Check formatting	2026-02-11T05:41:36.3284204Z -pub use device_detect::{DeviceInfo, DeviceType, detect_devices};
test	Check formatting	2026-02-11T05:41:36.3284370Z -pub use priority::select_best_device;
test	Check formatting	2026-02-11T05:41:36.3284726Z -pub use resource_detect::{SystemResources, GpuResource, detect_system_resources};
test	Check formatting	2026-02-11T05:41:36.3285021Z -pub use resource_validator::{ValidationResult, validate_model_load};
test	Check formatting	2026-02-11T05:41:36.3285254Z  pub use crate::config::{DevicePreference, ResourceMode};
test	Check formatting	2026-02-11T05:41:36.3285526Z +pub use device_detect::{detect_devices, DeviceInfo, DeviceType};
test	Check formatting	2026-02-11T05:41:36.3285694Z +pub use priority::select_best_device;
test	Check formatting	2026-02-11T05:41:36.3286061Z +pub use resource_detect::{detect_system_resources, GpuResource, SystemResources};
test	Check formatting	2026-02-11T05:41:36.3286341Z +pub use resource_validator::{validate_model_load, ValidationResult};
test	Check formatting	2026-02-11T05:41:36.3286442Z  
test	Check formatting	2026-02-11T05:41:36.3288577Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:1:
test	Check formatting	2026-02-11T05:41:36.3290322Z -use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3292098Z  use super::DeviceType;
test	Check formatting	2026-02-11T05:41:36.3294291Z +use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3296164Z  use sysinfo::System;
test	Check formatting	2026-02-11T05:41:36.3297956Z  
test	Check formatting	2026-02-11T05:41:36.3299829Z  #[derive(Debug, Clone)]
test	Check formatting	2026-02-11T05:41:36.3301981Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:60:
test	Check formatting	2026-02-11T05:41:36.3304021Z  
test	Check formatting	2026-02-11T05:41:36.3305901Z          if let (Ok(total_str), Ok(used_str)) = (
test	Check formatting	2026-02-11T05:41:36.3307635Z              std::fs::read_to_string(&total_path),
test	Check formatting	2026-02-11T05:41:36.3309018Z -            std::fs::read_to_string(&used_path)
test	Check formatting	2026-02-11T05:41:36.3310777Z +            std::fs::read_to_string(&used_path),
test	Check formatting	2026-02-11T05:41:36.3311040Z          ) {
test	Check formatting	2026-02-11T05:41:36.3311339Z              if let (Ok(total_bytes), Ok(used_bytes)) = (
test	Check formatting	2026-02-11T05:41:36.3311621Z                  total_str.trim().parse::<u64>(),
test	Check formatting	2026-02-11T05:41:36.3312078Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:67:
test	Check formatting	2026-02-11T05:41:36.3312335Z -                used_str.trim().parse::<u64>()
test	Check formatting	2026-02-11T05:41:36.3312606Z +                used_str.trim().parse::<u64>(),
test	Check formatting	2026-02-11T05:41:36.3313265Z              ) {
test	Check formatting	2026-02-11T05:41:36.3313520Z                  return vec![GpuResource {
test	Check formatting	2026-02-11T05:41:36.3313789Z                      name: "Intel GPU".to_string(),
test	Check formatting	2026-02-11T05:41:36.3314257Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:89:
test	Check formatting	2026-02-11T05:41:36.3314463Z  
test	Check formatting	2026-02-11T05:41:36.3314703Z      for card in 0..10 {
test	Check formatting	2026-02-11T05:41:36.3315081Z          let vendor_path = format!("/sys/class/drm/card{}/device/vendor", card);
test	Check formatting	2026-02-11T05:41:36.3315269Z -        
test	Check formatting	2026-02-11T05:41:36.3315448Z +
test	Check formatting	2026-02-11T05:41:36.3315710Z          // Check if this is an Intel GPU (vendor 0x8086)
test	Check formatting	2026-02-11T05:41:36.3316020Z          if let Ok(vendor) = std::fs::read_to_string(&vendor_path) {
test	Check formatting	2026-02-11T05:41:36.3316256Z              if !vendor.trim().contains("0x8086") {
test	Check formatting	2026-02-11T05:41:36.3316672Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:112:
test	Check formatting	2026-02-11T05:41:36.3316851Z              .ok()
test	Check formatting	2026-02-11T05:41:36.3317123Z              .and_then(|s| s.trim().parse::<u32>().ok())
test	Check formatting	2026-02-11T05:41:36.3317314Z              .unwrap_or(0);
test	Check formatting	2026-02-11T05:41:36.3317503Z -        
test	Check formatting	2026-02-11T05:41:36.3317778Z +
test	Check formatting	2026-02-11T05:41:36.3318190Z          let max_freq = std::fs::read_to_string(format!("{}/rp0_freq", freq_path))
test	Check formatting	2026-02-11T05:41:36.3318405Z              .ok()
test	Check formatting	2026-02-11T05:41:36.3318929Z              .and_then(|s| s.trim().parse::<u32>().ok())
test	Check formatting	2026-02-11T05:41:36.3319408Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:127:
test	Check formatting	2026-02-11T05:41:36.3319610Z              .ok()
test	Check formatting	2026-02-11T05:41:36.3319852Z              .map(|s| s.trim().to_string())
test	Check formatting	2026-02-11T05:41:36.3320087Z              .unwrap_or_default();
test	Check formatting	2026-02-11T05:41:36.3320290Z -        
test	Check formatting	2026-02-11T05:41:36.3320494Z +
test	Check formatting	2026-02-11T05:41:36.3320783Z          let gpu_name = get_intel_gpu_name(&device_id);
test	Check formatting	2026-02-11T05:41:36.3320981Z  
test	Check formatting	2026-02-11T05:41:36.3321274Z          // Try to read explicit VRAM info (Discrete GPU)
test	Check formatting	2026-02-11T05:41:36.3321748Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:138:
test	Check formatting	2026-02-11T05:41:36.3321992Z          let mut gpu_available = 0;
test	Check formatting	2026-02-11T05:41:36.3322229Z          let mut found_vram = false;
test	Check formatting	2026-02-11T05:41:36.3322425Z  
test	Check formatting	2026-02-11T05:41:36.3323212Z -        if let (Ok(t_str), Ok(u_str)) = (std::fs::read_to_string(&total_vram_path), std::fs::read_to_string(&used_vram_path)) {
test	Check formatting	2026-02-11T05:41:36.3323501Z +        if let (Ok(t_str), Ok(u_str)) = (
test	Check formatting	2026-02-11T05:41:36.3323789Z +            std::fs::read_to_string(&total_vram_path),
test	Check formatting	2026-02-11T05:41:36.3324072Z +            std::fs::read_to_string(&used_vram_path),
test	Check formatting	2026-02-11T05:41:36.3324284Z +        ) {
test	Check formatting	2026-02-11T05:41:36.3324727Z              if let (Ok(t), Ok(u)) = (t_str.trim().parse::<u64>(), u_str.trim().parse::<u64>()) {
test	Check formatting	2026-02-11T05:41:36.3324954Z                  gpu_total = t;
test	Check formatting	2026-02-11T05:41:36.3325226Z                  gpu_available = t.saturating_sub(u);
test	Check formatting	2026-02-11T05:41:36.3325673Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:151:
test	Check formatting	2026-02-11T05:41:36.3325888Z              // Re-read fresh memory values
test	Check formatting	2026-02-11T05:41:36.3326135Z              let mut fresh_sys = System::new_all();
test	Check formatting	2026-02-11T05:41:36.3326350Z              fresh_sys.refresh_memory();
test	Check formatting	2026-02-11T05:41:36.3326523Z -            
test	Check formatting	2026-02-11T05:41:36.3326707Z +
test	Check formatting	2026-02-11T05:41:36.3326949Z              let total_ram = fresh_sys.total_memory();
test	Check formatting	2026-02-11T05:41:36.3327385Z              let available_ram = fresh_sys.available_memory();
test	Check formatting	2026-02-11T05:41:36.3328549Z  
test	Check formatting	2026-02-11T05:41:36.3328953Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:183:
test	Check formatting	2026-02-11T05:41:36.3329096Z      use std::time::Instant;
test	Check formatting	2026-02-11T05:41:36.3329194Z  
test	Check formatting	2026-02-11T05:41:36.3329500Z      let idle_residency_path = format!("{}/idle_residency_ms", gtidle_path);
test	Check formatting	2026-02-11T05:41:36.3329609Z -    
test	Check formatting	2026-02-11T05:41:36.3329706Z +
test	Check formatting	2026-02-11T05:41:36.3329845Z      // Read initial idle residency
test	Check formatting	2026-02-11T05:41:36.3330354Z      let idle1 = std::fs::read_to_string(&idle_residency_path)
test	Check formatting	2026-02-11T05:41:36.3330464Z          .ok()
test	Check formatting	2026-02-11T05:41:36.3330835Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:195:
test	Check formatting	2026-02-11T05:41:36.3330932Z  
test	Check formatting	2026-02-11T05:41:36.3331073Z      let idle1 = idle1.unwrap();
test	Check formatting	2026-02-11T05:41:36.3331200Z      let start = Instant::now();
test	Check formatting	2026-02-11T05:41:36.3331303Z -    
test	Check formatting	2026-02-11T05:41:36.3331409Z +
test	Check formatting	2026-02-11T05:41:36.3331548Z      // Short sleep to measure delta
test	Check formatting	2026-02-11T05:41:36.3331727Z      thread::sleep(Duration::from_millis(50));
test	Check formatting	2026-02-11T05:41:36.3331830Z -    
test	Check formatting	2026-02-11T05:41:36.3331935Z +
test	Check formatting	2026-02-11T05:41:36.3332150Z      let elapsed_ms = start.elapsed().as_millis() as u64;
test	Check formatting	2026-02-11T05:41:36.3332244Z  
test	Check formatting	2026-02-11T05:41:36.3332387Z      // Read second idle residency
test	Check formatting	2026-02-11T05:41:36.3332762Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:208:
test	Check formatting	2026-02-11T05:41:36.3333062Z          .unwrap_or(idle1);
test	Check formatting	2026-02-11T05:41:36.3333177Z  
test	Check formatting	2026-02-11T05:41:36.3333365Z      let idle_delta = idle2.saturating_sub(idle1);
test	Check formatting	2026-02-11T05:41:36.3333466Z -    
test	Check formatting	2026-02-11T05:41:36.3333566Z +
test	Check formatting	2026-02-11T05:41:36.3333701Z      if elapsed_ms == 0 {
test	Check formatting	2026-02-11T05:41:36.3333813Z          return 0.0;
test	Check formatting	2026-02-11T05:41:36.3333914Z      }
test	Check formatting	2026-02-11T05:41:36.3334277Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_detect.rs:275:
test	Check formatting	2026-02-11T05:41:36.3334736Z  fn detect_intel_gpu_via_clinfo() -> Option<GpuResource> {
test	Check formatting	2026-02-11T05:41:36.3334883Z      use std::process::Command;
test	Check formatting	2026-02-11T05:41:36.3334984Z  
test	Check formatting	2026-02-11T05:41:36.3335135Z -    let output = Command::new("clinfo")
test	Check formatting	2026-02-11T05:41:36.3335243Z -        .output()
test	Check formatting	2026-02-11T05:41:36.3335347Z -        .ok()?;
test	Check formatting	2026-02-11T05:41:36.3335553Z +    let output = Command::new("clinfo").output().ok()?;
test	Check formatting	2026-02-11T05:41:36.3335658Z  
test	Check formatting	2026-02-11T05:41:36.3335800Z      if !output.status.success() {
test	Check formatting	2026-02-11T05:41:36.3335914Z          return None;
test	Check formatting	2026-02-11T05:41:36.3336300Z Diff in /home/runner/work/capi/capi/capi-core/src/hardware/resource_validator.rs:1:
test	Check formatting	2026-02-11T05:41:36.3336478Z +use super::{ResourceMode, SystemResources};
test	Check formatting	2026-02-11T05:41:36.3336600Z  use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3336769Z -use super::{SystemResources, ResourceMode};
test	Check formatting	2026-02-11T05:41:36.3336879Z  
test	Check formatting	2026-02-11T05:41:36.3337002Z  #[derive(Debug, Clone)]
test	Check formatting	2026-02-11T05:41:36.3337141Z  pub enum ValidationResult {
test	Check formatting	2026-02-11T05:41:36.3337500Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/metrics.rs:41:
test	Check formatting	2026-02-11T05:41:36.3337600Z  
test	Check formatting	2026-02-11T05:41:36.3337831Z      /// Get generation duration as (mean, std) in milliseconds.
test	Check formatting	2026-02-11T05:41:36.3338015Z      pub fn generate_duration(&self) -> (f32, f32) {
test	Check formatting	2026-02-11T05:41:36.3338327Z -        (self.data.generate_duration_mean, self.data.generate_duration_std)
test	Check formatting	2026-02-11T05:41:36.3338429Z +        (
test	Check formatting	2026-02-11T05:41:36.3338586Z +            self.data.generate_duration_mean,
test	Check formatting	2026-02-11T05:41:36.3338747Z +            self.data.generate_duration_std,
test	Check formatting	2026-02-11T05:41:36.3338852Z +        )
test	Check formatting	2026-02-11T05:41:36.3338949Z      }
test	Check formatting	2026-02-11T05:41:36.3339047Z  }
test	Check formatting	2026-02-11T05:41:36.3339145Z  
test	Check formatting	2026-02-11T05:41:36.3339468Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/mod.rs:3:
test	Check formatting	2026-02-11T05:41:36.3339774Z  //! This module provides Rust wrappers for the OpenVINO GenAI C++ library
test	Check formatting	2026-02-11T05:41:36.3339919Z  //! using cxx for safe FFI.
test	Check formatting	2026-02-11T05:41:36.3340019Z  
test	Check formatting	2026-02-11T05:41:36.3340131Z -mod pipeline;
test	Check formatting	2026-02-11T05:41:36.3340243Z  mod config;
test	Check formatting	2026-02-11T05:41:36.3340350Z  mod metrics;
test	Check formatting	2026-02-11T05:41:36.3340461Z +mod pipeline;
test	Check formatting	2026-02-11T05:41:36.3340560Z  
test	Check formatting	2026-02-11T05:41:36.3340774Z -pub use pipeline::{LLMPipeline, GenerationResult};
test	Check formatting	2026-02-11T05:41:36.3340925Z  pub use config::GenerationConfig;
test	Check formatting	2026-02-11T05:41:36.3341069Z  pub use metrics::PerfMetrics;
test	Check formatting	2026-02-11T05:41:36.3341277Z +pub use pipeline::{GenerationResult, LLMPipeline};
test	Check formatting	2026-02-11T05:41:36.3341379Z  
test	Check formatting	2026-02-11T05:41:36.3341502Z  use thiserror::Error;
test	Check formatting	2026-02-11T05:41:36.3341801Z  
test	Check formatting	2026-02-11T05:41:36.3342166Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/pipeline.rs:1:
test	Check formatting	2026-02-11T05:41:36.3342332Z  //! LLM Pipeline wrapper for OpenVINO GenAI.
test	Check formatting	2026-02-11T05:41:36.3342430Z  
test	Check formatting	2026-02-11T05:41:36.3342703Z -use super::{GenAIError, Result, GenerationConfig, PerfMetrics};
test	Check formatting	2026-02-11T05:41:36.3343145Z +use super::{GenAIError, GenerationConfig, PerfMetrics, Result};
test	Check formatting	2026-02-11T05:41:36.3343328Z  use crate::genai_bridge::{ffi, StreamerCallback};
test	Check formatting	2026-02-11T05:41:36.3343441Z  use cxx::UniquePtr;
test	Check formatting	2026-02-11T05:41:36.3343541Z  
test	Check formatting	2026-02-11T05:41:36.3343890Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/pipeline.rs:26:
test	Check formatting	2026-02-11T05:41:36.3344100Z      /// * `device` - Device to use (e.g., "CPU", "GPU", "NPU")
test	Check formatting	2026-02-11T05:41:36.3344338Z      pub fn new(model_path: &str, device: &str) -> Result<Self> {
test	Check formatting	2026-02-11T05:41:36.3344549Z          let inner = ffi::create_pipeline(model_path, device);
test	Check formatting	2026-02-11T05:41:36.3344656Z -        
test	Check formatting	2026-02-11T05:41:36.3344756Z +
test	Check formatting	2026-02-11T05:41:36.3344874Z          if inner.is_null() {
test	Check formatting	2026-02-11T05:41:36.3345052Z              return Err(GenAIError::PipelineCreation);
test	Check formatting	2026-02-11T05:41:36.3345147Z          }
test	Check formatting	2026-02-11T05:41:36.3345498Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/pipeline.rs:42:
test	Check formatting	2026-02-11T05:41:36.3345796Z      pub fn generate(&self, prompt: &str, max_tokens: usize) -> Result<String> {
test	Check formatting	2026-02-11T05:41:36.3346153Z          let mut config = GenerationConfig::new()?;
test	Check formatting	2026-02-11T05:41:36.3346315Z          config.set_max_new_tokens(max_tokens)?;
test	Check formatting	2026-02-11T05:41:36.3346418Z -        
test	Check formatting	2026-02-11T05:41:36.3346516Z +
test	Check formatting	2026-02-11T05:41:36.3346823Z          let text = ffi::pipeline_generate(&self.inner, prompt, config.inner());
test	Check formatting	2026-02-11T05:41:36.3346935Z          Ok(text)
test	Check formatting	2026-02-11T05:41:36.3347035Z      }
test	Check formatting	2026-02-11T05:41:36.3347383Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/pipeline.rs:54:
test	Check formatting	2026-02-11T05:41:36.3347490Z      }
test	Check formatting	2026-02-11T05:41:36.3347595Z  
test	Check formatting	2026-02-11T05:41:36.3347778Z      /// Generate text and return performance metrics.
test	Check formatting	2026-02-11T05:41:36.3348231Z -    pub fn generate_with_metrics(&self, prompt: &str, max_tokens: usize) -> Result<GenerationResult> {
test	Check formatting	2026-02-11T05:41:36.3348369Z +    pub fn generate_with_metrics(
test	Check formatting	2026-02-11T05:41:36.3348472Z +        &self,
test	Check formatting	2026-02-11T05:41:36.3348598Z +        prompt: &str,
test	Check formatting	2026-02-11T05:41:36.3348722Z +        max_tokens: usize,
test	Check formatting	2026-02-11T05:41:36.3348861Z +    ) -> Result<GenerationResult> {
test	Check formatting	2026-02-11T05:41:36.3349035Z          let mut config = GenerationConfig::new()?;
test	Check formatting	2026-02-11T05:41:36.3349199Z          config.set_max_new_tokens(max_tokens)?;
test	Check formatting	2026-02-11T05:41:36.3349301Z -        
test	Check formatting	2026-02-11T05:41:36.3349399Z +
test	Check formatting	2026-02-11T05:41:36.3349805Z          let result = ffi::pipeline_generate_with_metrics(&self.inner, prompt, config.inner());
test	Check formatting	2026-02-11T05:41:36.3349917Z -        
test	Check formatting	2026-02-11T05:41:36.3350011Z +
test	Check formatting	2026-02-11T05:41:36.3350140Z          Ok(GenerationResult {
test	Check formatting	2026-02-11T05:41:36.3350283Z              text: result.text,
test	Check formatting	2026-02-11T05:41:36.3350496Z              metrics: PerfMetrics::from_data(result.metrics),
test	Check formatting	2026-02-11T05:41:36.3350857Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/pipeline.rs:83:
test	Check formatting	2026-02-11T05:41:36.3350970Z      {
test	Check formatting	2026-02-11T05:41:36.3351156Z          let mut config = GenerationConfig::new()?;
test	Check formatting	2026-02-11T05:41:36.3351326Z          config.set_max_new_tokens(max_tokens)?;
test	Check formatting	2026-02-11T05:41:36.3351429Z -        
test	Check formatting	2026-02-11T05:41:36.3351537Z +
test	Check formatting	2026-02-11T05:41:36.3351692Z          let mut streamer = StreamerCallback {
test	Check formatting	2026-02-11T05:41:36.3351823Z              cb: Box::new(callback),
test	Check formatting	2026-02-11T05:41:36.3351958Z              buffer: Vec::new(),
test	Check formatting	2026-02-11T05:41:36.3352314Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/pipeline.rs:90:
test	Check formatting	2026-02-11T05:41:36.3352416Z          };
test	Check formatting	2026-02-11T05:41:36.3352519Z  
test	Check formatting	2026-02-11T05:41:36.3353161Z -        let result = ffi::pipeline_generate_stream(&self.inner, prompt, config.inner(), &mut streamer);
test	Check formatting	2026-02-11T05:41:36.3353455Z -        
test	Check formatting	2026-02-11T05:41:36.3353565Z +        let result =
test	Check formatting	2026-02-11T05:41:36.3353963Z +            ffi::pipeline_generate_stream(&self.inner, prompt, config.inner(), &mut streamer);
test	Check formatting	2026-02-11T05:41:36.3354066Z +
test	Check formatting	2026-02-11T05:41:36.3354200Z          Ok(GenerationResult {
test	Check formatting	2026-02-11T05:41:36.3354328Z              text: result.text,
test	Check formatting	2026-02-11T05:41:36.3354561Z              metrics: PerfMetrics::from_data(result.metrics),
test	Check formatting	2026-02-11T05:41:36.3354935Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/genai/pipeline.rs:112:
test	Check formatting	2026-02-11T05:41:36.3355065Z              buffer: Vec::new(),
test	Check formatting	2026-02-11T05:41:36.3355171Z          };
test	Check formatting	2026-02-11T05:41:36.3355266Z  
test	Check formatting	2026-02-11T05:41:36.3355730Z -        let result = ffi::pipeline_generate_stream(&self.inner, prompt, config.inner(), &mut streamer);
test	Check formatting	2026-02-11T05:41:36.3355844Z -        
test	Check formatting	2026-02-11T05:41:36.3355961Z +        let result =
test	Check formatting	2026-02-11T05:41:36.3356365Z +            ffi::pipeline_generate_stream(&self.inner, prompt, config.inner(), &mut streamer);
test	Check formatting	2026-02-11T05:41:36.3356476Z +
test	Check formatting	2026-02-11T05:41:36.3356617Z          Ok(GenerationResult {
test	Check formatting	2026-02-11T05:41:36.3356739Z              text: result.text,
test	Check formatting	2026-02-11T05:41:36.3356955Z              metrics: PerfMetrics::from_data(result.metrics),
test	Check formatting	2026-02-11T05:41:36.3357260Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/mod.rs:1:
test	Check formatting	2026-02-11T05:41:36.3357561Z -mod session;
test	Check formatting	2026-02-11T05:41:36.3357677Z  pub mod genai;
test	Check formatting	2026-02-11T05:41:36.3357786Z +mod session;
test	Check formatting	2026-02-11T05:41:36.3357890Z  
test	Check formatting	2026-02-11T05:41:36.3358122Z -pub use session::{InferenceSession, InferenceMetrics};
test	Check formatting	2026-02-11T05:41:36.3358341Z +pub use session::{InferenceMetrics, InferenceSession};
test	Check formatting	2026-02-11T05:41:36.3358444Z  
test	Check formatting	2026-02-11T05:41:36.3359139Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:1:
test	Check formatting	2026-02-11T05:41:36.3359416Z  use super::genai::LLMPipeline;
test	Check formatting	2026-02-11T05:41:36.3359555Z -use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3359686Z -use std::path::Path;
test	Check formatting	2026-02-11T05:41:36.3360064Z -use crate::hardware::{detect_system_resources, validate_model_load, ValidationResult};
test	Check formatting	2026-02-11T05:41:36.3360286Z  use crate::config::Config;
test	Check formatting	2026-02-11T05:41:36.3360653Z +use crate::hardware::{detect_system_resources, validate_model_load, ValidationResult};
test	Check formatting	2026-02-11T05:41:36.3360883Z  use crate::model_manager::ModelLock;
test	Check formatting	2026-02-11T05:41:36.3361018Z +use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3361148Z +use std::path::Path;
test	Check formatting	2026-02-11T05:41:36.3361244Z  
test	Check formatting	2026-02-11T05:41:36.3361480Z  pub struct InferenceMetrics {
test	Check formatting	2026-02-11T05:41:36.3361621Z      pub tokens_per_second: f32,
test	Check formatting	2026-02-11T05:41:36.3361928Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:27:
test	Check formatting	2026-02-11T05:41:36.3362160Z          } else if model_path.is_dir() {
test	Check formatting	2026-02-11T05:41:36.3362279Z              model_path
test	Check formatting	2026-02-11T05:41:36.3362386Z          } else {
test	Check formatting	2026-02-11T05:41:36.3362516Z -            model_path.parent()
test	Check formatting	2026-02-11T05:41:36.3362632Z +            model_path
test	Check formatting	2026-02-11T05:41:36.3362962Z +                .parent()
test	Check formatting	2026-02-11T05:41:36.3363204Z                  .ok_or_else(|| anyhow::anyhow!("Invalid model path"))?
test	Check formatting	2026-02-11T05:41:36.3364774Z          };
test	Check formatting	2026-02-11T05:41:36.3366468Z  
test	Check formatting	2026-02-11T05:41:36.3368413Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:37:
test	Check formatting	2026-02-11T05:41:36.3370230Z              let config = Config::load()?;
test	Check formatting	2026-02-11T05:41:36.3399666Z  
test	Check formatting	2026-02-11T05:41:36.3400103Z              if let Ok(resources) = detect_system_resources() {
test	Check formatting	2026-02-11T05:41:36.3400700Z -                match validate_model_load(estimated_memory, device, &resources, &config.resource_mode)? {
test	Check formatting	2026-02-11T05:41:36.3401003Z -                    ValidationResult::Sufficient => {},
test	Check formatting	2026-02-11T05:41:36.3401250Z +                match validate_model_load(
test	Check formatting	2026-02-11T05:41:36.3401488Z +                    estimated_memory,
test	Check formatting	2026-02-11T05:41:36.3401700Z +                    device,
test	Check formatting	2026-02-11T05:41:36.3401908Z +                    &resources,
test	Check formatting	2026-02-11T05:41:36.3402135Z +                    &config.resource_mode,
test	Check formatting	2026-02-11T05:41:36.3402573Z +                )? {
test	Check formatting	2026-02-11T05:41:36.3403066Z +                    ValidationResult::Sufficient => {}
test	Check formatting	2026-02-11T05:41:36.3403402Z                      ValidationResult::Warning { message } => {
test	Check formatting	2026-02-11T05:41:36.3414324Z                          eprintln!("\nWarning: {}", message);
test	Check formatting	2026-02-11T05:41:36.3414997Z                          eprintln!("This may cause OOM errors or system instability.");
test	Check formatting	2026-02-11T05:41:36.3416037Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:46:
test	Check formatting	2026-02-11T05:41:36.3416739Z                          if matches!(config.resource_mode, crate::hardware::ResourceMode::Loose) {
test	Check formatting	2026-02-11T05:41:36.3417962Z                              eprintln!("Warning: Resource mode is Loose. Continuing despite potential memory pressure.");
test	Check formatting	2026-02-11T05:41:36.3418389Z                          }
test	Check formatting	2026-02-11T05:41:36.3419134Z -                    },
test	Check formatting	2026-02-11T05:41:36.3419485Z +                    }
test	Check formatting	2026-02-11T05:41:36.3420300Z                      ValidationResult::Insufficient { message } => {
test	Check formatting	2026-02-11T05:41:36.3420674Z                          return Err(anyhow::anyhow!(
test	Check formatting	2026-02-11T05:41:36.3421503Z                              "Insufficient memory to load model\n\n{}\n\nSuggestions:\n\
test	Check formatting	2026-02-11T05:41:36.3422147Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:56:
test	Check formatting	2026-02-11T05:41:36.3423537Z                              - Change resource mode: capi config set-resource-mode loose",
test	Check formatting	2026-02-11T05:41:36.3424023Z                              message
test	Check formatting	2026-02-11T05:41:36.3424753Z                          ));
test	Check formatting	2026-02-11T05:41:36.3425091Z -                    },
test	Check formatting	2026-02-11T05:41:36.3425811Z +                    }
test	Check formatting	2026-02-11T05:41:36.3426155Z                  }
test	Check formatting	2026-02-11T05:41:36.3426844Z              }
test	Check formatting	2026-02-11T05:41:36.3427204Z          }
test	Check formatting	2026-02-11T05:41:36.3428136Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:63:
test	Check formatting	2026-02-11T05:41:36.3428925Z  
test	Check formatting	2026-02-11T05:41:36.3429393Z -        let pipeline = LLMPipeline::new(
test	Check formatting	2026-02-11T05:41:36.3430133Z -            path_to_use.to_str().unwrap(),
test	Check formatting	2026-02-11T05:41:36.3430499Z -            device,
test	Check formatting	2026-02-11T05:41:36.3431272Z -        ).map_err(|e| anyhow::anyhow!("Failed to create pipeline: {}", e))?;
test	Check formatting	2026-02-11T05:41:36.3433263Z +        let pipeline = LLMPipeline::new(path_to_use.to_str().unwrap(), device)
test	Check formatting	2026-02-11T05:41:36.3434421Z +            .map_err(|e| anyhow::anyhow!("Failed to create pipeline: {}", e))?;
test	Check formatting	2026-02-11T05:41:36.3435294Z  
test	Check formatting	2026-02-11T05:41:36.3436164Z          Ok(Self {
test	Check formatting	2026-02-11T05:41:36.3437044Z              pipeline,
test	Check formatting	2026-02-11T05:41:36.3439106Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:82:
test	Check formatting	2026-02-11T05:41:36.3439592Z          } else if model_path.is_dir() {
test	Check formatting	2026-02-11T05:41:36.3440215Z              model_path
test	Check formatting	2026-02-11T05:41:36.3441749Z          } else {
test	Check formatting	2026-02-11T05:41:36.3464699Z -            model_path.parent()
test	Check formatting	2026-02-11T05:41:36.3464836Z +            model_path
test	Check formatting	2026-02-11T05:41:36.3464970Z +                .parent()
test	Check formatting	2026-02-11T05:41:36.3465241Z                  .ok_or_else(|| anyhow::anyhow!("Invalid model path"))?
test	Check formatting	2026-02-11T05:41:36.3465352Z          };
test	Check formatting	2026-02-11T05:41:36.3465453Z  
test	Check formatting	2026-02-11T05:41:36.3465790Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:91:
test	Check formatting	2026-02-11T05:41:36.3465951Z              let config = Config::load()?;
test	Check formatting	2026-02-11T05:41:36.3466059Z  
test	Check formatting	2026-02-11T05:41:36.3466258Z              if let Ok(resources) = detect_system_resources() {
test	Check formatting	2026-02-11T05:41:36.3466739Z -                match validate_model_load(estimated_memory, device, &resources, &config.resource_mode)? {
test	Check formatting	2026-02-11T05:41:36.3466929Z -                    ValidationResult::Sufficient => {},
test	Check formatting	2026-02-11T05:41:36.3467067Z +                match validate_model_load(
test	Check formatting	2026-02-11T05:41:36.3467201Z +                    estimated_memory,
test	Check formatting	2026-02-11T05:41:36.3467317Z +                    device,
test	Check formatting	2026-02-11T05:41:36.3467437Z +                    &resources,
test	Check formatting	2026-02-11T05:41:36.3467800Z +                    &config.resource_mode,
test	Check formatting	2026-02-11T05:41:36.3467911Z +                )? {
test	Check formatting	2026-02-11T05:41:36.3468083Z +                    ValidationResult::Sufficient => {}
test	Check formatting	2026-02-11T05:41:36.3468278Z                      ValidationResult::Warning { message } => {
test	Check formatting	2026-02-11T05:41:36.3468469Z                          eprintln!("\nWarning: {}", message);
test	Check formatting	2026-02-11T05:41:36.3468772Z                          eprintln!("This may cause OOM errors or system instability.");
test	Check formatting	2026-02-11T05:41:36.3469106Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:100:
test	Check formatting	2026-02-11T05:41:36.3469494Z                          if matches!(config.resource_mode, crate::hardware::ResourceMode::Loose) {
test	Check formatting	2026-02-11T05:41:36.3469993Z                              eprintln!("Warning: Resource mode is Loose. Continuing despite potential memory pressure.");
test	Check formatting	2026-02-11T05:41:36.3470102Z                          }
test	Check formatting	2026-02-11T05:41:36.3470209Z -                    },
test	Check formatting	2026-02-11T05:41:36.3470323Z +                    }
test	Check formatting	2026-02-11T05:41:36.3470556Z                      ValidationResult::Insufficient { message } => {
test	Check formatting	2026-02-11T05:41:36.3470721Z                          return Err(anyhow::anyhow!(
test	Check formatting	2026-02-11T05:41:36.3471021Z                              "Insufficient memory to load model\n\n{}\n\nSuggestions:\n\
test	Check formatting	2026-02-11T05:41:36.3471344Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:110:
test	Check formatting	2026-02-11T05:41:36.3471875Z                              - Change resource mode: capi config set-resource-mode loose",
test	Check formatting	2026-02-11T05:41:36.3472003Z                              message
test	Check formatting	2026-02-11T05:41:36.3472115Z                          ));
test	Check formatting	2026-02-11T05:41:36.3472224Z -                    },
test	Check formatting	2026-02-11T05:41:36.3472328Z +                    }
test	Check formatting	2026-02-11T05:41:36.3472439Z                  }
test	Check formatting	2026-02-11T05:41:36.3472540Z              }
test	Check formatting	2026-02-11T05:41:36.3472646Z          }
test	Check formatting	2026-02-11T05:41:36.3473184Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:117:
test	Check formatting	2026-02-11T05:41:36.3473295Z  
test	Check formatting	2026-02-11T05:41:36.3473791Z -        println!("Calling LLMPipeline::new with path: {} and device: {}", path_to_use.to_str().unwrap(), device);
test	Check formatting	2026-02-11T05:41:36.3473941Z -        let pipeline = LLMPipeline::new(
test	Check formatting	2026-02-11T05:41:36.3474056Z +        println!(
test	Check formatting	2026-02-11T05:41:36.3474303Z +            "Calling LLMPipeline::new with path: {} and device: {}",
test	Check formatting	2026-02-11T05:41:36.3474450Z              path_to_use.to_str().unwrap(),
test	Check formatting	2026-02-11T05:41:36.3474556Z -            device,
test	Check formatting	2026-02-11T05:41:36.3474664Z -        ).map_err(|e| {
test	Check formatting	2026-02-11T05:41:36.3474759Z +            device
test	Check formatting	2026-02-11T05:41:36.3474856Z +        );
test	Check formatting	2026-02-11T05:41:36.3475225Z +        let pipeline = LLMPipeline::new(path_to_use.to_str().unwrap(), device).map_err(|e| {
test	Check formatting	2026-02-11T05:41:36.3475402Z              println!("LLMPipeline::new failed: {}", e);
test	Check formatting	2026-02-11T05:41:36.3475600Z              anyhow::anyhow!("Failed to create pipeline: {}", e)
test	Check formatting	2026-02-11T05:41:36.3475710Z          })?;
test	Check formatting	2026-02-11T05:41:36.3476030Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:134:
test	Check formatting	2026-02-11T05:41:36.3476141Z      }
test	Check formatting	2026-02-11T05:41:36.3476252Z  
test	Check formatting	2026-02-11T05:41:36.3476431Z      pub fn start_chat(&mut self) -> Result<()> {
test	Check formatting	2026-02-11T05:41:36.3476578Z -        self.pipeline.start_chat()
test	Check formatting	2026-02-11T05:41:36.3476699Z +        self.pipeline
test	Check formatting	2026-02-11T05:41:36.3476830Z +            .start_chat()
test	Check formatting	2026-02-11T05:41:36.3477101Z              .map_err(|e| anyhow::anyhow!("Failed to start chat: {}", e))?;
test	Check formatting	2026-02-11T05:41:36.3477240Z          self.in_chat_mode = true;
test	Check formatting	2026-02-11T05:41:36.3477354Z          Ok(())
test	Check formatting	2026-02-11T05:41:36.3477680Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:141:
test	Check formatting	2026-02-11T05:41:36.3477785Z      }
test	Check formatting	2026-02-11T05:41:36.3477898Z  
test	Check formatting	2026-02-11T05:41:36.3478077Z      pub fn finish_chat(&mut self) -> Result<()> {
test	Check formatting	2026-02-11T05:41:36.3478222Z -        self.pipeline.finish_chat()
test	Check formatting	2026-02-11T05:41:36.3478342Z +        self.pipeline
test	Check formatting	2026-02-11T05:41:36.3478474Z +            .finish_chat()
test	Check formatting	2026-02-11T05:41:36.3478976Z              .map_err(|e| anyhow::anyhow!("Failed to finish chat: {}", e))?;
test	Check formatting	2026-02-11T05:41:36.3479102Z          self.in_chat_mode = false;
test	Check formatting	2026-02-11T05:41:36.3479214Z          Ok(())
test	Check formatting	2026-02-11T05:41:36.3479554Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:148:
test	Check formatting	2026-02-11T05:41:36.3479661Z      }
test	Check formatting	2026-02-11T05:41:36.3479767Z  
test	Check formatting	2026-02-11T05:41:36.3480104Z      pub fn generate(&mut self, prompt: &str, max_tokens: usize) -> Result<String> {
test	Check formatting	2026-02-11T05:41:36.3480333Z -        let text = self.pipeline.generate(prompt, max_tokens)
test	Check formatting	2026-02-11T05:41:36.3480458Z +        let text = self
test	Check formatting	2026-02-11T05:41:36.3480583Z +            .pipeline
test	Check formatting	2026-02-11T05:41:36.3480727Z +            .generate(prompt, max_tokens)
test	Check formatting	2026-02-11T05:41:36.3480973Z              .map_err(|e| anyhow::anyhow!("Generation failed: {}", e))?;
test	Check formatting	2026-02-11T05:41:36.3481068Z -        
test	Check formatting	2026-02-11T05:41:36.3481556Z -        self.context_tokens = self.pipeline.count_tokens(prompt) + self.pipeline.count_tokens(&text);
test	Check formatting	2026-02-11T05:41:36.3481671Z +
test	Check formatting	2026-02-11T05:41:36.3481790Z +        self.context_tokens =
test	Check formatting	2026-02-11T05:41:36.3482117Z +            self.pipeline.count_tokens(prompt) + self.pipeline.count_tokens(&text);
test	Check formatting	2026-02-11T05:41:36.3482219Z          Ok(text)
test	Check formatting	2026-02-11T05:41:36.3482314Z      }
test	Check formatting	2026-02-11T05:41:36.3482416Z  
test	Check formatting	2026-02-11T05:41:36.3482730Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:158:
test	Check formatting	2026-02-11T05:41:36.3503812Z -    pub fn generate_with_metrics(&mut self, prompt: &str, max_tokens: usize) -> Result<(String, InferenceMetrics)> {
test	Check formatting	2026-02-11T05:41:36.3504149Z -        let result = self.pipeline.generate_with_metrics(prompt, max_tokens)
test	Check formatting	2026-02-11T05:41:36.3504309Z +    pub fn generate_with_metrics(
test	Check formatting	2026-02-11T05:41:36.3504430Z +        &mut self,
test	Check formatting	2026-02-11T05:41:36.3504553Z +        prompt: &str,
test	Check formatting	2026-02-11T05:41:36.3504691Z +        max_tokens: usize,
test	Check formatting	2026-02-11T05:41:36.3504864Z +    ) -> Result<(String, InferenceMetrics)> {
test	Check formatting	2026-02-11T05:41:36.3505001Z +        let result = self
test	Check formatting	2026-02-11T05:41:36.3505117Z +            .pipeline
test	Check formatting	2026-02-11T05:41:36.3505318Z +            .generate_with_metrics(prompt, max_tokens)
test	Check formatting	2026-02-11T05:41:36.3505590Z              .map_err(|e| anyhow::anyhow!("Generation failed: {}", e))?;
test	Check formatting	2026-02-11T05:41:36.3505694Z  
test	Check formatting	2026-02-11T05:41:36.3505929Z          let (throughput, _) = result.metrics.throughput();
test	Check formatting	2026-02-11T05:41:36.3506273Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:179:
test	Check formatting	2026-02-11T05:41:36.3506415Z          Ok((result.text, metrics))
test	Check formatting	2026-02-11T05:41:36.3506525Z      }
test	Check formatting	2026-02-11T05:41:36.3506625Z  
test	Check formatting	2026-02-11T05:41:36.3507272Z -    pub fn generate_stream<F>(&mut self, prompt: &str, max_tokens: usize, mut callback: F) -> Result<(String, InferenceMetrics)> 
test	Check formatting	2026-02-11T05:41:36.3507413Z -    where F: FnMut(&str) -> bool
test	Check formatting	2026-02-11T05:41:36.3507559Z +    pub fn generate_stream<F>(
test	Check formatting	2026-02-11T05:41:36.3507669Z +        &mut self,
test	Check formatting	2026-02-11T05:41:36.3507788Z +        prompt: &str,
test	Check formatting	2026-02-11T05:41:36.3507929Z +        max_tokens: usize,
test	Check formatting	2026-02-11T05:41:36.3508052Z +        mut callback: F,
test	Check formatting	2026-02-11T05:41:36.3508214Z +    ) -> Result<(String, InferenceMetrics)>
test	Check formatting	2026-02-11T05:41:36.3508323Z +    where
test	Check formatting	2026-02-11T05:41:36.3508463Z +        F: FnMut(&str) -> bool,
test	Check formatting	2026-02-11T05:41:36.3508566Z      {
test	Check formatting	2026-02-11T05:41:36.3508728Z          // Estimate prompt tokens if possible
test	Check formatting	2026-02-11T05:41:36.3508996Z          let _prompt_tokens = self.pipeline.count_tokens(prompt);
test	Check formatting	2026-02-11T05:41:36.3509334Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:187:
test	Check formatting	2026-02-11T05:41:36.3509443Z -        
test	Check formatting	2026-02-11T05:41:36.3509773Z -        let result = self.pipeline.generate_stream(prompt, max_tokens, |token| {
test	Check formatting	2026-02-11T05:41:36.3509909Z -            callback(token)
test	Check formatting	2026-02-11T05:41:36.3510012Z -        })?;
test	Check formatting	2026-02-11T05:41:36.3510113Z  
test	Check formatting	2026-02-11T05:41:36.3510246Z +        let result = self
test	Check formatting	2026-02-11T05:41:36.3510358Z +            .pipeline
test	Check formatting	2026-02-11T05:41:36.3510630Z +            .generate_stream(prompt, max_tokens, |token| callback(token))?;
test	Check formatting	2026-02-11T05:41:36.3510925Z +
test	Check formatting	2026-02-11T05:41:36.3511148Z          let (throughput, _) = result.metrics.throughput();
test	Check formatting	2026-02-11T05:41:36.3511298Z          let (ttft, _) = result.metrics.ttft();
test	Check formatting	2026-02-11T05:41:36.3511524Z          let (duration, _) = result.metrics.generate_duration();
test	Check formatting	2026-02-11T05:41:36.3511860Z Diff in /home/runner/work/capi/capi/capi-core/src/inference/session.rs:197:
test	Check formatting	2026-02-11T05:41:36.3512083Z          let num_output = result.metrics.num_generated_tokens();
test	Check formatting	2026-02-11T05:41:36.3512179Z  
test	Check formatting	2026-02-11T05:41:36.3512330Z          // Update session context size
test	Check formatting	2026-02-11T05:41:36.3512545Z -        // Note: OpenVINO GenAI in chat mode handles history, 
test	Check formatting	2026-02-11T05:41:36.3512751Z +        // Note: OpenVINO GenAI in chat mode handles history,
test	Check formatting	2026-02-11T05:41:36.3513121Z          // but we want to know the total "active" context.
test	Check formatting	2026-02-11T05:41:36.3513322Z          self.context_tokens = num_input + num_output;
test	Check formatting	2026-02-11T05:41:36.3513441Z  
test	Check formatting	2026-02-11T05:41:36.3513677Z Diff in /home/runner/work/capi/capi/capi-core/src/lib.rs:1:
test	Check formatting	2026-02-11T05:41:36.3513805Z  pub mod api;
test	Check formatting	2026-02-11T05:41:36.3513924Z -pub mod inference;
test	Check formatting	2026-02-11T05:41:36.3514048Z -pub mod model_manager;
test	Check formatting	2026-02-11T05:41:36.3514162Z -pub mod hardware;
test	Check formatting	2026-02-11T05:41:36.3514282Z  pub mod config;
test	Check formatting	2026-02-11T05:41:36.3514389Z  pub mod db;
test	Check formatting	2026-02-11T05:41:36.3514757Z  pub mod genai_bridge;
test	Check formatting	2026-02-11T05:41:36.3515000Z Diff in /home/runner/work/capi/capi/capi-core/src/lib.rs:8:
test	Check formatting	2026-02-11T05:41:36.3515118Z +pub mod hardware;
test	Check formatting	2026-02-11T05:41:36.3515234Z +pub mod inference;
test	Check formatting	2026-02-11T05:41:36.3515351Z +pub mod model_manager;
test	Check formatting	2026-02-11T05:41:36.3515465Z  
test	Check formatting	2026-02-11T05:41:36.3515639Z  pub use api::{create_router, AppState};
test	Check formatting	2026-02-11T05:41:36.3515788Z  pub use config::Config;
test	Check formatting	2026-02-11T05:41:36.3516036Z Diff in /home/runner/work/capi/capi/capi-core/src/lib.rs:11:
test	Check formatting	2026-02-11T05:41:36.3516156Z  pub use db::Database;
test	Check formatting	2026-02-11T05:41:36.3516397Z -pub use inference::{InferenceSession, InferenceMetrics};
test	Check formatting	2026-02-11T05:41:36.3516863Z -pub use model_manager::{Registry, Downloader, ModelInfo, HuggingFaceModel, ModelData, FileInfo};
test	Check formatting	2026-02-11T05:41:36.3517992Z -pub use hardware::{detect_devices, select_best_device, detect_system_resources, validate_model_load, DeviceInfo, DeviceType, SystemResources, GpuResource, ResourceMode, ValidationResult};
test	Check formatting	2026-02-11T05:41:36.3518134Z +pub use hardware::{
test	Check formatting	2026-02-11T05:41:36.3518583Z +    detect_devices, detect_system_resources, select_best_device, validate_model_load, DeviceInfo,
test	Check formatting	2026-02-11T05:41:36.3518950Z +    DeviceType, GpuResource, ResourceMode, SystemResources, ValidationResult,
test	Check formatting	2026-02-11T05:41:36.3519053Z +};
test	Check formatting	2026-02-11T05:41:36.3519294Z +pub use inference::{InferenceMetrics, InferenceSession};
test	Check formatting	2026-02-11T05:41:36.3519744Z +pub use model_manager::{Downloader, FileInfo, HuggingFaceModel, ModelData, ModelInfo, Registry};
test	Check formatting	2026-02-11T05:41:36.3519843Z  
test	Check formatting	2026-02-11T05:41:36.3543506Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:81:
test	Check formatting	2026-02-11T05:41:36.3543979Z          let response = self.client.get(&url).send().await?;
test	Check formatting	2026-02-11T05:41:36.3544226Z          let models: Vec<HfApiModel> = response.json().await?;
test	Check formatting	2026-02-11T05:41:36.3544447Z  
test	Check formatting	2026-02-11T05:41:36.3544607Z -        Ok(models.into_iter()
test	Check formatting	2026-02-11T05:41:36.3544722Z +        Ok(models
test	Check formatting	2026-02-11T05:41:36.3544852Z +            .into_iter()
test	Check formatting	2026-02-11T05:41:36.3545023Z              .filter(|m| is_supported_model(m))
test	Check formatting	2026-02-11T05:41:36.3545134Z              .map(|m| {
test	Check formatting	2026-02-11T05:41:36.3545444Z                  let id = m.model_id.or(m.id).unwrap_or_default();
test	Check formatting	2026-02-11T05:41:36.3545829Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:90:
test	Check formatting	2026-02-11T05:41:36.3545933Z  
test	Check formatting	2026-02-11T05:41:36.3546176Z                  HuggingFaceModel {
test	Check formatting	2026-02-11T05:41:36.3546316Z                      id: id_clone,
test	Check formatting	2026-02-11T05:41:36.3546775Z -                    author: m.author.or_else(|| parts.first().map(|s| s.to_string())).unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3547428Z -                    name: m.model_name.or_else(|| parts.get(1).map(|s| s.to_string())).unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3547724Z +                    author: m
test	Check formatting	2026-02-11T05:41:36.3547852Z +                        .author
test	Check formatting	2026-02-11T05:41:36.3548069Z +                        .or_else(|| parts.first().map(|s| s.to_string()))
test	Check formatting	2026-02-11T05:41:36.3548329Z +                        .unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3548449Z +                    name: m
test	Check formatting	2026-02-11T05:41:36.3548570Z +                        .model_name
test	Check formatting	2026-02-11T05:41:36.3548789Z +                        .or_else(|| parts.get(1).map(|s| s.to_string()))
test	Check formatting	2026-02-11T05:41:36.3549019Z +                        .unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3549203Z                      downloads: m.downloads.unwrap_or(0),
test	Check formatting	2026-02-11T05:41:36.3549364Z                      likes: m.likes.unwrap_or(0),
test	Check formatting	2026-02-11T05:41:36.3549529Z                      tags: m.tags.unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3549891Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:98:
test	Check formatting	2026-02-11T05:41:36.3550166Z -                    description: m.card_data.as_ref()
test	Check formatting	2026-02-11T05:41:36.3550301Z +                    description: m
test	Check formatting	2026-02-11T05:41:36.3550418Z +                        .card_data
test	Check formatting	2026-02-11T05:41:36.3550540Z +                        .as_ref()
test	Check formatting	2026-02-11T05:41:36.3551049Z                          .and_then(|c| c.get("description"))
test	Check formatting	2026-02-11T05:41:36.3551206Z                          .and_then(|d| d.as_str())
test	Check formatting	2026-02-11T05:41:36.3551363Z                          .map(String::from),
test	Check formatting	2026-02-11T05:41:36.3551749Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:108:
test	Check formatting	2026-02-11T05:41:36.3551992Z              .collect())
test	Check formatting	2026-02-11T05:41:36.3552117Z      }
test	Check formatting	2026-02-11T05:41:36.3552210Z  
test	Check formatting	2026-02-11T05:41:36.3552718Z -    pub async fn find_quantized_versions(&self, base_model_id: &str) -> Result<Vec<HuggingFaceModel>> {
test	Check formatting	2026-02-11T05:41:36.3553169Z +    pub async fn find_quantized_versions(
test	Check formatting	2026-02-11T05:41:36.3553305Z +        &self,
test	Check formatting	2026-02-11T05:41:36.3553426Z +        base_model_id: &str,
test	Check formatting	2026-02-11T05:41:36.3553678Z +    ) -> Result<Vec<HuggingFaceModel>> {
test	Check formatting	2026-02-11T05:41:36.3554035Z          let search_name = base_model_id.split('/').last().unwrap_or(base_model_id);
test	Check formatting	2026-02-11T05:41:36.3554162Z          let url = format!(
test	Check formatting	2026-02-11T05:41:36.3554715Z              "https://huggingface.co/api/models?search={}-gguf&filter=text-generation&sort=downloads&limit=100",
test	Check formatting	2026-02-11T05:41:36.3555103Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:120:
test	Check formatting	2026-02-11T05:41:36.3555209Z  
test	Check formatting	2026-02-11T05:41:36.3555493Z          let tag_to_find = format!("base_model:quantized:{}", base_model_id);
test	Check formatting	2026-02-11T05:41:36.3555604Z  
test	Check formatting	2026-02-11T05:41:36.3555749Z -        let results = models.into_iter()
test	Check formatting	2026-02-11T05:41:36.3555875Z +        let results = models
test	Check formatting	2026-02-11T05:41:36.3555999Z +            .into_iter()
test	Check formatting	2026-02-11T05:41:36.3556124Z              .filter(|m| {
test	Check formatting	2026-02-11T05:41:36.3556278Z                  if !is_supported_model(m) {
test	Check formatting	2026-02-11T05:41:36.3556399Z                      return false;
test	Check formatting	2026-02-11T05:41:36.3556781Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:127:
test	Check formatting	2026-02-11T05:41:36.3556890Z                  }
test	Check formatting	2026-02-11T05:41:36.3556989Z  
test	Check formatting	2026-02-11T05:41:36.3557283Z                  let tags = m.tags.as_ref().map(|t| t.as_slice()).unwrap_or(&[]);
test	Check formatting	2026-02-11T05:41:36.3557574Z -                tags.iter().any(|t| t == &tag_to_find || t.contains(&base_model_id))
test	Check formatting	2026-02-11T05:41:36.3557889Z +                tags.iter()
test	Check formatting	2026-02-11T05:41:36.3558134Z +                    .any(|t| t == &tag_to_find || t.contains(&base_model_id))
test	Check formatting	2026-02-11T05:41:36.3558350Z              })
test	Check formatting	2026-02-11T05:41:36.3558474Z              .map(|m| {
test	Check formatting	2026-02-11T05:41:36.3558748Z                  let id = m.model_id.clone().or(m.id.clone()).unwrap_or_default();
test	Check formatting	2026-02-11T05:41:36.3559211Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:136:
test	Check formatting	2026-02-11T05:41:36.3559670Z  
test	Check formatting	2026-02-11T05:41:36.3559831Z                  HuggingFaceModel {
test	Check formatting	2026-02-11T05:41:36.3559957Z                      id: id_clone,
test	Check formatting	2026-02-11T05:41:36.3560380Z -                    author: m.author.or_else(|| parts.first().map(|s| s.to_string())).unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3560914Z -                    name: m.model_name.or_else(|| parts.get(1).map(|s| s.to_string())).unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3561169Z +                    author: m
test	Check formatting	2026-02-11T05:41:36.3561296Z +                        .author
test	Check formatting	2026-02-11T05:41:36.3561522Z +                        .or_else(|| parts.first().map(|s| s.to_string()))
test	Check formatting	2026-02-11T05:41:36.3561758Z +                        .unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3561878Z +                    name: m
test	Check formatting	2026-02-11T05:41:36.3562004Z +                        .model_name
test	Check formatting	2026-02-11T05:41:36.3562214Z +                        .or_else(|| parts.get(1).map(|s| s.to_string()))
test	Check formatting	2026-02-11T05:41:36.3562451Z +                        .unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3562644Z                      downloads: m.downloads.unwrap_or(0),
test	Check formatting	2026-02-11T05:41:36.3562797Z                      likes: m.likes.unwrap_or(0),
test	Check formatting	2026-02-11T05:41:36.3590063Z                      tags: m.tags.unwrap_or_default(),
test	Check formatting	2026-02-11T05:41:36.3590697Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:144:
test	Check formatting	2026-02-11T05:41:36.3591172Z -                    description: m.card_data.as_ref()
test	Check formatting	2026-02-11T05:41:36.3603058Z +                    description: m
test	Check formatting	2026-02-11T05:41:36.3604865Z +                        .card_data
test	Check formatting	2026-02-11T05:41:36.3606653Z +                        .as_ref()
test	Check formatting	2026-02-11T05:41:36.3608511Z                          .and_then(|c| c.get("description"))
test	Check formatting	2026-02-11T05:41:36.3610223Z                          .and_then(|d| d.as_str())
test	Check formatting	2026-02-11T05:41:36.3611995Z                          .map(String::from),
test	Check formatting	2026-02-11T05:41:36.3614393Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:166:
test	Check formatting	2026-02-11T05:41:36.3616079Z  
test	Check formatting	2026-02-11T05:41:36.3617945Z          let info: serde_json::Value = response.json().await?;
test	Check formatting	2026-02-11T05:41:36.3619761Z  
test	Check formatting	2026-02-11T05:41:36.3621606Z -        let size_bytes = info.get("safetensors")
test	Check formatting	2026-02-11T05:41:36.3623514Z +        let size_bytes = info
test	Check formatting	2026-02-11T05:41:36.3625385Z +            .get("safetensors")
test	Check formatting	2026-02-11T05:41:36.3626769Z              .and_then(|s| s.get("total"))
test	Check formatting	2026-02-11T05:41:36.3626909Z              .and_then(|t| t.as_u64());
test	Check formatting	2026-02-11T05:41:36.3627087Z  
test	Check formatting	2026-02-11T05:41:36.3627486Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:173:
test	Check formatting	2026-02-11T05:41:36.3627723Z -        let num_parameters = info.get("safetensors")
test	Check formatting	2026-02-11T05:41:36.3628626Z +        let num_parameters = info
test	Check formatting	2026-02-11T05:41:36.3628797Z +            .get("safetensors")
test	Check formatting	2026-02-11T05:41:36.3629467Z              .and_then(|s| s.get("parameters"))
test	Check formatting	2026-02-11T05:41:36.3630276Z              .and_then(|p| p.as_str())
test	Check formatting	2026-02-11T05:41:36.3630465Z              .map(String::from);
test	Check formatting	2026-02-11T05:41:36.3631384Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:177:
test	Check formatting	2026-02-11T05:41:36.3631925Z  
test	Check formatting	2026-02-11T05:41:36.3632123Z -        let siblings = info.get("siblings")
test	Check formatting	2026-02-11T05:41:36.3632250Z +        let siblings = info
test	Check formatting	2026-02-11T05:41:36.3632371Z +            .get("siblings")
test	Check formatting	2026-02-11T05:41:36.3632518Z              .and_then(|s| s.as_array())
test	Check formatting	2026-02-11T05:41:36.3632601Z              .map(|arr| {
test	Check formatting	2026-02-11T05:41:36.3632673Z                  arr.iter()
test	Check formatting	2026-02-11T05:41:36.3633115Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:182:
test	Check formatting	2026-02-11T05:41:36.3633357Z -                    .filter_map(|f| f.get("rfilename").and_then(|n| n.as_str()).map(String::from))
test	Check formatting	2026-02-11T05:41:36.3633602Z +                    .filter_map(|f| {
test	Check formatting	2026-02-11T05:41:36.3633751Z +                        f.get("rfilename")
test	Check formatting	2026-02-11T05:41:36.3633912Z +                            .and_then(|n| n.as_str())
test	Check formatting	2026-02-11T05:41:36.3634284Z +                            .map(String::from)
test	Check formatting	2026-02-11T05:41:36.3634524Z +                    })
test	Check formatting	2026-02-11T05:41:36.3634654Z                      .collect()
test	Check formatting	2026-02-11T05:41:36.3635333Z              })
test	Check formatting	2026-02-11T05:41:36.3635489Z              .unwrap_or_default();
test	Check formatting	2026-02-11T05:41:36.3636452Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:191:
test	Check formatting	2026-02-11T05:41:36.3637021Z          })
test	Check formatting	2026-02-11T05:41:36.3637145Z      }
test	Check formatting	2026-02-11T05:41:36.3637836Z  
test	Check formatting	2026-02-11T05:41:36.3638329Z -    fn fetch_model_data_legacy(&self, _model_id: &str, info: serde_json::Value) -> Result<ModelData> {
test	Check formatting	2026-02-11T05:41:36.3638505Z -        let siblings: Vec<String> = info.get("siblings")
test	Check formatting	2026-02-11T05:41:36.3638595Z +    fn fetch_model_data_legacy(
test	Check formatting	2026-02-11T05:41:36.3638657Z +        &self,
test	Check formatting	2026-02-11T05:41:36.3638727Z +        _model_id: &str,
test	Check formatting	2026-02-11T05:41:36.3638807Z +        info: serde_json::Value,
test	Check formatting	2026-02-11T05:41:36.3638890Z +    ) -> Result<ModelData> {
test	Check formatting	2026-02-11T05:41:36.3638984Z +        let siblings: Vec<String> = info
test	Check formatting	2026-02-11T05:41:36.3639053Z +            .get("siblings")
test	Check formatting	2026-02-11T05:41:36.3639137Z              .and_then(|s| s.as_array())
test	Check formatting	2026-02-11T05:41:36.3639203Z              .map(|arr| {
test	Check formatting	2026-02-11T05:41:36.3639270Z                  arr.iter()
test	Check formatting	2026-02-11T05:41:36.3639744Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:199:
test	Check formatting	2026-02-11T05:41:36.3640474Z -                    .filter_map(|f| f.get("rfilename").and_then(|n| n.as_str()).map(String::from))
test	Check formatting	2026-02-11T05:41:36.3641093Z +                    .filter_map(|f| {
test	Check formatting	2026-02-11T05:41:36.3641856Z +                        f.get("rfilename")
test	Check formatting	2026-02-11T05:41:36.3642039Z +                            .and_then(|n| n.as_str())
test	Check formatting	2026-02-11T05:41:36.3642685Z +                            .map(String::from)
test	Check formatting	2026-02-11T05:41:36.3643598Z +                    })
test	Check formatting	2026-02-11T05:41:36.3643743Z                      .collect()
test	Check formatting	2026-02-11T05:41:36.3644446Z              })
test	Check formatting	2026-02-11T05:41:36.3644620Z              .unwrap_or_default();
test	Check formatting	2026-02-11T05:41:36.3645570Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:203:
test	Check formatting	2026-02-11T05:41:36.3646176Z  
test	Check formatting	2026-02-11T05:41:36.3646468Z -        let files_with_size: Vec<FileInfo> = info.get("siblings")
test	Check formatting	2026-02-11T05:41:36.3646640Z +        let files_with_size: Vec<FileInfo> = info
test	Check formatting	2026-02-11T05:41:36.3646773Z +            .get("siblings")
test	Check formatting	2026-02-11T05:41:36.3646856Z              .and_then(|s| s.as_array())
test	Check formatting	2026-02-11T05:41:36.3646933Z              .map(|arr| {
test	Check formatting	2026-02-11T05:41:36.3647000Z                  arr.iter()
test	Check formatting	2026-02-11T05:41:36.3647226Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:208:
test	Check formatting	2026-02-11T05:41:36.3647312Z                      .filter_map(|f| {
test	Check formatting	2026-02-11T05:41:36.3647674Z                          let name = f.get("rfilename").and_then(|n| n.as_str())?;
test	Check formatting	2026-02-11T05:41:36.3647822Z -                        let size = f.get("size")
test	Check formatting	2026-02-11T05:41:36.3648556Z -                            .and_then(|s| s.as_u64())
test	Check formatting	2026-02-11T05:41:36.3649578Z -                            .or_else(|| f.get("lfs").and_then(|lfs| lfs.get("size")).and_then(|s| s.as_u64()));
test	Check formatting	2026-02-11T05:41:36.3650241Z +                        let size = f.get("size").and_then(|s| s.as_u64()).or_else(|| {
test	Check formatting	2026-02-11T05:41:36.3650916Z +                            f.get("lfs")
test	Check formatting	2026-02-11T05:41:36.3651127Z +                                .and_then(|lfs| lfs.get("size"))
test	Check formatting	2026-02-11T05:41:36.3651766Z +                                .and_then(|s| s.as_u64())
test	Check formatting	2026-02-11T05:41:36.3652515Z +                        });
test	Check formatting	2026-02-11T05:41:36.3652640Z  
test	Check formatting	2026-02-11T05:41:36.3653568Z                          Some(FileInfo {
test	Check formatting	2026-02-11T05:41:36.3653759Z                              name: name.to_string(),
test	Check formatting	2026-02-11T05:41:36.3654616Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:225:
test	Check formatting	2026-02-11T05:41:36.3655542Z          let (size_bytes, architecture, context_length) = if let Some(gguf) = info.get("gguf") {
test	Check formatting	2026-02-11T05:41:36.3656038Z              (
test	Check formatting	2026-02-11T05:41:36.3656285Z                  gguf.get("total").and_then(|t| t.as_u64()),
test	Check formatting	2026-02-11T05:41:36.3656617Z -                gguf.get("architecture").and_then(|a| a.as_str()).map(String::from),
test	Check formatting	2026-02-11T05:41:36.3656736Z +                gguf.get("architecture")
test	Check formatting	2026-02-11T05:41:36.3656831Z +                    .and_then(|a| a.as_str())
test	Check formatting	2026-02-11T05:41:36.3656912Z +                    .map(String::from),
test	Check formatting	2026-02-11T05:41:36.3657047Z                  gguf.get("context_length").and_then(|c| c.as_u64()),
test	Check formatting	2026-02-11T05:41:36.3657115Z              )
test	Check formatting	2026-02-11T05:41:36.3657175Z          } else {
test	Check formatting	2026-02-11T05:41:36.3657651Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:261:
test	Check formatting	2026-02-11T05:41:36.3658377Z          let response_info = self.client.get(&url_info).send().await?;
test	Check formatting	2026-02-11T05:41:36.3659174Z          let info: serde_json::Value = response_info.json().await?;
test	Check formatting	2026-02-11T05:41:36.3659750Z  
test	Check formatting	2026-02-11T05:41:36.3659999Z -        let siblings: Vec<String> = info.get("siblings")
test	Check formatting	2026-02-11T05:41:36.3660139Z +        let siblings: Vec<String> = info
test	Check formatting	2026-02-11T05:41:36.3660260Z +            .get("siblings")
test	Check formatting	2026-02-11T05:41:36.3660394Z              .and_then(|s| s.as_array())
test	Check formatting	2026-02-11T05:41:36.3660468Z              .map(|arr| {
test	Check formatting	2026-02-11T05:41:36.3660536Z                  arr.iter()
test	Check formatting	2026-02-11T05:41:36.3660937Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:268:
test	Check formatting	2026-02-11T05:41:36.3661172Z -                    .filter_map(|f| f.get("rfilename").and_then(|n| n.as_str()).map(String::from))
test	Check formatting	2026-02-11T05:41:36.3661250Z +                    .filter_map(|f| {
test	Check formatting	2026-02-11T05:41:36.3661328Z +                        f.get("rfilename")
test	Check formatting	2026-02-11T05:41:36.3661424Z +                            .and_then(|n| n.as_str())
test	Check formatting	2026-02-11T05:41:36.3661509Z +                            .map(String::from)
test	Check formatting	2026-02-11T05:41:36.3661750Z +                    })
test	Check formatting	2026-02-11T05:41:36.3661921Z                      .collect()
test	Check formatting	2026-02-11T05:41:36.3662022Z              })
test	Check formatting	2026-02-11T05:41:36.3662150Z              .unwrap_or_default();
test	Check formatting	2026-02-11T05:41:36.3662443Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:272:
test	Check formatting	2026-02-11T05:41:36.3662656Z  
test	Check formatting	2026-02-11T05:41:36.3663056Z -        let files_with_size: Vec<FileInfo> = files.iter()
test	Check formatting	2026-02-11T05:41:36.3663247Z +        let files_with_size: Vec<FileInfo> = files
test	Check formatting	2026-02-11T05:41:36.3663356Z +            .iter()
test	Check formatting	2026-02-11T05:41:36.3663464Z              .filter_map(|f| {
test	Check formatting	2026-02-11T05:41:36.3663599Z                  let name = f.get("path").and_then(|n| n.as_str())?;
test	Check formatting	2026-02-11T05:41:36.3663731Z                  let size = f.get("size").and_then(|s| s.as_u64());
test	Check formatting	2026-02-11T05:41:36.3663949Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:287:
test	Check formatting	2026-02-11T05:41:36.3664184Z          let (size_bytes, architecture, context_length) = if let Some(gguf) = info.get("gguf") {
test	Check formatting	2026-02-11T05:41:36.3664418Z              (
test	Check formatting	2026-02-11T05:41:36.3664642Z                  gguf.get("total").and_then(|t| t.as_u64()),
test	Check formatting	2026-02-11T05:41:36.3664953Z -                gguf.get("architecture").and_then(|a| a.as_str()).map(String::from),
test	Check formatting	2026-02-11T05:41:36.3665076Z +                gguf.get("architecture")
test	Check formatting	2026-02-11T05:41:36.3665163Z +                    .and_then(|a| a.as_str())
test	Check formatting	2026-02-11T05:41:36.3665402Z +                    .map(String::from),
test	Check formatting	2026-02-11T05:41:36.3665638Z                  gguf.get("context_length").and_then(|c| c.as_u64()),
test	Check formatting	2026-02-11T05:41:36.3665738Z              )
test	Check formatting	2026-02-11T05:41:36.3665842Z          } else {
test	Check formatting	2026-02-11T05:41:36.3666285Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:314:
test	Check formatting	2026-02-11T05:41:36.3666919Z              println!("Model size: {:.1} GB\n", size as f64 / 1_000_000_000.0);
test	Check formatting	2026-02-11T05:41:36.3667580Z          }
test	Check formatting	2026-02-11T05:41:36.3667715Z  
test	Check formatting	2026-02-11T05:41:36.3668534Z -        let gguf_files: Vec<String> = info.files.iter()
test	Check formatting	2026-02-11T05:41:36.3669260Z +        let gguf_files: Vec<String> = info
test	Check formatting	2026-02-11T05:41:36.3670021Z +            .files
test	Check formatting	2026-02-11T05:41:36.3670160Z +            .iter()
test	Check formatting	2026-02-11T05:41:36.3670929Z              .filter(|f| f.ends_with(".gguf"))
test	Check formatting	2026-02-11T05:41:36.3671689Z              .cloned()
test	Check formatting	2026-02-11T05:41:36.3671830Z              .collect();
test	Check formatting	2026-02-11T05:41:36.3672798Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:338:
test	Check formatting	2026-02-11T05:41:36.3673410Z  
test	Check formatting	2026-02-11T05:41:36.3673703Z              println!("[{}/{}] {}...", idx + 1, gguf_files.len(), file_name);
test	Check formatting	2026-02-11T05:41:36.3673803Z  
test	Check formatting	2026-02-11T05:41:36.3674357Z -            match self.download_file_with_progress(&url, &destination.join(file_name), |current, total| {
test	Check formatting	2026-02-11T05:41:36.3674487Z -                if total > 0 {
test	Check formatting	2026-02-11T05:41:36.3674772Z -                    let pct = (current as f64 / total as f64 * 100.0) as u32;
test	Check formatting	2026-02-11T05:41:36.3675548Z -                    let mb_current = current as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.3676347Z -                    let mb_total = total as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.3677206Z -                    print!("\r  {:.1}/{:.1} MB ({}%)  ", mb_current, mb_total, pct);
test	Check formatting	2026-02-11T05:41:36.3677896Z -                    use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.3678739Z -                    std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.3679558Z -                }
test	Check formatting	2026-02-11T05:41:36.3679696Z -            }).await {
test	Check formatting	2026-02-11T05:41:36.3680428Z +            match self
test	Check formatting	2026-02-11T05:41:36.3680603Z +                .download_file_with_progress(
test	Check formatting	2026-02-11T05:41:36.3681283Z +                    &url,
test	Check formatting	2026-02-11T05:41:36.3681473Z +                    &destination.join(file_name),
test	Check formatting	2026-02-11T05:41:36.3682157Z +                    |current, total| {
test	Check formatting	2026-02-11T05:41:36.3682307Z +                        if total > 0 {
test	Check formatting	2026-02-11T05:41:36.3683334Z +                            let pct = (current as f64 / total as f64 * 100.0) as u32;
test	Check formatting	2026-02-11T05:41:36.3684135Z +                            let mb_current = current as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.3684938Z +                            let mb_total = total as f64 / 1_000_000.0;
test	Check formatting	2026-02-11T05:41:36.3685814Z +                            print!("\r  {:.1}/{:.1} MB ({}%)  ", mb_current, mb_total, pct);
test	Check formatting	2026-02-11T05:41:36.3686440Z +                            use std::io::Write;
test	Check formatting	2026-02-11T05:41:36.3686649Z +                            std::io::stdout().flush().ok();
test	Check formatting	2026-02-11T05:41:36.3687325Z +                        }
test	Check formatting	2026-02-11T05:41:36.3687458Z +                    },
test	Check formatting	2026-02-11T05:41:36.3688169Z +                )
test	Check formatting	2026-02-11T05:41:36.3688311Z +                .await
test	Check formatting	2026-02-11T05:41:36.3688410Z +            {
test	Check formatting	2026-02-11T05:41:36.3688871Z                  Ok(_) => println!("\r  âœ“ {} downloaded", file_name),
test	Check formatting	2026-02-11T05:41:36.3688956Z                  Err(e) => {
test	Check formatting	2026-02-11T05:41:36.3689338Z                      eprintln!("\r  âœ— Failed: {}", e);
test	Check formatting	2026-02-11T05:41:36.3689705Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/downloader.rs:399:
test	Check formatting	2026-02-11T05:41:36.3689787Z  
test	Check formatting	2026-02-11T05:41:36.3689896Z      let has_incompatible = tags.iter().any(|tag| {
test	Check formatting	2026-02-11T05:41:36.3689989Z          let tag_lower = tag.to_lowercase();
test	Check formatting	2026-02-11T05:41:36.3690075Z -        tag_lower.contains("gptq") ||
test	Check formatting	2026-02-11T05:41:36.3690165Z -        tag_lower.contains("awq") ||
test	Check formatting	2026-02-11T05:41:36.3690420Z -        tag_lower.contains("bnb") ||
test	Check formatting	2026-02-11T05:41:36.3690570Z -        tag_lower.contains("exl2")
test	Check formatting	2026-02-11T05:41:36.3690704Z +        tag_lower.contains("gptq")
test	Check formatting	2026-02-11T05:41:36.3690841Z +            || tag_lower.contains("awq")
test	Check formatting	2026-02-11T05:41:36.3690980Z +            || tag_lower.contains("bnb")
test	Check formatting	2026-02-11T05:41:36.3691232Z +            || tag_lower.contains("exl2")
test	Check formatting	2026-02-11T05:41:36.3691351Z      });
test	Check formatting	2026-02-11T05:41:36.3692070Z  
test	Check formatting	2026-02-11T05:41:36.3692235Z      !has_incompatible
test	Check formatting	2026-02-11T05:41:36.3693302Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/metadata.rs:1:
test	Check formatting	2026-02-11T05:41:36.3693819Z  // unused import removed
test	Check formatting	2026-02-11T05:41:36.3694005Z  use serde::{Deserialize, Serialize};
test	Check formatting	2026-02-11T05:41:36.3694704Z  
test	Check formatting	2026-02-11T05:41:36.3694829Z -
test	Check formatting	2026-02-11T05:41:36.3695023Z  #[derive(Debug, Clone, Serialize, Deserialize)]
test	Check formatting	2026-02-11T05:41:36.3695164Z  pub struct ModelMetadata {
test	Check formatting	2026-02-11T05:41:36.3695399Z      pub model_type: Option<String>,
test	Check formatting	2026-02-11T05:41:36.3695736Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/mod.rs:1:
test	Check formatting	2026-02-11T05:41:36.3695856Z -mod registry;
test	Check formatting	2026-02-11T05:41:36.3695970Z  mod downloader;
test	Check formatting	2026-02-11T05:41:36.3696181Z -mod metadata;
test	Check formatting	2026-02-11T05:41:36.3696307Z  mod memory_estimator;
test	Check formatting	2026-02-11T05:41:36.3697026Z +mod metadata;
test	Check formatting	2026-02-11T05:41:36.3697164Z  mod model_lock;
test	Check formatting	2026-02-11T05:41:36.3697887Z +mod registry;
test	Check formatting	2026-02-11T05:41:36.3698009Z  
test	Check formatting	2026-02-11T05:41:36.3698773Z -pub use registry::Registry;
test	Check formatting	2026-02-11T05:41:36.3699827Z -pub use downloader::{Downloader, ModelInfo, HuggingFaceModel, ModelData, FileInfo};
test	Check formatting	2026-02-11T05:41:36.3700556Z +pub use downloader::{Downloader, FileInfo, HuggingFaceModel, ModelData, ModelInfo};
test	Check formatting	2026-02-11T05:41:36.3701303Z +pub use memory_estimator::{estimate_memory_from_file_size, MemoryEstimate};
test	Check formatting	2026-02-11T05:41:36.3701965Z  pub use metadata::ModelMetadata;
test	Check formatting	2026-02-11T05:41:36.3703112Z -pub use memory_estimator::{MemoryEstimate, estimate_memory_from_file_size};
test	Check formatting	2026-02-11T05:41:36.3703744Z  pub use model_lock::ModelLock;
test	Check formatting	2026-02-11T05:41:36.3704659Z +pub use registry::Registry;
test	Check formatting	2026-02-11T05:41:36.3705532Z  
test	Check formatting	2026-02-11T05:41:36.3705921Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/model_lock.rs:12:
test	Check formatting	2026-02-11T05:41:36.3706355Z  
test	Check formatting	2026-02-11T05:41:36.3706513Z          if lock_path.exists() {
test	Check formatting	2026-02-11T05:41:36.3706862Z              let pid_str = fs::read_to_string(&lock_path).unwrap_or_default();
test	Check formatting	2026-02-11T05:41:36.3706980Z -            
test	Check formatting	2026-02-11T05:41:36.3707092Z +
test	Check formatting	2026-02-11T05:41:36.3713707Z              // Check if the process that holds the lock is still alive
test	Check formatting	2026-02-11T05:41:36.3714594Z              if let Ok(pid) = pid_str.trim().parse::<u32>() {
test	Check formatting	2026-02-11T05:41:36.3715672Z                  if Self::is_process_alive(pid) {
test	Check formatting	2026-02-11T05:41:36.3716468Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/model_lock.rs:23:
test	Check formatting	2026-02-11T05:41:36.3716564Z                      ));
test	Check formatting	2026-02-11T05:41:36.3716634Z                  } else {
test	Check formatting	2026-02-11T05:41:36.3716763Z                      // Process is dead, clean up stale lock
test	Check formatting	2026-02-11T05:41:36.3717036Z -                    println!("Cleaning up stale lock for model '{}' (PID {} no longer exists)", model_id, pid);
test	Check formatting	2026-02-11T05:41:36.3717115Z +                    println!(
test	Check formatting	2026-02-11T05:41:36.3717304Z +                        "Cleaning up stale lock for model '{}' (PID {} no longer exists)",
test	Check formatting	2026-02-11T05:41:36.3717384Z +                        model_id, pid
test	Check formatting	2026-02-11T05:41:36.3717453Z +                    );
test	Check formatting	2026-02-11T05:41:36.3717560Z                      fs::remove_file(&lock_path).ok();
test	Check formatting	2026-02-11T05:41:36.3717827Z                  }
test	Check formatting	2026-02-11T05:41:36.3718012Z              } else {
test	Check formatting	2026-02-11T05:41:36.3718371Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/model_lock.rs:56:
test	Check formatting	2026-02-11T05:41:36.3718535Z      /// Clean up all stale locks from dead processes
test	Check formatting	2026-02-11T05:41:36.3718650Z      pub fn cleanup_stale_locks() -> Result<()> {
test	Check formatting	2026-02-11T05:41:36.3718762Z          let temp_dir = std::env::temp_dir();
test	Check formatting	2026-02-11T05:41:36.3718828Z -        
test	Check formatting	2026-02-11T05:41:36.3718889Z +
test	Check formatting	2026-02-11T05:41:36.3719006Z          if let Ok(entries) = fs::read_dir(&temp_dir) {
test	Check formatting	2026-02-11T05:41:36.3719290Z              for entry in entries.flatten() {
test	Check formatting	2026-02-11T05:41:36.3719444Z                  let path = entry.path();
test	Check formatting	2026-02-11T05:41:36.3720416Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/model_lock.rs:74:
test	Check formatting	2026-02-11T05:41:36.3720958Z                  }
test	Check formatting	2026-02-11T05:41:36.3721095Z              }
test	Check formatting	2026-02-11T05:41:36.3721205Z          }
test	Check formatting	2026-02-11T05:41:36.3721304Z -        
test	Check formatting	2026-02-11T05:41:36.3721408Z +
test	Check formatting	2026-02-11T05:41:36.3721705Z          Ok(())
test	Check formatting	2026-02-11T05:41:36.3721772Z      }
test	Check formatting	2026-02-11T05:41:36.3721830Z  
test	Check formatting	2026-02-11T05:41:36.3722048Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/registry.rs:1:
test	Check formatting	2026-02-11T05:41:36.3722374Z -use crate::db::{Database, ModelRecord, models};
test	Check formatting	2026-02-11T05:41:36.3722570Z +use crate::db::{models, Database, ModelRecord};
test	Check formatting	2026-02-11T05:41:36.3723428Z  use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3723589Z  use std::path::PathBuf;
test	Check formatting	2026-02-11T05:41:36.3723724Z  use std::sync::{Arc, RwLock};
test	Check formatting	2026-02-11T05:41:36.3724083Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/registry.rs:25:
test	Check formatting	2026-02-11T05:41:36.3724231Z      }
test	Check formatting	2026-02-11T05:41:36.3724337Z  
test	Check formatting	2026-02-11T05:41:36.3725178Z      pub fn add_model(&self, model: ModelRecord) -> Result<()> {
test	Check formatting	2026-02-11T05:41:36.3725964Z -        self.db.with_connection(|conn| models::insert_model(conn, &model))
test	Check formatting	2026-02-11T05:41:36.3726587Z +        self.db
test	Check formatting	2026-02-11T05:41:36.3726875Z +            .with_connection(|conn| models::insert_model(conn, &model))
test	Check formatting	2026-02-11T05:41:36.3727517Z      }
test	Check formatting	2026-02-11T05:41:36.3727645Z  
test	Check formatting	2026-02-11T05:41:36.3727863Z      pub fn remove_model(&self, id: &str) -> Result<()> {
test	Check formatting	2026-02-11T05:41:36.3728176Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/registry.rs:32:
test	Check formatting	2026-02-11T05:41:36.3728362Z -        self.db.with_connection(|conn| models::delete_model(conn, id))
test	Check formatting	2026-02-11T05:41:36.3728773Z +        self.db
test	Check formatting	2026-02-11T05:41:36.3729142Z +            .with_connection(|conn| models::delete_model(conn, id))
test	Check formatting	2026-02-11T05:41:36.3729251Z      }
test	Check formatting	2026-02-11T05:41:36.3729351Z  
test	Check formatting	2026-02-11T05:41:36.3729672Z      pub fn set_active_model(&self, id: String) -> Result<()> {
test	Check formatting	2026-02-11T05:41:36.3730585Z Diff in /home/runner/work/capi/capi/capi-core/src/model_manager/registry.rs:41:
test	Check formatting	2026-02-11T05:41:36.3731214Z              .duration_since(std::time::UNIX_EPOCH)?
test	Check formatting	2026-02-11T05:41:36.3731922Z              .as_secs() as i64;
test	Check formatting	2026-02-11T05:41:36.3732055Z  
test	Check formatting	2026-02-11T05:41:36.3732425Z -        self.db.with_connection(|conn| models::update_last_used(conn, &id, timestamp))?;
test	Check formatting	2026-02-11T05:41:36.3732541Z +        self.db
test	Check formatting	2026-02-11T05:41:36.3732758Z +            .with_connection(|conn| models::update_last_used(conn, &id, timestamp))?;
test	Check formatting	2026-02-11T05:41:36.3733216Z  
test	Check formatting	2026-02-11T05:41:36.3733415Z -        let mut active = self.active_model.write()
test	Check formatting	2026-02-11T05:41:36.3733555Z +        let mut active = self
test	Check formatting	2026-02-11T05:41:36.3733682Z +            .active_model
test	Check formatting	2026-02-11T05:41:36.3733765Z +            .write()
test	Check formatting	2026-02-11T05:41:36.3733927Z              .map_err(|_| anyhow::anyhow!("Failed to acquire write lock"))?;
test	Check formatting	2026-02-11T05:41:36.3734008Z          *active = Some(id);
test	Check formatting	2026-02-11T05:41:36.3734221Z  
test	Check formatting	2026-02-11T05:41:36.3734526Z Diff in /home/runner/work/capi/capi/capi-server/src/main.rs:1:
test	Check formatting	2026-02-11T05:41:36.3734656Z  use anyhow::Result;
test	Check formatting	2026-02-11T05:41:36.3734772Z -use std::sync::Arc;
test	Check formatting	2026-02-11T05:41:36.3734889Z  use std::collections::HashMap;
test	Check formatting	2026-02-11T05:41:36.3734967Z +use std::sync::Arc;
test	Check formatting	2026-02-11T05:41:36.3735047Z  use tokio::sync::RwLock;
test	Check formatting	2026-02-11T05:41:36.3735123Z  use tracing_subscriber;
test	Check formatting	2026-02-11T05:41:36.3735330Z  
test	Check formatting	2026-02-11T05:41:36.5037134Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:1:
test	Check formatting	2026-02-11T05:41:36.5039925Z +use serde::Serialize;
test	Check formatting	2026-02-11T05:41:36.5040305Z  use std::path::PathBuf;
test	Check formatting	2026-02-11T05:41:36.5040668Z  use std::process::Stdio;
test	Check formatting	2026-02-11T05:41:36.5040924Z -use tauri_plugin_shell::ShellExt;
test	Check formatting	2026-02-11T05:41:36.5041213Z -use tauri_plugin_shell::process::CommandChild;
test	Check formatting	2026-02-11T05:41:36.5041496Z  use std::sync::{Arc, Mutex};
test	Check formatting	2026-02-11T05:41:36.5041715Z  use tauri::{Emitter, State};
test	Check formatting	2026-02-11T05:41:36.5041914Z -use serde::Serialize;
test	Check formatting	2026-02-11T05:41:36.5042136Z +use tauri_plugin_shell::process::CommandChild;
test	Check formatting	2026-02-11T05:41:36.5042400Z +use tauri_plugin_shell::ShellExt;
test	Check formatting	2026-02-11T05:41:36.5042612Z  
test	Check formatting	2026-02-11T05:41:36.5042755Z  struct AppData {
test	Check formatting	2026-02-11T05:41:36.5043213Z      #[allow(dead_code)]
test	Check formatting	2026-02-11T05:41:36.5043501Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:20:
test	Check formatting	2026-02-11T05:41:36.5044025Z  
test	Check formatting	2026-02-11T05:41:36.5044169Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5044538Z  async fn start_server(app: tauri::AppHandle, state: State<'_, ServerState>) -> Result<(), String> {
test	Check formatting	2026-02-11T05:41:36.5044978Z -    let (mut _rx, child) = app.shell()
test	Check formatting	2026-02-11T05:41:36.5045217Z +    let (mut _rx, child) = app
test	Check formatting	2026-02-11T05:41:36.5045432Z +        .shell()
test	Check formatting	2026-02-11T05:41:36.5045605Z          .sidecar("capi-server")
test	Check formatting	2026-02-11T05:41:36.5045824Z          .map_err(|e| e.to_string())?
test	Check formatting	2026-02-11T05:41:36.5046035Z          .spawn()
test	Check formatting	2026-02-11T05:41:36.5046300Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:27:
test	Check formatting	2026-02-11T05:41:36.5046633Z          .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5046854Z  
test	Check formatting	2026-02-11T05:41:36.5047034Z -    let mut process = state.process.lock()
test	Check formatting	2026-02-11T05:41:36.5047302Z -        .map_err(|_| "Failed to lock process")?;
test	Check formatting	2026-02-11T05:41:36.5047687Z +    let mut process = state.process.lock().map_err(|_| "Failed to lock process")?;
test	Check formatting	2026-02-11T05:41:36.5048077Z      *process = Some(child);
test	Check formatting	2026-02-11T05:41:36.5048283Z  
test	Check formatting	2026-02-11T05:41:36.5048421Z      Ok(())
test	Check formatting	2026-02-11T05:41:36.5048681Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:35:
test	Check formatting	2026-02-11T05:41:36.5048999Z  
test	Check formatting	2026-02-11T05:41:36.5049148Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5049429Z  async fn stop_server(state: State<'_, ServerState>) -> Result<(), String> {
test	Check formatting	2026-02-11T05:41:36.5049938Z -    let mut process = state.process.lock()
test	Check formatting	2026-02-11T05:41:36.5050219Z -        .map_err(|_| "Failed to lock process")?;
test	Check formatting	2026-02-11T05:41:36.5050596Z +    let mut process = state.process.lock().map_err(|_| "Failed to lock process")?;
test	Check formatting	2026-02-11T05:41:36.5050947Z  
test	Check formatting	2026-02-11T05:41:36.5051106Z      if let Some(child) = process.take() {
test	Check formatting	2026-02-11T05:41:36.5051372Z          child.kill().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5051709Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:55:
test	Check formatting	2026-02-11T05:41:36.5052026Z  
test	Check formatting	2026-02-11T05:41:36.5052164Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5052500Z  async fn get_server_status(state: State<'_, ServerState>) -> Result<ServerStatus, String> {
test	Check formatting	2026-02-11T05:41:36.5053040Z -    let process = state.process.lock()
test	Check formatting	2026-02-11T05:41:36.5053300Z -        .map_err(|_| "Failed to lock process")?;
test	Check formatting	2026-02-11T05:41:36.5053664Z +    let process = state.process.lock().map_err(|_| "Failed to lock process")?;
test	Check formatting	2026-02-11T05:41:36.5054005Z  
test	Check formatting	2026-02-11T05:41:36.5054165Z      let running = process.is_some();
test	Check formatting	2026-02-11T05:41:36.5054379Z  
test	Check formatting	2026-02-11T05:41:36.5054611Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:63:
test	Check formatting	2026-02-11T05:41:36.5054943Z -    let config = capi_core::Config::load()
test	Check formatting	2026-02-11T05:41:36.5055196Z -        .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5055505Z +    let config = capi_core::Config::load().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5055807Z  
test	Check formatting	2026-02-11T05:41:36.5055951Z      Ok(ServerStatus {
test	Check formatting	2026-02-11T05:41:36.5056143Z          running,
test	Check formatting	2026-02-11T05:41:36.5056398Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:79:
test	Check formatting	2026-02-11T05:41:36.5056705Z  
test	Check formatting	2026-02-11T05:41:36.5056839Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5057094Z  async fn get_hardware_status() -> Result<HardwareStatus, String> {
test	Check formatting	2026-02-11T05:41:36.5057438Z -    let devices = capi_core::detect_devices()
test	Check formatting	2026-02-11T05:41:36.5057703Z -        .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5058013Z +    let devices = capi_core::detect_devices().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5058333Z  
test	Check formatting	2026-02-11T05:41:36.5058496Z -    let config = capi_core::Config::load()
test	Check formatting	2026-02-11T05:41:36.5058746Z -        .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5059061Z +    let config = capi_core::Config::load().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5059363Z  
test	Check formatting	2026-02-11T05:41:36.5059656Z      let selected = capi_core::select_best_device(&devices, &config.device_preference);
test	Check formatting	2026-02-11T05:41:36.5060021Z  
test	Check formatting	2026-02-11T05:41:36.5060265Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:98:
test	Check formatting	2026-02-11T05:41:36.5060715Z      query: String,
test	Check formatting	2026-02-11T05:41:36.5060897Z      state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5061199Z  ) -> Result<Vec<capi_core::model_manager::HuggingFaceModel>, String> {
test	Check formatting	2026-02-11T05:41:36.5061516Z -    state.downloader
test	Check formatting	2026-02-11T05:41:36.5061691Z +    state
test	Check formatting	2026-02-11T05:41:36.5061841Z +        .downloader
test	Check formatting	2026-02-11T05:41:36.5062018Z          .search_models(&query)
test	Check formatting	2026-02-11T05:41:36.5062206Z          .await
test	Check formatting	2026-02-11T05:41:36.5062382Z          .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5062688Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:105:
test	Check formatting	2026-02-11T05:41:36.5063104Z  }
test	Check formatting	2026-02-11T05:41:36.5063236Z  
test	Check formatting	2026-02-11T05:41:36.5063409Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5063576Z -async fn list_models(
test	Check formatting	2026-02-11T05:41:36.5063777Z -    state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5064030Z -) -> Result<Vec<capi_core::db::ModelRecord>, String> {
test	Check formatting	2026-02-11T05:41:36.5064298Z -    state.registry
test	Check formatting	2026-02-11T05:41:36.5064475Z -        .list_models()
test	Check formatting	2026-02-11T05:41:36.5064656Z -        .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5065068Z +async fn list_models(state: State<'_, AppData>) -> Result<Vec<capi_core::db::ModelRecord>, String> {
test	Check formatting	2026-02-11T05:41:36.5065561Z +    state.registry.list_models().map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5065997Z  }
test	Check formatting	2026-02-11T05:41:36.5066129Z  
test	Check formatting	2026-02-11T05:41:36.5066273Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5066559Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:117:
test	Check formatting	2026-02-11T05:41:36.5066889Z -async fn download_model(
test	Check formatting	2026-02-11T05:41:36.5067093Z -    model_id: String,
test	Check formatting	2026-02-11T05:41:36.5067278Z -    state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5067497Z -) -> Result<(), String> {
test	Check formatting	2026-02-11T05:41:36.5067861Z +async fn download_model(model_id: String, state: State<'_, AppData>) -> Result<(), String> {
test	Check formatting	2026-02-11T05:41:36.5068366Z      let config = capi_core::Config::load().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5068795Z      let model_path = config.models_dir.join(&model_id.replace("/", "_"));
test	Check formatting	2026-02-11T05:41:36.5069121Z  
test	Check formatting	2026-02-11T05:41:36.5069368Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:124:
test	Check formatting	2026-02-11T05:41:36.5069687Z -    state.downloader
test	Check formatting	2026-02-11T05:41:36.5069870Z +    state
test	Check formatting	2026-02-11T05:41:36.5070017Z +        .downloader
test	Check formatting	2026-02-11T05:41:36.5070228Z          .download_model(&model_id, &model_path)
test	Check formatting	2026-02-11T05:41:36.5070467Z          .await
test	Check formatting	2026-02-11T05:41:36.5070639Z          .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5070945Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:128:
test	Check formatting	2026-02-11T05:41:36.5071258Z  }
test	Check formatting	2026-02-11T05:41:36.5071389Z  
test	Check formatting	2026-02-11T05:41:36.5071533Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5071706Z -async fn remove_model(
test	Check formatting	2026-02-11T05:41:36.5071890Z -    model_id: String,
test	Check formatting	2026-02-11T05:41:36.5072075Z -    state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5072277Z -) -> Result<(), String> {
test	Check formatting	2026-02-11T05:41:36.5072469Z -    state.registry
test	Check formatting	2026-02-11T05:41:36.5072798Z +async fn remove_model(model_id: String, state: State<'_, AppData>) -> Result<(), String> {
test	Check formatting	2026-02-11T05:41:36.5073290Z +    state
test	Check formatting	2026-02-11T05:41:36.5073433Z +        .registry
test	Check formatting	2026-02-11T05:41:36.5073606Z          .remove_model(&model_id)
test	Check formatting	2026-02-11T05:41:36.5073817Z          .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5074021Z  }
test	Check formatting	2026-02-11T05:41:36.5074260Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:142:
test	Check formatting	2026-02-11T05:41:36.5074578Z      base_model_id: String,
test	Check formatting	2026-02-11T05:41:36.5074779Z      state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5075034Z  ) -> Result<Vec<capi_core::HuggingFaceModel>, String> {
test	Check formatting	2026-02-11T05:41:36.5075314Z -    state.downloader
test	Check formatting	2026-02-11T05:41:36.5075486Z +    state
test	Check formatting	2026-02-11T05:41:36.5075636Z +        .downloader
test	Check formatting	2026-02-11T05:41:36.5075834Z          .find_quantized_versions(&base_model_id)
test	Check formatting	2026-02-11T05:41:36.5076078Z          .await
test	Check formatting	2026-02-11T05:41:36.5076242Z          .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5076678Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:159:
test	Check formatting	2026-02-11T05:41:36.5076998Z      model_id: String,
test	Check formatting	2026-02-11T05:41:36.5077175Z      state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5077405Z  ) -> Result<Vec<FileInfoResponse>, String> {
test	Check formatting	2026-02-11T05:41:36.5077655Z -    let data = state.downloader
test	Check formatting	2026-02-11T05:41:36.5077863Z +    let data = state
test	Check formatting	2026-02-11T05:41:36.5078032Z +        .downloader
test	Check formatting	2026-02-11T05:41:36.5078214Z          .fetch_model_data(&model_id)
test	Check formatting	2026-02-11T05:41:36.5078421Z          .await
test	Check formatting	2026-02-11T05:41:36.5078595Z          .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5078896Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:166:
test	Check formatting	2026-02-11T05:41:36.5079205Z  
test	Check formatting	2026-02-11T05:41:36.5079434Z -    Ok(data.files_with_size.into_iter().map(|f| FileInfoResponse {
test	Check formatting	2026-02-11T05:41:36.5079746Z -        name: f.name,
test	Check formatting	2026-02-11T05:41:36.5079924Z -        size: f.size,
test	Check formatting	2026-02-11T05:41:36.5080088Z -    }).collect())
test	Check formatting	2026-02-11T05:41:36.5080254Z +    Ok(data
test	Check formatting	2026-02-11T05:41:36.5080407Z +        .files_with_size
test	Check formatting	2026-02-11T05:41:36.5080593Z +        .into_iter()
test	Check formatting	2026-02-11T05:41:36.5080771Z +        .map(|f| FileInfoResponse {
test	Check formatting	2026-02-11T05:41:36.5080992Z +            name: f.name,
test	Check formatting	2026-02-11T05:41:36.5081172Z +            size: f.size,
test	Check formatting	2026-02-11T05:41:36.5081352Z +        })
test	Check formatting	2026-02-11T05:41:36.5081504Z +        .collect())
test	Check formatting	2026-02-11T05:41:36.5081793Z  }
test	Check formatting	2026-02-11T05:41:36.5081932Z  
test	Check formatting	2026-02-11T05:41:36.5082076Z  #[derive(Serialize, Clone)]
test	Check formatting	2026-02-11T05:41:36.5082374Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:190:
test	Check formatting	2026-02-11T05:41:36.5082682Z  
test	Check formatting	2026-02-11T05:41:36.5083006Z      std::fs::create_dir_all(&model_path).map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5083302Z  
test	Check formatting	2026-02-11T05:41:36.5083595Z -    let url = format!("https://huggingface.co/{}/resolve/main/{}", model_id, filename);
test	Check formatting	2026-02-11T05:41:36.5083972Z +    let url = format!(
test	Check formatting	2026-02-11T05:41:36.5084197Z +        "https://huggingface.co/{}/resolve/main/{}",
test	Check formatting	2026-02-11T05:41:36.5084473Z +        model_id, filename
test	Check formatting	2026-02-11T05:41:36.5084653Z +    );
test	Check formatting	2026-02-11T05:41:36.5084793Z  
test	Check formatting	2026-02-11T05:41:36.5084932Z -    state.downloader
test	Check formatting	2026-02-11T05:41:36.5085099Z +    state
test	Check formatting	2026-02-11T05:41:36.5085241Z +        .downloader
test	Check formatting	2026-02-11T05:41:36.5085571Z          .download_file_with_progress(&url, &model_path.join(&filename), move |current, total| {
test	Check formatting	2026-02-11T05:41:36.5085967Z              if total > 0 {
test	Check formatting	2026-02-11T05:41:36.5086214Z                  let percent = current as f64 / total as f64 * 100.0;
test	Check formatting	2026-02-11T05:41:36.5086580Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:199:
test	Check formatting	2026-02-11T05:41:36.5086961Z -                app.emit("download-progress", DownloadProgress {
test	Check formatting	2026-02-11T05:41:36.5087251Z -                    current,
test	Check formatting	2026-02-11T05:41:36.5087442Z -                    total,
test	Check formatting	2026-02-11T05:41:36.5087630Z -                    percent,
test	Check formatting	2026-02-11T05:41:36.5087819Z -                }).ok();
test	Check formatting	2026-02-11T05:41:36.5088004Z +                app.emit(
test	Check formatting	2026-02-11T05:41:36.5088206Z +                    "download-progress",
test	Check formatting	2026-02-11T05:41:36.5088447Z +                    DownloadProgress {
test	Check formatting	2026-02-11T05:41:36.5088664Z +                        current,
test	Check formatting	2026-02-11T05:41:36.5088866Z +                        total,
test	Check formatting	2026-02-11T05:41:36.5089059Z +                        percent,
test	Check formatting	2026-02-11T05:41:36.5089249Z +                    },
test	Check formatting	2026-02-11T05:41:36.5089430Z +                )
test	Check formatting	2026-02-11T05:41:36.5089585Z +                .ok();
test	Check formatting	2026-02-11T05:41:36.5089754Z              }
test	Check formatting	2026-02-11T05:41:36.5089902Z          })
test	Check formatting	2026-02-11T05:41:36.5090049Z          .await
test	Check formatting	2026-02-11T05:41:36.5090298Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:229:
test	Check formatting	2026-02-11T05:41:36.5090629Z          context_override: None,
test	Check formatting	2026-02-11T05:41:36.5090824Z      };
test	Check formatting	2026-02-11T05:41:36.5090966Z  
test	Check formatting	2026-02-11T05:41:36.5091209Z -    state.registry.add_model(model_record).map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5091536Z +    state
test	Check formatting	2026-02-11T05:41:36.5091685Z +        .registry
test	Check formatting	2026-02-11T05:41:36.5091978Z +        .add_model(model_record)
test	Check formatting	2026-02-11T05:41:36.5092198Z +        .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5092405Z  
test	Check formatting	2026-02-11T05:41:36.5092543Z      Ok(())
test	Check formatting	2026-02-11T05:41:36.5092681Z  }
test	Check formatting	2026-02-11T05:41:36.5093014Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:264:
test	Check formatting	2026-02-11T05:41:36.5093320Z  }
test	Check formatting	2026-02-11T05:41:36.5093462Z  
test	Check formatting	2026-02-11T05:41:36.5093599Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5093777Z -async fn load_model_direct(
test	Check formatting	2026-02-11T05:41:36.5093979Z -    model_id: String,
test	Check formatting	2026-02-11T05:41:36.5094168Z -    state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5094386Z -) -> Result<String, String> {
test	Check formatting	2026-02-11T05:41:36.5094775Z +async fn load_model_direct(model_id: String, state: State<'_, AppData>) -> Result<String, String> {
test	Check formatting	2026-02-11T05:41:36.5095221Z      // Unload all previous models first
test	Check formatting	2026-02-11T05:41:36.5095437Z      {
test	Check formatting	2026-02-11T05:41:36.5095623Z -        let mut sessions = state.sessions.lock()
test	Check formatting	2026-02-11T05:41:36.5095887Z +        let mut sessions = state
test	Check formatting	2026-02-11T05:41:36.5096089Z +            .sessions
test	Check formatting	2026-02-11T05:41:36.5096500Z +            .lock()
test	Check formatting	2026-02-11T05:41:36.5096916Z              .map_err(|_| "Failed to acquire sessions lock".to_string())?;
test	Check formatting	2026-02-11T05:41:36.5097416Z          sessions.clear();
test	Check formatting	2026-02-11T05:41:36.5097708Z      }
test	Check formatting	2026-02-11T05:41:36.5098099Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:277:
test	Check formatting	2026-02-11T05:41:36.5098770Z  
test	Check formatting	2026-02-11T05:41:36.5099058Z -    let model = state.registry.get_model(&model_id)
test	Check formatting	2026-02-11T05:41:36.5099482Z +    let model = state
test	Check formatting	2026-02-11T05:41:36.5099762Z +        .registry
test	Check formatting	2026-02-11T05:41:36.5100030Z +        .get_model(&model_id)
test	Check formatting	2026-02-11T05:41:36.5100366Z          .map_err(|e| e.to_string())?
test	Check formatting	2026-02-11T05:41:36.5100808Z          .ok_or_else(|| format!("Model not found: {}", model_id))?;
test	Check formatting	2026-02-11T05:41:36.5101246Z  
test	Check formatting	2026-02-11T05:41:36.5101623Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:285:
test	Check formatting	2026-02-11T05:41:36.5102150Z          .unwrap_or_else(|| "CPU".to_string());
test	Check formatting	2026-02-11T05:41:36.5102501Z  
test	Check formatting	2026-02-11T05:41:36.5102807Z      let model_path = std::path::Path::new(&model.path);
test	Check formatting	2026-02-11T05:41:36.5103602Z -    println!("Loading model {} from {:?} on device {}", model_id, model_path, device);
test	Check formatting	2026-02-11T05:41:36.5104172Z +    println!(
test	Check formatting	2026-02-11T05:41:36.5104475Z +        "Loading model {} from {:?} on device {}",
test	Check formatting	2026-02-11T05:41:36.5104892Z +        model_id, model_path, device
test	Check formatting	2026-02-11T05:41:36.5105251Z +    );
test	Check formatting	2026-02-11T05:41:36.5105485Z  
test	Check formatting	2026-02-11T05:41:36.5105991Z      let mut session = capi_core::InferenceSession::load_with_lock(model_path, &device, &model_id)
test	Check formatting	2026-02-11T05:41:36.5106643Z          .map_err(|e| {
test	Check formatting	2026-02-11T05:41:36.5107082Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:292:
test	Check formatting	2026-02-11T05:41:36.5107692Z -            println!("Error loading model into session: {}", e);
test	Check formatting	2026-02-11T05:41:36.5108142Z -            e.to_string()
test	Check formatting	2026-02-11T05:41:36.5108424Z -        })?;
test	Check formatting	2026-02-11T05:41:36.5108757Z +        println!("Error loading model into session: {}", e);
test	Check formatting	2026-02-11T05:41:36.5109217Z +        e.to_string()
test	Check formatting	2026-02-11T05:41:36.5109492Z +    })?;
test	Check formatting	2026-02-11T05:41:36.5109726Z  
test	Check formatting	2026-02-11T05:41:36.5109997Z      println!("Starting chat for session...");
test	Check formatting	2026-02-11T05:41:36.5110416Z      session.start_chat().map_err(|e| {
test	Check formatting	2026-02-11T05:41:36.5110948Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:300:
test	Check formatting	2026-02-11T05:41:36.5111449Z      })?;
test	Check formatting	2026-02-11T05:41:36.5111771Z      println!("Model {} successfully loaded", model_id);
test	Check formatting	2026-02-11T05:41:36.5112186Z  
test	Check formatting	2026-02-11T05:41:36.5112462Z -    let mut sessions = state.sessions.lock()
test	Check formatting	2026-02-11T05:41:36.5113015Z +    let mut sessions = state
test	Check formatting	2026-02-11T05:41:36.5113339Z +        .sessions
test	Check formatting	2026-02-11T05:41:36.5113587Z +        .lock()
test	Check formatting	2026-02-11T05:41:36.5113951Z          .map_err(|_| "Failed to acquire sessions lock".to_string())?;
test	Check formatting	2026-02-11T05:41:36.5114406Z  
test	Check formatting	2026-02-11T05:41:36.5114671Z      sessions.insert(model_id.clone(), session);
test	Check formatting	2026-02-11T05:41:36.5115412Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:322:
test	Check formatting	2026-02-11T05:41:36.5115900Z  }
test	Check formatting	2026-02-11T05:41:36.5116109Z  
test	Check formatting	2026-02-11T05:41:36.5116325Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5116924Z -async fn get_chat_sessions(state: State<'_, AppData>) -> Result<Vec<capi_core::db::ChatSession>, String> {
test	Check formatting	2026-02-11T05:41:36.5117652Z -    state.db.with_connection(|conn| {
test	Check formatting	2026-02-11T05:41:36.5118066Z -        capi_core::db::chats::list_sessions(conn)
test	Check formatting	2026-02-11T05:41:36.5118474Z -    }).map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5118809Z +async fn get_chat_sessions(
test	Check formatting	2026-02-11T05:41:36.5119160Z +    state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5119579Z +) -> Result<Vec<capi_core::db::ChatSession>, String> {
test	Check formatting	2026-02-11T05:41:36.5120005Z +    state
test	Check formatting	2026-02-11T05:41:36.5120240Z +        .db
test	Check formatting	2026-02-11T05:41:36.5120661Z +        .with_connection(|conn| capi_core::db::chats::list_sessions(conn))
test	Check formatting	2026-02-11T05:41:36.5121184Z +        .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5121536Z  }
test	Check formatting	2026-02-11T05:41:36.5121764Z  
test	Check formatting	2026-02-11T05:41:36.5121990Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5122430Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:332:
test	Check formatting	2026-02-11T05:41:36.5123518Z -async fn get_chat_messages(state: State<'_, AppData>, session_id: String) -> Result<Vec<capi_core::db::ChatMessage>, String> {
test	Check formatting	2026-02-11T05:41:36.5124568Z -    state.db.with_connection(|conn| {
test	Check formatting	2026-02-11T05:41:36.5125011Z -        capi_core::db::chats::get_messages(conn, &session_id)
test	Check formatting	2026-02-11T05:41:36.5125476Z -    }).map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5125815Z +async fn get_chat_messages(
test	Check formatting	2026-02-11T05:41:36.5126135Z +    state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5126457Z +    session_id: String,
test	Check formatting	2026-02-11T05:41:36.5126819Z +) -> Result<Vec<capi_core::db::ChatMessage>, String> {
test	Check formatting	2026-02-11T05:41:36.5127237Z +    state
test	Check formatting	2026-02-11T05:41:36.5127462Z +        .db
test	Check formatting	2026-02-11T05:41:36.5127912Z +        .with_connection(|conn| capi_core::db::chats::get_messages(conn, &session_id))
test	Check formatting	2026-02-11T05:41:36.5128525Z +        .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5128848Z  }
test	Check formatting	2026-02-11T05:41:36.5129061Z  
test	Check formatting	2026-02-11T05:41:36.5129285Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5129715Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:339:
test	Check formatting	2026-02-11T05:41:36.5130553Z  async fn delete_chat_session(state: State<'_, AppData>, session_id: String) -> Result<(), String> {
test	Check formatting	2026-02-11T05:41:36.5131293Z -    state.db.with_connection(|conn| {
test	Check formatting	2026-02-11T05:41:36.5131769Z -        capi_core::db::chats::delete_session(conn, &session_id)
test	Check formatting	2026-02-11T05:41:36.5132234Z -    }).map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5132555Z +    state
test	Check formatting	2026-02-11T05:41:36.5132791Z +        .db
test	Check formatting	2026-02-11T05:41:36.5133530Z +        .with_connection(|conn| capi_core::db::chats::delete_session(conn, &session_id))
test	Check formatting	2026-02-11T05:41:36.5134150Z +        .map_err(|e| e.to_string())
test	Check formatting	2026-02-11T05:41:36.5134489Z  }
test	Check formatting	2026-02-11T05:41:36.5134712Z  
test	Check formatting	2026-02-11T05:41:36.5134954Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5135457Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:346:
test	Check formatting	2026-02-11T05:41:36.5136491Z -async fn create_chat_session(state: State<'_, AppData>, model_id: String, title: Option<String>) -> Result<String, String> {
test	Check formatting	2026-02-11T05:41:36.5137299Z +async fn create_chat_session(
test	Check formatting	2026-02-11T05:41:36.5137651Z +    state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5138000Z +    model_id: String,
test	Check formatting	2026-02-11T05:41:36.5138312Z +    title: Option<String>,
test	Check formatting	2026-02-11T05:41:36.5138704Z +) -> Result<String, String> {
test	Check formatting	2026-02-11T05:41:36.5139058Z      let id = uuid::Uuid::new_v4().to_string();
test	Check formatting	2026-02-11T05:41:36.5139492Z      let now = std::time::SystemTime::now()
test	Check formatting	2026-02-11T05:41:36.5139931Z          .duration_since(std::time::UNIX_EPOCH)
test	Check formatting	2026-02-11T05:41:36.5140474Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:350:
test	Check formatting	2026-02-11T05:41:36.5140978Z          .unwrap()
test	Check formatting	2026-02-11T05:41:36.5141254Z          .as_secs() as i64;
test	Check formatting	2026-02-11T05:41:36.5141818Z -        
test	Check formatting	2026-02-11T05:41:36.5142066Z +
test	Check formatting	2026-02-11T05:41:36.5142348Z      let session = capi_core::db::ChatSession {
test	Check formatting	2026-02-11T05:41:36.5142745Z          id: id.clone(),
test	Check formatting	2026-02-11T05:41:36.5143362Z          title: Some(title.unwrap_or_else(|| "New Chat".to_string())),
test	Check formatting	2026-02-11T05:41:36.5143775Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:357:
test	Check formatting	2026-02-11T05:41:36.5144107Z          created_at: now,
test	Check formatting	2026-02-11T05:41:36.5144296Z          updated_at: now,
test	Check formatting	2026-02-11T05:41:36.5144480Z      };
test	Check formatting	2026-02-11T05:41:36.5144619Z -    
test	Check formatting	2026-02-11T05:41:36.5144790Z -    state.db.with_connection(|conn| {
test	Check formatting	2026-02-11T05:41:36.5145079Z -        capi_core::db::chats::create_session(conn, &session)
test	Check formatting	2026-02-11T05:41:36.5145376Z -    }).map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5145587Z -    
test	Check formatting	2026-02-11T05:41:36.5145723Z +
test	Check formatting	2026-02-11T05:41:36.5145864Z +    state
test	Check formatting	2026-02-11T05:41:36.5146009Z +        .db
test	Check formatting	2026-02-11T05:41:36.5146295Z +        .with_connection(|conn| capi_core::db::chats::create_session(conn, &session))
test	Check formatting	2026-02-11T05:41:36.5146674Z +        .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5146883Z +
test	Check formatting	2026-02-11T05:41:36.5147016Z      Ok(id)
test	Check formatting	2026-02-11T05:41:36.5147173Z  }
test	Check formatting	2026-02-11T05:41:36.5147307Z  
test	Check formatting	2026-02-11T05:41:36.5147544Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:373:
test	Check formatting	2026-02-11T05:41:36.5147876Z      session_id: Option<String>,
test	Check formatting	2026-02-11T05:41:36.5148269Z      state: State<'_, AppData>,
test	Check formatting	2026-02-11T05:41:36.5148490Z  ) -> Result<ChatMetrics, String> {
test	Check formatting	2026-02-11T05:41:36.5148748Z -    let mut sessions = state.sessions.lock()
test	Check formatting	2026-02-11T05:41:36.5149012Z +    let mut sessions = state
test	Check formatting	2026-02-11T05:41:36.5149204Z +        .sessions
test	Check formatting	2026-02-11T05:41:36.5149368Z +        .lock()
test	Check formatting	2026-02-11T05:41:36.5149602Z          .map_err(|_| "Failed to acquire sessions lock".to_string())?;
test	Check formatting	2026-02-11T05:41:36.5149892Z  
test	Check formatting	2026-02-11T05:41:36.5150061Z -    let session = sessions.get_mut(&model_id)
test	Check formatting	2026-02-11T05:41:36.5150313Z +    let session = sessions
test	Check formatting	2026-02-11T05:41:36.5150521Z +        .get_mut(&model_id)
test	Check formatting	2026-02-11T05:41:36.5150815Z          .ok_or_else(|| format!("Model {} not loaded. Load it first.", model_id))?;
test	Check formatting	2026-02-11T05:41:36.5151146Z  
test	Check formatting	2026-02-11T05:41:36.5151315Z      let start_time = std::time::Instant::now();
test	Check formatting	2026-02-11T05:41:36.5151657Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:383:
test	Check formatting	2026-02-11T05:41:36.5151992Z      let mut first_token_time = None;
test	Check formatting	2026-02-11T05:41:36.5152223Z      let mut tokens_count = 0;
test	Check formatting	2026-02-11T05:41:36.5152412Z -    
test	Check formatting	2026-02-11T05:41:36.5152550Z +
test	Check formatting	2026-02-11T05:41:36.5152698Z      // Initial context estimate
test	Check formatting	2026-02-11T05:41:36.5153368Z      let prompt_tokens = session.get_context_tokens(); // last session context or initial
test	Check formatting	2026-02-11T05:41:36.5153759Z  
test	Check formatting	2026-02-11T05:41:36.5153996Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:389:
test	Check formatting	2026-02-11T05:41:36.5154445Z -    let (response, metrics) = session.generate_stream(&prompt, 4096, |token| {
test	Check formatting	2026-02-11T05:41:36.5154801Z -        tokens_count += 1;
test	Check formatting	2026-02-11T05:41:36.5155032Z -        let now = std::time::Instant::now();
test	Check formatting	2026-02-11T05:41:36.5155261Z -        
test	Check formatting	2026-02-11T05:41:36.5155430Z -        if first_token_time.is_none() {
test	Check formatting	2026-02-11T05:41:36.5155669Z -            first_token_time = Some(now);
test	Check formatting	2026-02-11T05:41:36.5155894Z -        }
test	Check formatting	2026-02-11T05:41:36.5156060Z +    let (response, metrics) = session
test	Check formatting	2026-02-11T05:41:36.5156315Z +        .generate_stream(&prompt, 4096, |token| {
test	Check formatting	2026-02-11T05:41:36.5156572Z +            tokens_count += 1;
test	Check formatting	2026-02-11T05:41:36.5156794Z +            let now = std::time::Instant::now();
test	Check formatting	2026-02-11T05:41:36.5157028Z  
test	Check formatting	2026-02-11T05:41:36.5157270Z -        app.emit("chat-token", ChatToken { token: token.to_string() }).ok();
test	Check formatting	2026-02-11T05:41:36.5157597Z -        
test	Check formatting	2026-02-11T05:41:36.5157753Z -        // Rolling metrics update
test	Check formatting	2026-02-11T05:41:36.5157977Z -        if tokens_count % 2 == 0 {
test	Check formatting	2026-02-11T05:41:36.5158239Z -            let elapsed = start_time.elapsed().as_secs_f32();
test	Check formatting	2026-02-11T05:41:36.5158770Z -            let tps = if elapsed > 0.0 { tokens_count as f32 / elapsed } else { 0.0 };
test	Check formatting	2026-02-11T05:41:36.5159108Z -            
test	Check formatting	2026-02-11T05:41:36.5159297Z -            app.emit("chat-metrics", ChatMetrics {
test	Check formatting	2026-02-11T05:41:36.5159566Z -                tokens_per_second: tps,
test	Check formatting	2026-02-11T05:41:36.5160047Z -                time_to_first_token_ms: first_token_time.map(|t| t.duration_since(start_time).as_millis() as f32).unwrap_or(0.0),
test	Check formatting	2026-02-11T05:41:36.5160566Z -                num_output_tokens: tokens_count,
test	Check formatting	2026-02-11T05:41:36.5160867Z -                total_context_tokens: prompt_tokens + tokens_count,
test	Check formatting	2026-02-11T05:41:36.5161158Z -            }).ok();
test	Check formatting	2026-02-11T05:41:36.5161331Z -        }
test	Check formatting	2026-02-11T05:41:36.5161470Z -        
test	Check formatting	2026-02-11T05:41:36.5161616Z -        true
test	Check formatting	2026-02-11T05:41:36.5161780Z -    }).map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5162015Z +            if first_token_time.is_none() {
test	Check formatting	2026-02-11T05:41:36.5162262Z +                first_token_time = Some(now);
test	Check formatting	2026-02-11T05:41:36.5162498Z +            }
test	Check formatting	2026-02-11T05:41:36.5162643Z  
test	Check formatting	2026-02-11T05:41:36.5162792Z +            app.emit(
test	Check formatting	2026-02-11T05:41:36.5163246Z +                "chat-token",
test	Check formatting	2026-02-11T05:41:36.5163629Z +                ChatToken {
test	Check formatting	2026-02-11T05:41:36.5163955Z +                    token: token.to_string(),
test	Check formatting	2026-02-11T05:41:36.5164195Z +                },
test	Check formatting	2026-02-11T05:41:36.5164520Z +            )
test	Check formatting	2026-02-11T05:41:36.5164679Z +            .ok();
test	Check formatting	2026-02-11T05:41:36.5164854Z +
test	Check formatting	2026-02-11T05:41:36.5165005Z +            // Rolling metrics update
test	Check formatting	2026-02-11T05:41:36.5165237Z +            if tokens_count % 2 == 0 {
test	Check formatting	2026-02-11T05:41:36.5165509Z +                let elapsed = start_time.elapsed().as_secs_f32();
test	Check formatting	2026-02-11T05:41:36.5165804Z +                let tps = if elapsed > 0.0 {
test	Check formatting	2026-02-11T05:41:36.5166052Z +                    tokens_count as f32 / elapsed
test	Check formatting	2026-02-11T05:41:36.5166293Z +                } else {
test	Check formatting	2026-02-11T05:41:36.5166476Z +                    0.0
test	Check formatting	2026-02-11T05:41:36.5166647Z +                };
test	Check formatting	2026-02-11T05:41:36.5166807Z +
test	Check formatting	2026-02-11T05:41:36.5166945Z +                app.emit(
test	Check formatting	2026-02-11T05:41:36.5167142Z +                    "chat-metrics",
test	Check formatting	2026-02-11T05:41:36.5167355Z +                    ChatMetrics {
test	Check formatting	2026-02-11T05:41:36.5167580Z +                        tokens_per_second: tps,
test	Check formatting	2026-02-11T05:41:36.5167855Z +                        time_to_first_token_ms: first_token_time
test	Check formatting	2026-02-11T05:41:36.5168211Z +                            .map(|t| t.duration_since(start_time).as_millis() as f32)
test	Check formatting	2026-02-11T05:41:36.5168541Z +                            .unwrap_or(0.0),
test	Check formatting	2026-02-11T05:41:36.5168810Z +                        num_output_tokens: tokens_count,
test	Check formatting	2026-02-11T05:41:36.5169136Z +                        total_context_tokens: prompt_tokens + tokens_count,
test	Check formatting	2026-02-11T05:41:36.5169427Z +                    },
test	Check formatting	2026-02-11T05:41:36.5169602Z +                )
test	Check formatting	2026-02-11T05:41:36.5169760Z +                .ok();
test	Check formatting	2026-02-11T05:41:36.5169927Z +            }
test	Check formatting	2026-02-11T05:41:36.5170079Z +
test	Check formatting	2026-02-11T05:41:36.5170225Z +            true
test	Check formatting	2026-02-11T05:41:36.5170378Z +        })
test	Check formatting	2026-02-11T05:41:36.5170544Z +        .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5170755Z +
test	Check formatting	2026-02-11T05:41:36.5170932Z      // Persist messages if session_id is provided
test	Check formatting	2026-02-11T05:41:36.5171199Z      if let Some(sid) = session_id {
test	Check formatting	2026-02-11T05:41:36.5171446Z          let now = std::time::SystemTime::now()
test	Check formatting	2026-02-11T05:41:36.5171797Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:435:
test	Check formatting	2026-02-11T05:41:36.5172122Z              created_at: now + 1,
test	Check formatting	2026-02-11T05:41:36.5172324Z          };
test	Check formatting	2026-02-11T05:41:36.5172464Z  
test	Check formatting	2026-02-11T05:41:36.5172629Z -        state.db.with_connection(|conn| {
test	Check formatting	2026-02-11T05:41:36.5173225Z -            capi_core::db::chats::add_message(conn, &user_msg)?;
test	Check formatting	2026-02-11T05:41:36.5173645Z -            capi_core::db::chats::add_message(conn, &assistant_msg)?;
test	Check formatting	2026-02-11T05:41:36.5173944Z -            
test	Check formatting	2026-02-11T05:41:36.5174118Z -            // Update session timestamp
test	Check formatting	2026-02-11T05:41:36.5174733Z -            if let Some(mut session) = capi_core::db::chats::get_session(conn, &sid)? {
test	Check formatting	2026-02-11T05:41:36.5175175Z -                session.updated_at = now + 1;
test	Check formatting	2026-02-11T05:41:36.5175610Z -                capi_core::db::chats::update_session(conn, &session)?;
test	Check formatting	2026-02-11T05:41:36.5175959Z -            }
test	Check formatting	2026-02-11T05:41:36.5184655Z -            Ok(())
test	Check formatting	2026-02-11T05:41:36.5184956Z -        }).map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5185204Z +        state
test	Check formatting	2026-02-11T05:41:36.5185371Z +            .db
test	Check formatting	2026-02-11T05:41:36.5185548Z +            .with_connection(|conn| {
test	Check formatting	2026-02-11T05:41:36.5185862Z +                capi_core::db::chats::add_message(conn, &user_msg)?;
test	Check formatting	2026-02-11T05:41:36.5186246Z +                capi_core::db::chats::add_message(conn, &assistant_msg)?;
test	Check formatting	2026-02-11T05:41:36.5186539Z +
test	Check formatting	2026-02-11T05:41:36.5186706Z +                // Update session timestamp
test	Check formatting	2026-02-11T05:41:36.5187056Z +                if let Some(mut session) = capi_core::db::chats::get_session(conn, &sid)? {
test	Check formatting	2026-02-11T05:41:36.5188151Z +                    session.updated_at = now + 1;
test	Check formatting	2026-02-11T05:41:36.5188471Z +                    capi_core::db::chats::update_session(conn, &session)?;
test	Check formatting	2026-02-11T05:41:36.5188771Z +                }
test	Check formatting	2026-02-11T05:41:36.5188933Z +                Ok(())
test	Check formatting	2026-02-11T05:41:36.5189241Z +            })
test	Check formatting	2026-02-11T05:41:36.5189416Z +            .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5189914Z      }
test	Check formatting	2026-02-11T05:41:36.5190053Z  
test	Check formatting	2026-02-11T05:41:36.5190193Z      Ok(ChatMetrics {
test	Check formatting	2026-02-11T05:41:36.5190472Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:462:
test	Check formatting	2026-02-11T05:41:36.5190874Z      let url = format!("{}/v1/chat/completions", config.server_url());
test	Check formatting	2026-02-11T05:41:36.5191173Z  
test	Check formatting	2026-02-11T05:41:36.5191472Z      let client = reqwest::Client::builder()
test	Check formatting	2026-02-11T05:41:36.5191842Z -        .timeout(std::time::Duration::from_secs(300))  // 5 minutes for large models
test	Check formatting	2026-02-11T05:41:36.5192309Z +        .timeout(std::time::Duration::from_secs(300)) // 5 minutes for large models
test	Check formatting	2026-02-11T05:41:36.5192649Z          .build()
test	Check formatting	2026-02-11T05:41:36.5193068Z          .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5193462Z  
test	Check formatting	2026-02-11T05:41:36.5193711Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:474:
test	Check formatting	2026-02-11T05:41:36.5194076Z          "stream": false,
test	Check formatting	2026-02-11T05:41:36.5194264Z      });
test	Check formatting	2026-02-11T05:41:36.5194410Z  
test	Check formatting	2026-02-11T05:41:36.5194564Z -    match client.post(&url)
test	Check formatting	2026-02-11T05:41:36.5194768Z -        .json(&body)
test	Check formatting	2026-02-11T05:41:36.5194941Z -        .send()
test	Check formatting	2026-02-11T05:41:36.5195108Z -        .await
test	Check formatting	2026-02-11T05:41:36.5195258Z -    {
test	Check formatting	2026-02-11T05:41:36.5195461Z +    match client.post(&url).json(&body).send().await {
test	Check formatting	2026-02-11T05:41:36.5195554Z          Ok(_) => Ok("Model loaded".to_string()),
test	Check formatting	2026-02-11T05:41:36.5195688Z          Err(e) => Err(format!("Failed to preload model: {}", e)),
test	Check formatting	2026-02-11T05:41:36.5195747Z      }
test	Check formatting	2026-02-11T05:41:36.5195915Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:486:
test	Check formatting	2026-02-11T05:41:36.5195983Z  
test	Check formatting	2026-02-11T05:41:36.5196053Z  #[tauri::command]
test	Check formatting	2026-02-11T05:41:36.5196250Z  async fn get_system_resources() -> Result<SystemResourcesResponse, String> {
test	Check formatting	2026-02-11T05:41:36.5196376Z -    let resources = capi_core::detect_system_resources()
test	Check formatting	2026-02-11T05:41:36.5196458Z -        .map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5196668Z +    let resources = capi_core::detect_system_resources().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5196731Z  
test	Check formatting	2026-02-11T05:41:36.5196882Z      let config = capi_core::Config::load().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5197040Z      let devices = capi_core::detect_devices().map_err(|e| e.to_string())?;
test	Check formatting	2026-02-11T05:41:36.5197207Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:500:
test	Check formatting	2026-02-11T05:41:36.5197332Z          available_ram_bytes: resources.available_ram_bytes,
test	Check formatting	2026-02-11T05:41:36.5197414Z          cpu_usage_percent: cpu_usage,
test	Check formatting	2026-02-11T05:41:36.5197491Z          selected_device,
test	Check formatting	2026-02-11T05:41:36.5197853Z -        gpu_resources: resources.gpu_resources.iter().map(|gpu| GpuResourceResponse {
test	Check formatting	2026-02-11T05:41:36.5197933Z -            name: gpu.name.clone(),
test	Check formatting	2026-02-11T05:41:36.5198037Z -            total_vram_bytes: gpu.total_vram_bytes,
test	Check formatting	2026-02-11T05:41:36.5198155Z -            available_vram_bytes: gpu.available_vram_bytes,
test	Check formatting	2026-02-11T05:41:36.5198245Z -            usage_percent: gpu.usage_percent,
test	Check formatting	2026-02-11T05:41:36.5198336Z -            frequency_mhz: gpu.frequency_mhz,
test	Check formatting	2026-02-11T05:41:36.5198444Z -            max_frequency_mhz: gpu.max_frequency_mhz,
test	Check formatting	2026-02-11T05:41:36.5198508Z -        }).collect(),
test	Check formatting	2026-02-11T05:41:36.5198583Z +        gpu_resources: resources
test	Check formatting	2026-02-11T05:41:36.5198657Z +            .gpu_resources
test	Check formatting	2026-02-11T05:41:36.5198718Z +            .iter()
test	Check formatting	2026-02-11T05:41:36.5198809Z +            .map(|gpu| GpuResourceResponse {
test	Check formatting	2026-02-11T05:41:36.5198892Z +                name: gpu.name.clone(),
test	Check formatting	2026-02-11T05:41:36.5199000Z +                total_vram_bytes: gpu.total_vram_bytes,
test	Check formatting	2026-02-11T05:41:36.5199123Z +                available_vram_bytes: gpu.available_vram_bytes,
test	Check formatting	2026-02-11T05:41:36.5199215Z +                usage_percent: gpu.usage_percent,
test	Check formatting	2026-02-11T05:41:36.5199307Z +                frequency_mhz: gpu.frequency_mhz,
test	Check formatting	2026-02-11T05:41:36.5199412Z +                max_frequency_mhz: gpu.max_frequency_mhz,
test	Check formatting	2026-02-11T05:41:36.5199605Z +            })
test	Check formatting	2026-02-11T05:41:36.5199677Z +            .collect(),
test	Check formatting	2026-02-11T05:41:36.5199735Z      })
test	Check formatting	2026-02-11T05:41:36.5199792Z  }
test	Check formatting	2026-02-11T05:41:36.5199847Z  
test	Check formatting	2026-02-11T05:41:36.5200015Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:530:
test	Check formatting	2026-02-11T05:41:36.5200153Z                                  let idle1: f32 = parts1[4].parse().unwrap_or(0.0);
test	Check formatting	2026-02-11T05:41:36.5200277Z                                  let idle2: f32 = parts2[4].parse().unwrap_or(0.0);
test	Check formatting	2026-02-11T05:41:36.5200341Z  
test	Check formatting	2026-02-11T05:41:36.5200570Z -                                let total1: f32 = parts1[1..].iter().filter_map(|s| s.parse::<f32>().ok()).sum();
test	Check formatting	2026-02-11T05:41:36.5200793Z -                                let total2: f32 = parts2[1..].iter().filter_map(|s| s.parse::<f32>().ok()).sum();
test	Check formatting	2026-02-11T05:41:36.5200894Z +                                let total1: f32 = parts1[1..]
test	Check formatting	2026-02-11T05:41:36.5200978Z +                                    .iter()
test	Check formatting	2026-02-11T05:41:36.5201095Z +                                    .filter_map(|s| s.parse::<f32>().ok())
test	Check formatting	2026-02-11T05:41:36.5201171Z +                                    .sum();
test	Check formatting	2026-02-11T05:41:36.5201271Z +                                let total2: f32 = parts2[1..]
test	Check formatting	2026-02-11T05:41:36.5201338Z +                                    .iter()
test	Check formatting	2026-02-11T05:41:36.5201444Z +                                    .filter_map(|s| s.parse::<f32>().ok())
test	Check formatting	2026-02-11T05:41:36.5201521Z +                                    .sum();
test	Check formatting	2026-02-11T05:41:36.5201578Z  
test	Check formatting	2026-02-11T05:41:36.5201680Z                                  let total_diff = total2 - total1;
test	Check formatting	2026-02-11T05:41:36.5201780Z                                  let idle_diff = idle2 - idle1;
test	Check formatting	2026-02-11T05:41:36.5201955Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:538:
test	Check formatting	2026-02-11T05:41:36.5202011Z  
test	Check formatting	2026-02-11T05:41:36.5202100Z                                  if total_diff > 0.0 {
test	Check formatting	2026-02-11T05:41:36.5202321Z -                                    return ((total_diff - idle_diff) / total_diff * 100.0).min(100.0).max(0.0);
test	Check formatting	2026-02-11T05:41:36.5202478Z +                                    return ((total_diff - idle_diff) / total_diff * 100.0)
test	Check formatting	2026-02-11T05:41:36.5202561Z +                                        .min(100.0)
test	Check formatting	2026-02-11T05:41:36.5202648Z +                                        .max(0.0);
test	Check formatting	2026-02-11T05:41:36.5202715Z                                  }
test	Check formatting	2026-02-11T05:41:36.5202780Z                              }
test	Check formatting	2026-02-11T05:41:36.5203034Z                          }
test	Check formatting	2026-02-11T05:41:36.5203222Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:549:
test	Check formatting	2026-02-11T05:41:36.5203283Z      0.0
test	Check formatting	2026-02-11T05:41:36.5203472Z  }
test	Check formatting	2026-02-11T05:41:36.5203536Z  
test	Check formatting	2026-02-11T05:41:36.5203594Z -
test	Check formatting	2026-02-11T05:41:36.5203650Z -
test	Check formatting	2026-02-11T05:41:36.5203759Z  #[cfg_attr(mobile, tauri::mobile_entry_point)]
test	Check formatting	2026-02-11T05:41:36.5203832Z  pub fn run() {
test	Check formatting	2026-02-11T05:41:36.5204005Z      let config = capi_core::Config::load().expect("Failed to load config");
test	Check formatting	2026-02-11T05:41:36.5204167Z Diff in /home/runner/work/capi/capi/capi-ui/src-tauri/src/lib.rs:557:
test	Check formatting	2026-02-11T05:41:36.5204246Z      let db = Arc::new(
test	Check formatting	2026-02-11T05:41:36.5204371Z -        capi_core::Database::open(config.database_path())
test	Check formatting	2026-02-11T05:41:36.5204462Z -            .expect("Failed to open database")
test	Check formatting	2026-02-11T05:41:36.5204693Z +        capi_core::Database::open(config.database_path()).expect("Failed to open database"),
test	Check formatting	2026-02-11T05:41:36.5204752Z      );
test	Check formatting	2026-02-11T05:41:36.5204809Z  
test	Check formatting	2026-02-11T05:41:36.5204955Z      let registry = Arc::new(capi_core::Registry::new(db.clone()));
test	Check formatting	2026-02-11T05:41:36.5215220Z ##[error]Process completed with exit code 1.
